@page "/trends"
@page "/trends/{TrendId}"
@rendermode InteractiveServer
@inject ConfigService ConfigService
@inject HistoryService HistoryService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Trend Visualizer - DataForeman</PageTitle>

<div class="page-container">
    @if (string.IsNullOrEmpty(TrendId))
    {
        <div class="page-toolbar">
            <h2><i class="fa-solid fa-chart-line"></i> Trend Visualizer</h2>
            <div class="toolbar-actions">
                <SfButton CssClass="e-primary" IconCss="fa-solid fa-plus" @onclick="CreateNewTrend">New Trend</SfButton>
            </div>
        </div>
        
        @if (!ConfigService.Trends.Any())
        {
            <div class="empty-state">
                <i class="fa-solid fa-chart-line"></i>
                <span>No trends configured</span>
                <SfButton CssClass="e-primary e-small" @onclick="CreateNewTrend">Create your first trend</SfButton>
            </div>
        }
        else
        {
            <SfGrid DataSource="@TrendsList" AllowPaging="true">
                <GridPageSettings PageSize="10"></GridPageSettings>
                <GridColumns>
                    <GridColumn Field="@nameof(TrendDisplay.Name)" HeaderText="Name" Width="200"></GridColumn>
                    <GridColumn Field="@nameof(TrendDisplay.Description)" HeaderText="Description" Width="300"></GridColumn>
                    <GridColumn Field="@nameof(TrendDisplay.SeriesCount)" HeaderText="Series" Width="80"></GridColumn>
                    <GridColumn Field="@nameof(TrendDisplay.TimeRange)" HeaderText="Time Range" Width="150"></GridColumn>
                    <GridColumn HeaderText="Actions" Width="120">
                        <Template>
                            @{
                                var item = (context as TrendDisplay);
                                <div class="action-buttons">
                                    <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-eye" @onclick="() => ViewTrend(item!.Id)"></SfButton>
                                    <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-pen" @onclick="() => EditTrend(item!.Id)"></SfButton>
                                    <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-trash" @onclick="() => ConfirmDeleteTrend(item!.Id)"></SfButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        }
    }
    else
    {
        <div class="trend-viewer" @key="@TrendId">
            <div class="viewer-toolbar">
                <SfButton CssClass="e-flat" IconCss="fa-solid fa-arrow-left" @onclick="GoBack"></SfButton>
                <SfTextBox @bind-Value="CurrentTrend.Name" Placeholder="Trend Name" CssClass="trend-name-input"></SfTextBox>
                <div class="toolbar-spacer"></div>
                
                <SfDropDownList TValue="TrendTimeRangeType" TItem="TimeRangeOption" 
                                @bind-Value="CurrentTrend.TimeRange.Type"
                                DataSource="@TimeRangeOptions"
                                Placeholder="Time Range">
                    <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                </SfDropDownList>
                
                <SfButton CssClass="e-flat" IconCss="fa-solid fa-rotate" Content="Refresh" @onclick="RefreshData"></SfButton>
                <SfButton CssClass="e-primary" IconCss="fa-solid fa-floppy-disk" @onclick="SaveTrend">Save</SfButton>
            </div>
            
            <div class="viewer-content">
                <div class="chart-container">
                    @if (CurrentTrend.Series.Any())
                    {
                        <SfChart Title="@CurrentTrend.Name" Height="400px" Theme="@GetChartTheme()">
                            <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" 
                                               LabelFormat="HH:mm:ss" />
                            <ChartPrimaryYAxis Title="Value" />
                            <ChartSeriesCollection>
                                @foreach (var series in CurrentTrend.Series.Where(s => s.Visible))
                                {
                                    <ChartSeries DataSource="@GetSeriesData(series.Id)" 
                                                 XName="Timestamp" 
                                                 YName="Value"
                                                 Name="@series.Name"
                                                 Type="@GetChartSeriesType(series.Type)"
                                                 Fill="@series.Color">
                                    </ChartSeries>
                                }
                            </ChartSeriesCollection>
                            <ChartLegendSettings Visible="@CurrentTrend.DisplayOptions.ShowLegend"></ChartLegendSettings>
                            <ChartZoomSettings EnableSelectionZooming="@CurrentTrend.DisplayOptions.EnableZoom"
                                               EnablePan="@CurrentTrend.DisplayOptions.EnablePan">
                            </ChartZoomSettings>
                        </SfChart>
                    }
                    else
                    {
                        <div class="chart-placeholder">
                            <i class="fa-solid fa-chart-line"></i>
                            <p>No series configured</p>
                            <p class="chart-hint">Add series in the configuration panel to visualize data</p>
                        </div>
                    }
                </div>
                
                <div class="config-panel">
                    <div class="panel-header">CONFIGURATION</div>
                    <div class="panel-content">
                        <div class="form-group">
                            <label>Description</label>
                            <SfTextBox @bind-Value="CurrentTrend.Description" Placeholder="Trend description" Multiline="true"></SfTextBox>
                        </div>
                        
                        <div class="form-group">
                            <label>Series</label>
                            <SfButton CssClass="e-small e-success" IconCss="fa-solid fa-plus" Content="Add Series" @onclick="AddSeries"></SfButton>
                            
                            @if (CurrentTrend.Series.Any())
                            {
                                <div class="series-list">
                                    @foreach (var series in CurrentTrend.Series)
                                    {
                                        <div class="series-item">
                                            <div class="series-header">
                                                <input type="checkbox" checked="@series.Visible" @onchange="e => series.Visible = (bool)e.Value!" />
                                                <input type="color" value="@series.Color" @onchange="e => series.Color = e.Value?.ToString() ?? series.Color" />
                                                <SfTextBox @bind-Value="series.Name" Placeholder="Series name" CssClass="series-name"></SfTextBox>
                                                <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-trash" @onclick="() => RemoveSeries(series.Id)"></SfButton>
                                            </div>
                                            <div class="series-config">
                                                <SfTextBox @bind-Value="series.TagPath" Placeholder="Tag path" CssClass="tag-path"></SfTextBox>
                                                <SfDropDownList TValue="TrendSeriesType" TItem="SeriesTypeOption" 
                                                                @bind-Value="series.Type"
                                                                DataSource="@SeriesTypeOptions"
                                                                Placeholder="Type">
                                                    <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                                                </SfDropDownList>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label>Display Options</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" @bind="CurrentTrend.DisplayOptions.ShowLegend" /> Show Legend</label>
                                <label><input type="checkbox" @bind="CurrentTrend.DisplayOptions.ShowGrid" /> Show Grid</label>
                                <label><input type="checkbox" @bind="CurrentTrend.DisplayOptions.EnableZoom" /> Enable Zoom</label>
                                <label><input type="checkbox" @bind="CurrentTrend.DisplayOptions.EnablePan" /> Enable Pan</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Refresh Interval (seconds)</label>
                            <SfNumericTextBox @bind-Value="CurrentTrend.DisplayOptions.RefreshIntervalSeconds" Min="1" Max="3600"></SfNumericTextBox>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<SfDialog @ref="_deleteDialog" Width="400px" IsModal="true" ShowCloseIcon="true">
    <DialogTemplates>
        <Header>Confirm Delete</Header>
        <Content>
            <p>Are you sure you want to delete this trend?</p>
            <p><strong>@_deletingTrendName</strong></p>
        </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="Cancel" OnClick="CancelDelete" />
        <DialogButton Content="Delete" IsPrimary="true" CssClass="e-danger" OnClick="ConfirmDelete" />
    </DialogButtons>
</SfDialog>

@code {
    [Parameter]
    public string? TrendId { get; set; }

    private TrendConfig CurrentTrend { get; set; } = new();
    private List<TrendDisplay> TrendsList { get; set; } = new();
    private Dictionary<string, List<TrendDataPoint>> _seriesData = new();
    private SfDialog? _deleteDialog;
    private string? _deletingTrendId;
    private string? _deletingTrendName;
    private System.Threading.Timer? _refreshTimer;

    private List<TimeRangeOption> TimeRangeOptions { get; set; } = new()
    {
        new() { Value = TrendTimeRangeType.Last15Minutes, Label = "Last 15 Minutes" },
        new() { Value = TrendTimeRangeType.Last1Hour, Label = "Last 1 Hour" },
        new() { Value = TrendTimeRangeType.Last4Hours, Label = "Last 4 Hours" },
        new() { Value = TrendTimeRangeType.Last12Hours, Label = "Last 12 Hours" },
        new() { Value = TrendTimeRangeType.Last24Hours, Label = "Last 24 Hours" },
        new() { Value = TrendTimeRangeType.Last7Days, Label = "Last 7 Days" },
        new() { Value = TrendTimeRangeType.Last30Days, Label = "Last 30 Days" },
        new() { Value = TrendTimeRangeType.Custom, Label = "Custom" }
    };

    private List<SeriesTypeOption> SeriesTypeOptions { get; set; } = new()
    {
        new() { Value = TrendSeriesType.Line, Label = "Line" },
        new() { Value = TrendSeriesType.Area, Label = "Area" },
        new() { Value = TrendSeriesType.Column, Label = "Column" },
        new() { Value = TrendSeriesType.Scatter, Label = "Scatter" }
    };

    protected override void OnInitialized()
    {
        LoadTrends();
        if (!string.IsNullOrEmpty(TrendId))
        {
            LoadTrend(TrendId);
            StartAutoRefresh();
        }
    }

    private void LoadTrends()
    {
        TrendsList = ConfigService.Trends
            .Select(t => new TrendDisplay
            {
                Id = t.Id,
                Name = t.Name,
                Description = t.Description ?? "",
                SeriesCount = t.Series.Count,
                TimeRange = GetTimeRangeLabel(t.TimeRange.Type)
            })
            .ToList();
    }

    private void LoadTrend(string id)
    {
        var trend = ConfigService.GetTrend(id);
        if (trend != null)
        {
            CurrentTrend = trend;
            _ = RefreshData();
        }
        else
        {
            Navigation.NavigateTo("/trends");
        }
    }

    private void CreateNewTrend()
    {
        var newId = Guid.NewGuid().ToString();
        Navigation.NavigateTo($"/trends/{newId}");
        CurrentTrend = new TrendConfig
        {
            Id = newId,
            Name = "New Trend",
            Description = "Trend description"
        };
    }

    private void ViewTrend(string id)
    {
        Navigation.NavigateTo($"/trends/{id}");
    }

    private void EditTrend(string id)
    {
        Navigation.NavigateTo($"/trends/{id}");
    }

    private async Task SaveTrend()
    {
        CurrentTrend.UpdatedAt = DateTime.UtcNow;
        
        var existing = ConfigService.GetTrend(CurrentTrend.Id);
        if (existing != null)
        {
            await ConfigService.UpdateTrendAsync(CurrentTrend);
        }
        else
        {
            await ConfigService.AddTrendAsync(CurrentTrend);
        }
        
        LoadTrends();
        StateHasChanged();
    }

    private void GoBack()
    {
        StopAutoRefresh();
        Navigation.NavigateTo("/trends");
    }

    private void AddSeries()
    {
        CurrentTrend.Series.Add(new TrendSeries
        {
            Name = $"Series {CurrentTrend.Series.Count + 1}",
            Color = GetRandomColor()
        });
        StateHasChanged();
    }

    private void RemoveSeries(string seriesId)
    {
        CurrentTrend.Series.RemoveAll(s => s.Id == seriesId);
        _seriesData.Remove(seriesId);
        StateHasChanged();
    }

    private async Task RefreshData()
    {
        // For now, generate sample data. In production, this would fetch from HistoryService
        _seriesData.Clear();
        foreach (var series in CurrentTrend.Series)
        {
            _seriesData[series.Id] = GenerateSampleData(50);
        }
        StateHasChanged();
    }

    private List<TrendDataPoint> GetSeriesData(string seriesId)
    {
        return _seriesData.TryGetValue(seriesId, out var data) ? data : new List<TrendDataPoint>();
    }

    private List<TrendDataPoint> GenerateSampleData(int points)
    {
        var data = new List<TrendDataPoint>();
        var now = DateTime.UtcNow;
        var random = new Random();
        
        for (int i = 0; i < points; i++)
        {
            data.Add(new TrendDataPoint
            {
                Timestamp = now.AddMinutes(-points + i),
                Value = 20 + random.NextDouble() * 60
            });
        }
        
        return data;
    }

    private void StartAutoRefresh()
    {
        var interval = TimeSpan.FromSeconds(CurrentTrend.DisplayOptions.RefreshIntervalSeconds);
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshData();
            });
        }, null, interval, interval);
    }

    private void StopAutoRefresh()
    {
        _refreshTimer?.Dispose();
        _refreshTimer = null;
    }

    private void ConfirmDeleteTrend(string id)
    {
        var trend = ConfigService.GetTrend(id);
        if (trend != null)
        {
            _deletingTrendId = id;
            _deletingTrendName = trend.Name;
            _deleteDialog?.ShowAsync();
        }
    }

    private async Task ConfirmDelete()
    {
        if (_deletingTrendId != null)
        {
            await ConfigService.DeleteTrendAsync(_deletingTrendId);
            LoadTrends();
            await _deleteDialog!.HideAsync();
            _deletingTrendId = null;
            _deletingTrendName = null;
        }
    }

    private async Task CancelDelete()
    {
        await _deleteDialog!.HideAsync();
        _deletingTrendId = null;
        _deletingTrendName = null;
    }

    private string GetTimeRangeLabel(TrendTimeRangeType type) => type switch
    {
        TrendTimeRangeType.Last15Minutes => "Last 15 Minutes",
        TrendTimeRangeType.Last1Hour => "Last 1 Hour",
        TrendTimeRangeType.Last4Hours => "Last 4 Hours",
        TrendTimeRangeType.Last12Hours => "Last 12 Hours",
        TrendTimeRangeType.Last24Hours => "Last 24 Hours",
        TrendTimeRangeType.Last7Days => "Last 7 Days",
        TrendTimeRangeType.Last30Days => "Last 30 Days",
        TrendTimeRangeType.Custom => "Custom",
        _ => "Unknown"
    };

    private Syncfusion.Blazor.Charts.ChartSeriesType GetChartSeriesType(TrendSeriesType type) => type switch
    {
        TrendSeriesType.Line => Syncfusion.Blazor.Charts.ChartSeriesType.Line,
        TrendSeriesType.Area => Syncfusion.Blazor.Charts.ChartSeriesType.Area,
        TrendSeriesType.Column => Syncfusion.Blazor.Charts.ChartSeriesType.Column,
        TrendSeriesType.Scatter => Syncfusion.Blazor.Charts.ChartSeriesType.Scatter,
        _ => Syncfusion.Blazor.Charts.ChartSeriesType.Line
    };

    private Syncfusion.Blazor.Theme GetChartTheme()
    {
        return CurrentTrend.DisplayOptions.Theme == "dark" 
            ? Syncfusion.Blazor.Theme.MaterialDark 
            : Syncfusion.Blazor.Theme.Material;
    }

    private string GetRandomColor()
    {
        var colors = new[] { "#3b82f6", "#ef4444", "#22c55e", "#f59e0b", "#8b5cf6", "#ec4899", "#06b6d4", "#84cc16" };
        return colors[new Random().Next(colors.Length)];
    }

    public void Dispose()
    {
        StopAutoRefresh();
    }

    private class TrendDisplay
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int SeriesCount { get; set; }
        public string TimeRange { get; set; } = string.Empty;
    }

    private class TrendDataPoint
    {
        public DateTime Timestamp { get; set; }
        public double Value { get; set; }
    }

    private class TimeRangeOption
    {
        public TrendTimeRangeType Value { get; set; }
        public string Label { get; set; } = string.Empty;
    }

    private class SeriesTypeOption
    {
        public TrendSeriesType Value { get; set; }
        public string Label { get; set; } = string.Empty;
    }
}
