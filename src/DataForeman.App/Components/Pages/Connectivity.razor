@page "/connectivity"
@rendermode InteractiveServer
@inject ConfigService ConfigService
@inject RealtimeDataService RealtimeData
@inject MqttService MqttService
@implements IDisposable

<PageTitle>Connectivity - DataForeman</PageTitle>

<div class="page-container">
    <div class="page-toolbar">
        <h2><i class="fa-solid fa-plug"></i> Connectivity</h2>
        <div class="toolbar-actions">
            <SfButton CssClass="e-primary" IconCss="fa-solid fa-plus" @onclick="ShowAddConnectionDialog">Add Connection</SfButton>
        </div>
    </div>

    <SfTab>
        <TabItems>
            <TabItem>
                <ChildContent>
                    <TabHeader Text="@ConnectionsTabText"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <div class="tab-panel">
                        @if (!ConnectionsList.Any())
                        {
                            <div class="empty-state">
                                <i class="fa-solid fa-plug"></i>
                                <span>No connections configured</span>
                            </div>
                        }
                        else
                        {
                            <SfGrid DataSource="@ConnectionsList" AllowPaging="true">
                                <GridPageSettings PageSize="10"></GridPageSettings>
                                <GridColumns>
                                    <GridColumn Field="@nameof(ConnectionDisplay.Name)" HeaderText="Name" Width="200"></GridColumn>
                                    <GridColumn Field="@nameof(ConnectionDisplay.Type)" HeaderText="Type" Width="120"></GridColumn>
                                    <GridColumn HeaderText="Status" Width="100">
                                        <Template>
                                            @{
                                                var item = (context as ConnectionDisplay);
                                                <span class="status-indicator @item?.StatusClass">
                                                    <i class="fa-solid fa-circle"></i> @item?.StatusText
                                                </span>
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field="@nameof(ConnectionDisplay.TagCount)" HeaderText="Tags" Width="80"></GridColumn>
                                    <GridColumn HeaderText="Actions" Width="120">
                                        <Template>
                                            @{
                                                var item = (context as ConnectionDisplay);
                                                <div class="action-buttons">
                                                    <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-pen" @onclick="() => EditConnectionById(item!.Id)"></SfButton>
                                                    <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-tags" @onclick="() => ViewTagsById(item!.Id)"></SfButton>
                                                    <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-trash" @onclick="() => ConfirmDeleteConnectionById(item!.Id)"></SfButton>
                                                </div>
                                            }
                                        </Template>
                                    </GridColumn>
                                </GridColumns>
                            </SfGrid>
                        }
                    </div>
                </ContentTemplate>
            </TabItem>
            <TabItem>
                <ChildContent>
                    <TabHeader Text="@TagsTabText"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <div class="tab-panel">
                        <div class="filter-bar">
                            <SfDropDownList TItem="ConnectionOption" TValue="string" 
                                            DataSource="@ConnectionOptions" 
                                            @bind-Value="SelectedConnectionId"
                                            Placeholder="All Connections">
                                <DropDownListFieldSettings Text="Name" Value="Id"></DropDownListFieldSettings>
                            </SfDropDownList>
                            <SfTextBox @bind-Value="TagSearchQuery" Placeholder="Search tags..." CssClass="search-box"></SfTextBox>
                            <SfButton CssClass="e-primary" IconCss="fa-solid fa-plus" @onclick="ShowAddTagDialog">Add Tag</SfButton>
                        </div>
                        
                        @if (!TagsList.Any())
                        {
                            <div class="empty-state">
                                <i class="fa-solid fa-tags"></i>
                                <span>No tags found</span>
                            </div>
                        }
                        else
                        {
                            <SfGrid DataSource="@TagsList" AllowPaging="true">
                                <GridPageSettings PageSize="15"></GridPageSettings>
                                <GridColumns>
                                    <GridColumn Field="@nameof(TagDisplay.Name)" HeaderText="Name" Width="180"></GridColumn>
                                    <GridColumn Field="@nameof(TagDisplay.ConnectionName)" HeaderText="Connection" Width="140"></GridColumn>
                                    <GridColumn Field="@nameof(TagDisplay.DataType)" HeaderText="Type" Width="80"></GridColumn>
                                    <GridColumn Field="@nameof(TagDisplay.PollRate)" HeaderText="Poll Rate" Width="90"></GridColumn>
                                    <GridColumn Field="@nameof(TagDisplay.Value)" HeaderText="Value" Width="100"></GridColumn>
                                    <GridColumn HeaderText="Quality" Width="70">
                                        <Template>
                                            @{
                                                var item = (context as TagDisplay);
                                                <span class="quality-indicator @(item?.IsGood == true ? "good" : "unknown")">
                                                    <i class="fa-solid @(item?.IsGood == true ? "fa-check" : "fa-question")"></i>
                                                </span>
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn HeaderText="Actions" Width="100">
                                        <Template>
                                            @{
                                                var item = (context as TagDisplay);
                                                <div class="action-buttons">
                                                    <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-pen" @onclick="() => EditTagById(item!.ConnectionId, item.Id)"></SfButton>
                                                    <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-trash" @onclick="() => ConfirmDeleteTagById(item!.ConnectionId, item.Id)"></SfButton>
                                                </div>
                                            }
                                        </Template>
                                    </GridColumn>
                                </GridColumns>
                            </SfGrid>
                        }
                    </div>
                </ContentTemplate>
            </TabItem>
        </TabItems>
    </SfTab>
</div>

<!-- Connection Dialog -->
<SfDialog @bind-Visible="ShowConnectionDialog" Width="400px" IsModal="true" ShowCloseIcon="true" AllowPrerender="false">
    <DialogTemplates>
        <Header>@(EditingConnection == null ? "Add Connection" : "Edit Connection")</Header>
        <Content>
            <div class="dialog-form">
                <div class="form-row">
                    <label>Name</label>
                    <SfTextBox @bind-Value="ConnectionForm.Name" Placeholder="Connection name"></SfTextBox>
                </div>
                <div class="form-row">
                    <label>Type</label>
                    <SfDropDownList TItem="string" TValue="string" DataSource="@ConnectionTypes" @bind-Value="ConnectionForm.Type"></SfDropDownList>
                </div>
                <div class="form-row">
                    <SfCheckBox @bind-Checked="ConnectionForm.Enabled" Label="Enabled"></SfCheckBox>
                </div>
            </div>
        </Content>
        <FooterTemplate>
            <SfButton @onclick="CloseDialogs">Cancel</SfButton>
            <SfButton CssClass="e-primary" @onclick="SaveConnection">Save</SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Tag Dialog -->
<SfDialog @bind-Visible="ShowTagDialog" Width="450px" IsModal="true" ShowCloseIcon="true" AllowPrerender="false">
    <DialogTemplates>
        <Header>@(EditingTag == null ? "Add Tag" : "Edit Tag")</Header>
        <Content>
            <div class="dialog-form">
                @if (EditingTag == null)
                {
                    <div class="form-row">
                        <label>Connection</label>
                        <SfDropDownList TItem="ConnectionOption" TValue="string" DataSource="@ConnectionOptionsNoAll" @bind-Value="TagConnectionId">
                            <DropDownListFieldSettings Text="Name" Value="Id"></DropDownListFieldSettings>
                        </SfDropDownList>
                    </div>
                }
                <div class="form-row">
                    <label>Name</label>
                    <SfTextBox @bind-Value="TagForm.Name" Placeholder="Tag name"></SfTextBox>
                </div>
                <div class="form-row">
                    <label>Address</label>
                    <SfTextBox @bind-Value="TagForm.Address" Placeholder="Tag address"></SfTextBox>
                </div>
                <div class="form-row">
                    <label>Data Type</label>
                    <SfDropDownList TItem="string" TValue="string" DataSource="@DataTypes" @bind-Value="TagForm.DataType"></SfDropDownList>
                </div>
                <div class="form-row">
                    <label>Poll Rate (ms)</label>
                    <SfNumericTextBox TValue="int" @bind-Value="TagForm.PollRateMs" Min="10" Max="60000"></SfNumericTextBox>
                </div>
                <div class="form-row">
                    <label>Unit</label>
                    <SfTextBox @bind-Value="TagForm.Unit" Placeholder="e.g. Â°C, bar"></SfTextBox>
                </div>
                <div class="form-row">
                    <SfCheckBox @bind-Checked="TagForm.Enabled" Label="Enabled"></SfCheckBox>
                </div>
            </div>
        </Content>
        <FooterTemplate>
            <SfButton @onclick="CloseDialogs">Cancel</SfButton>
            <SfButton CssClass="e-primary" @onclick="SaveTag">Save</SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- Delete Confirmation Dialog -->
<SfDialog @bind-Visible="ShowDeleteDialog" Width="350px" IsModal="true" ShowCloseIcon="true" AllowPrerender="false">
    <DialogTemplates>
        <Header>Confirm Delete</Header>
        <Content>
            <p>Delete "@DeleteItemName"?</p>
            <p class="text-muted">This action cannot be undone.</p>
        </Content>
        <FooterTemplate>
            <SfButton @onclick="CloseDialogs">Cancel</SfButton>
            <SfButton CssClass="e-danger" @onclick="ExecuteDelete">Delete</SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

@code {
    private string SelectedConnectionId = "";
    private string TagSearchQuery = "";
    
    private bool ShowConnectionDialog;
    private bool ShowTagDialog;
    private bool ShowDeleteDialog;
    
    private DataForeman.Shared.Models.ConnectionConfig? EditingConnection;
    private DataForeman.Shared.Models.TagConfig? EditingTag;
    private string? EditingTagConnectionId;
    
    private ConnectionFormModel ConnectionForm = new();
    private TagFormModel TagForm = new();
    private string TagConnectionId = "";
    
    private string DeleteItemName = "";
    private Func<Task>? DeleteAction;

    private List<string> ConnectionTypes = new() { "Simulator", "OpcUa", "S7", "Modbus" };
    private List<string> DataTypes = new() { "Boolean", "Int16", "Int32", "Float", "Double", "String" };
    
    private int TotalTags => ConfigService.Connections.Sum(c => c.Tags.Count);
    private string ConnectionsTabText => $"Connections ({ConfigService.Connections.Count})";
    private string TagsTabText => $"Tags ({TotalTags})";
    
    private List<ConnectionOption> ConnectionOptions => new List<ConnectionOption> { new("", "All Connections") }
        .Concat(ConfigService.Connections.Select(c => new ConnectionOption(c.Id, c.Name))).ToList();
    
    private List<ConnectionOption> ConnectionOptionsNoAll => ConfigService.Connections.Select(c => new ConnectionOption(c.Id, c.Name)).ToList();
    
    private List<ConnectionDisplay> ConnectionsList => ConfigService.Connections.Select(c => {
        var status = RealtimeData.GetConnectionStatus(c.Id);
        return new ConnectionDisplay {
            Id = c.Id,
            Name = c.Name,
            Type = c.Type,
            TagCount = c.Tags.Count,
            StatusText = GetStatusText(status, c.Enabled),
            StatusClass = GetStatusClass(status, c.Enabled)
        };
    }).ToList();
    
    private List<TagDisplay> TagsList {
        get {
            var query = ConfigService.GetAllTagsWithConnection().AsEnumerable();
            if (!string.IsNullOrEmpty(SelectedConnectionId))
                query = query.Where(x => x.Connection.Id == SelectedConnectionId);
            if (!string.IsNullOrEmpty(TagSearchQuery))
                query = query.Where(x => x.Tag.Name.Contains(TagSearchQuery, StringComparison.OrdinalIgnoreCase));
            return query.Select(x => {
                var tv = RealtimeData.GetTagValue(x.Tag.Id);
                return new TagDisplay {
                    Id = x.Tag.Id,
                    ConnectionId = x.Connection.Id,
                    ConnectionName = x.Connection.Name,
                    Name = x.Tag.Name,
                    DataType = x.Tag.DataType,
                    PollRate = $"{x.Tag.PollRateMs}ms",
                    Value = tv?.FormattedValue ?? "N/A",
                    IsGood = tv?.IsGoodQuality
                };
            }).ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await ConfigService.LoadAllAsync();
        RealtimeData.OnDataChanged += HandleDataChanged;
    }

    private void HandleDataChanged() => InvokeAsync(StateHasChanged);

    private string GetStatusClass(DataForeman.Shared.Mqtt.ConnectionStatusMessage? status, bool enabled)
    {
        if (!enabled) return "disabled";
        if (status == null) return "unknown";
        return status.State switch {
            DataForeman.Shared.Mqtt.ConnectionState.Connected => "connected",
            DataForeman.Shared.Mqtt.ConnectionState.Connecting => "connecting",
            DataForeman.Shared.Mqtt.ConnectionState.Error => "error",
            _ => "disconnected"
        };
    }

    private string GetStatusText(DataForeman.Shared.Mqtt.ConnectionStatusMessage? status, bool enabled)
    {
        if (!enabled) return "Disabled";
        if (status == null) return "Unknown";
        return status.State.ToString();
    }

    private void ShowAddConnectionDialog()
    {
        EditingConnection = null;
        ConnectionForm = new ConnectionFormModel();
        ShowConnectionDialog = true;
    }

    private void EditConnectionById(string id)
    {
        var conn = ConfigService.GetConnection(id);
        if (conn == null) return;
        EditingConnection = conn;
        ConnectionForm = new ConnectionFormModel { Name = conn.Name, Type = conn.Type, Enabled = conn.Enabled };
        ShowConnectionDialog = true;
    }

    private async Task SaveConnection()
    {
        if (string.IsNullOrWhiteSpace(ConnectionForm.Name)) return;
        if (EditingConnection == null)
        {
            var newConn = new DataForeman.Shared.Models.ConnectionConfig {
                Name = ConnectionForm.Name, Type = ConnectionForm.Type, Enabled = ConnectionForm.Enabled
            };
            await ConfigService.AddConnectionAsync(newConn);
        }
        else
        {
            EditingConnection.Name = ConnectionForm.Name;
            EditingConnection.Type = ConnectionForm.Type;
            EditingConnection.Enabled = ConnectionForm.Enabled;
            await ConfigService.UpdateConnectionAsync(EditingConnection);
        }
        await MqttService.PublishConfigReloadAsync("connections");
        CloseDialogs();
    }

    private void ConfirmDeleteConnectionById(string id)
    {
        var conn = ConfigService.GetConnection(id);
        if (conn == null) return;
        DeleteItemName = conn.Name;
        DeleteAction = async () => {
            await ConfigService.DeleteConnectionAsync(id);
            await MqttService.PublishConfigReloadAsync("connections");
        };
        ShowDeleteDialog = true;
    }

    private void ViewTagsById(string id)
    {
        SelectedConnectionId = id;
    }

    private void ShowAddTagDialog()
    {
        EditingTag = null;
        EditingTagConnectionId = null;
        TagForm = new TagFormModel();
        TagConnectionId = string.IsNullOrEmpty(SelectedConnectionId) ? ConfigService.Connections.FirstOrDefault()?.Id ?? "" : SelectedConnectionId;
        ShowTagDialog = true;
    }

    private void EditTagById(string connId, string tagId)
    {
        var conn = ConfigService.GetConnection(connId);
        var tag = conn?.Tags.FirstOrDefault(t => t.Id == tagId);
        if (tag == null) return;
        EditingTag = tag;
        EditingTagConnectionId = connId;
        TagForm = new TagFormModel {
            Name = tag.Name, Address = tag.Address, DataType = tag.DataType,
            PollRateMs = tag.PollRateMs, Unit = tag.Unit ?? "", Enabled = tag.Enabled
        };
        ShowTagDialog = true;
    }

    private async Task SaveTag()
    {
        if (string.IsNullOrWhiteSpace(TagForm.Name)) return;
        if (EditingTag == null)
        {
            if (string.IsNullOrEmpty(TagConnectionId)) return;
            var newTag = new DataForeman.Shared.Models.TagConfig {
                Name = TagForm.Name, Address = TagForm.Address, DataType = TagForm.DataType,
                PollRateMs = TagForm.PollRateMs, Unit = string.IsNullOrWhiteSpace(TagForm.Unit) ? null : TagForm.Unit,
                Enabled = TagForm.Enabled
            };
            await ConfigService.AddTagAsync(TagConnectionId, newTag);
        }
        else
        {
            EditingTag.Name = TagForm.Name;
            EditingTag.Address = TagForm.Address;
            EditingTag.DataType = TagForm.DataType;
            EditingTag.PollRateMs = TagForm.PollRateMs;
            EditingTag.Unit = string.IsNullOrWhiteSpace(TagForm.Unit) ? null : TagForm.Unit;
            EditingTag.Enabled = TagForm.Enabled;
            await ConfigService.UpdateTagAsync(EditingTagConnectionId!, EditingTag);
        }
        await MqttService.PublishConfigReloadAsync("connections");
        CloseDialogs();
    }

    private void ConfirmDeleteTagById(string connId, string tagId)
    {
        var conn = ConfigService.GetConnection(connId);
        var tag = conn?.Tags.FirstOrDefault(t => t.Id == tagId);
        if (tag == null) return;
        DeleteItemName = tag.Name;
        DeleteAction = async () => {
            await ConfigService.DeleteTagAsync(connId, tagId);
            await MqttService.PublishConfigReloadAsync("connections");
        };
        ShowDeleteDialog = true;
    }

    private async Task ExecuteDelete()
    {
        if (DeleteAction != null) await DeleteAction();
        CloseDialogs();
    }

    private void CloseDialogs()
    {
        ShowConnectionDialog = false;
        ShowTagDialog = false;
        ShowDeleteDialog = false;
        EditingConnection = null;
        EditingTag = null;
        EditingTagConnectionId = null;
        DeleteAction = null;
    }

    public void Dispose() => RealtimeData.OnDataChanged -= HandleDataChanged;

    public record ConnectionOption(string Id, string Name);
    
    public class ConnectionDisplay 
    { 
        public string Id { get; set; } = ""; 
        public string Name { get; set; } = ""; 
        public string Type { get; set; } = ""; 
        public int TagCount { get; set; } 
        public string StatusText { get; set; } = ""; 
        public string StatusClass { get; set; } = ""; 
    }
    
    public class TagDisplay 
    { 
        public string Id { get; set; } = ""; 
        public string ConnectionId { get; set; } = ""; 
        public string ConnectionName { get; set; } = ""; 
        public string Name { get; set; } = ""; 
        public string DataType { get; set; } = ""; 
        public string PollRate { get; set; } = ""; 
        public string Value { get; set; } = ""; 
        public bool? IsGood { get; set; } 
    }
    
    private class ConnectionFormModel 
    { 
        public string Name { get; set; } = ""; 
        public string Type { get; set; } = "Simulator"; 
        public bool Enabled { get; set; } = true; 
    }
    
    private class TagFormModel 
    { 
        public string Name { get; set; } = ""; 
        public string Address { get; set; } = ""; 
        public string DataType { get; set; } = "Float"; 
        public int PollRateMs { get; set; } = 1000; 
        public string Unit { get; set; } = ""; 
        public bool Enabled { get; set; } = true; 
    }
}
