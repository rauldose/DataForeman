@page "/connectivity"
@rendermode InteractiveServer
@inject ConfigService ConfigService
@inject RealtimeDataService RealtimeData
@inject MqttService MqttService
@implements IDisposable

<PageTitle>Connectivity - DataForeman</PageTitle>

<div class="connectivity-page">
    <div class="page-header">
        <h1>Connectivity</h1>
        <div class="page-actions">
            <button class="btn btn-primary" @onclick="ShowAddConnectionDialog">
                ‚ûï Add Connection
            </button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab @(ActiveTab == "connections" ? "active" : "")" @onclick="@(() => ActiveTab = "connections")">
            Connections (@ConfigService.Connections.Count)
        </button>
        <button class="tab @(ActiveTab == "tags" ? "active" : "")" @onclick="@(() => ActiveTab = "tags")">
            Tags (@TotalTags)
        </button>
    </div>

    @if (ActiveTab == "connections")
    {
        <div class="tab-content">
            @if (!ConfigService.Connections.Any())
            {
                <div class="no-data">No connections configured. Click "Add Connection" to create one.</div>
            }
            else
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Tags</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var conn in ConfigService.Connections)
                        {
                            var status = RealtimeData.GetConnectionStatus(conn.Id);
                            <tr>
                                <td>@conn.Name</td>
                                <td>@conn.Type</td>
                                <td>
                                    <span class="status-badge @GetStatusClass(status, conn.Enabled)">
                                        @GetStatusText(status, conn.Enabled)
                                    </span>
                                </td>
                                <td>@conn.Tags.Count</td>
                                <td class="actions-cell">
                                    <button class="btn btn-icon" title="Edit" @onclick="@(() => EditConnection(conn))">‚úèÔ∏è</button>
                                    <button class="btn btn-icon" title="View Tags" @onclick="@(() => ViewTags(conn))">üè∑Ô∏è</button>
                                    <button class="btn btn-icon btn-danger" title="Delete" @onclick="@(() => ConfirmDeleteConnection(conn))">üóëÔ∏è</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
    else if (ActiveTab == "tags")
    {
        <div class="tab-content">
            <div class="toolbar">
                <select class="form-select" @bind="SelectedConnectionId">
                    <option value="">All Connections</option>
                    @foreach (var conn in ConfigService.Connections)
                    {
                        <option value="@conn.Id">@conn.Name</option>
                    }
                </select>
                <input type="text" class="form-input" placeholder="Search tags..." @bind="TagSearchQuery" @bind:event="oninput" />
                <button class="btn btn-primary" @onclick="ShowAddTagDialog">‚ûï Add Tag</button>
            </div>

            @if (!FilteredTags.Any())
            {
                <div class="no-data">No tags found. Add tags to your connections to get started.</div>
            }
            else
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Connection</th>
                            <th>Data Type</th>
                            <th>Poll Rate</th>
                            <th>Current Value</th>
                            <th>Quality</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in FilteredTags)
                        {
                            var tagValue = RealtimeData.GetTagValue(item.Tag.Id);
                            <tr>
                                <td>@item.Tag.Name</td>
                                <td>@item.Connection.Name</td>
                                <td>@item.Tag.DataType</td>
                                <td>@item.Tag.PollRateMs ms</td>
                                <td class="value-cell">@(tagValue?.FormattedValue ?? "N/A")</td>
                                <td>
                                    <span class="quality-badge @(tagValue?.IsGoodQuality == true ? "good" : "unknown")">
                                        @(tagValue?.QualityText ?? "N/A")
                                    </span>
                                </td>
                                <td class="actions-cell">
                                    <button class="btn btn-icon" title="Edit" @onclick="@(() => EditTag(item.Connection, item.Tag))">‚úèÔ∏è</button>
                                    <button class="btn btn-icon btn-danger" title="Delete" @onclick="@(() => ConfirmDeleteTag(item.Connection, item.Tag))">üóëÔ∏è</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
</div>

@* Connection Dialog *@
@if (ShowConnectionDialog)
{
    <div class="modal-backdrop" @onclick="CloseDialogs"></div>
    <div class="modal">
        <div class="modal-header">
            <h3>@(EditingConnection == null ? "Add Connection" : "Edit Connection")</h3>
            <button class="btn-close" @onclick="CloseDialogs">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="form-input" @bind="ConnectionForm.Name" />
            </div>
            <div class="form-group">
                <label>Type</label>
                <select class="form-select" @bind="ConnectionForm.Type">
                    <option value="Simulator">Simulator</option>
                    <option value="OpcUa">OPC UA</option>
                    <option value="S7">Siemens S7</option>
                    <option value="Modbus">Modbus</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" @bind="ConnectionForm.Enabled" /> Enabled
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" @onclick="CloseDialogs">Cancel</button>
            <button class="btn btn-primary" @onclick="SaveConnection">Save</button>
        </div>
    </div>
}

@* Tag Dialog *@
@if (ShowTagDialog)
{
    <div class="modal-backdrop" @onclick="CloseDialogs"></div>
    <div class="modal">
        <div class="modal-header">
            <h3>@(EditingTag == null ? "Add Tag" : "Edit Tag")</h3>
            <button class="btn-close" @onclick="CloseDialogs">√ó</button>
        </div>
        <div class="modal-body">
            @if (EditingTag == null)
            {
                <div class="form-group">
                    <label>Connection</label>
                    <select class="form-select" @bind="TagConnectionId">
                        @foreach (var conn in ConfigService.Connections)
                        {
                            <option value="@conn.Id">@conn.Name</option>
                        }
                    </select>
                </div>
            }
            <div class="form-group">
                <label>Name</label>
                <input type="text" class="form-input" @bind="TagForm.Name" />
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" class="form-input" @bind="TagForm.Address" />
            </div>
            <div class="form-group">
                <label>Data Type</label>
                <select class="form-select" @bind="TagForm.DataType">
                    <option value="Boolean">Boolean</option>
                    <option value="Int16">Int16</option>
                    <option value="Int32">Int32</option>
                    <option value="Float">Float</option>
                    <option value="Double">Double</option>
                    <option value="String">String</option>
                </select>
            </div>
            <div class="form-group">
                <label>Poll Rate (ms)</label>
                <input type="number" class="form-input" @bind="TagForm.PollRateMs" min="10" max="60000" />
            </div>
            <div class="form-group">
                <label>Unit</label>
                <input type="text" class="form-input" @bind="TagForm.Unit" />
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" class="form-input" @bind="TagForm.Description" />
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" @bind="TagForm.Enabled" /> Enabled
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" @onclick="CloseDialogs">Cancel</button>
            <button class="btn btn-primary" @onclick="SaveTag">Save</button>
        </div>
    </div>
}

@* Delete Confirmation Dialog *@
@if (ShowDeleteDialog)
{
    <div class="modal-backdrop" @onclick="CloseDialogs"></div>
    <div class="modal">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <button class="btn-close" @onclick="CloseDialogs">√ó</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete "@DeleteItemName"?</p>
            <p class="warning">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn" @onclick="CloseDialogs">Cancel</button>
            <button class="btn btn-danger" @onclick="ExecuteDelete">Delete</button>
        </div>
    </div>
}

@code {
    private string ActiveTab = "connections";
    private string SelectedConnectionId = "";
    private string TagSearchQuery = "";
    
    private bool ShowConnectionDialog;
    private bool ShowTagDialog;
    private bool ShowDeleteDialog;
    
    private DataForeman.Shared.Models.ConnectionConfig? EditingConnection;
    private DataForeman.Shared.Models.TagConfig? EditingTag;
    private string? EditingTagConnectionId;
    
    private ConnectionFormModel ConnectionForm = new();
    private TagFormModel TagForm = new();
    private string TagConnectionId = "";
    
    private string DeleteItemName = "";
    private Func<Task>? DeleteAction;

    private int TotalTags => ConfigService.Connections.Sum(c => c.Tags.Count);

    private IEnumerable<(DataForeman.Shared.Models.ConnectionConfig Connection, DataForeman.Shared.Models.TagConfig Tag)> FilteredTags
    {
        get
        {
            var query = ConfigService.GetAllTagsWithConnection().AsEnumerable();
            
            if (!string.IsNullOrEmpty(SelectedConnectionId))
            {
                query = query.Where(x => x.Connection.Id == SelectedConnectionId);
            }
            
            if (!string.IsNullOrEmpty(TagSearchQuery))
            {
                query = query.Where(x => 
                    x.Tag.Name.Contains(TagSearchQuery, StringComparison.OrdinalIgnoreCase) ||
                    x.Tag.Address.Contains(TagSearchQuery, StringComparison.OrdinalIgnoreCase));
            }
            
            return query;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await ConfigService.LoadAllAsync();
        RealtimeData.OnDataChanged += HandleDataChanged;
    }

    private void HandleDataChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetStatusClass(DataForeman.Shared.Mqtt.ConnectionStatusMessage? status, bool enabled)
    {
        if (!enabled) return "disabled";
        if (status == null) return "unknown";
        return status.State switch
        {
            DataForeman.Shared.Mqtt.ConnectionState.Connected => "connected",
            DataForeman.Shared.Mqtt.ConnectionState.Connecting => "connecting",
            DataForeman.Shared.Mqtt.ConnectionState.Error => "error",
            _ => "disconnected"
        };
    }

    private string GetStatusText(DataForeman.Shared.Mqtt.ConnectionStatusMessage? status, bool enabled)
    {
        if (!enabled) return "Disabled";
        if (status == null) return "Unknown";
        return status.State.ToString();
    }

    private void ShowAddConnectionDialog()
    {
        EditingConnection = null;
        ConnectionForm = new ConnectionFormModel();
        ShowConnectionDialog = true;
    }

    private void EditConnection(DataForeman.Shared.Models.ConnectionConfig connection)
    {
        EditingConnection = connection;
        ConnectionForm = new ConnectionFormModel
        {
            Name = connection.Name,
            Type = connection.Type,
            Enabled = connection.Enabled
        };
        ShowConnectionDialog = true;
    }

    private async Task SaveConnection()
    {
        if (string.IsNullOrWhiteSpace(ConnectionForm.Name)) return;

        if (EditingConnection == null)
        {
            var newConnection = new DataForeman.Shared.Models.ConnectionConfig
            {
                Name = ConnectionForm.Name,
                Type = ConnectionForm.Type,
                Enabled = ConnectionForm.Enabled
            };
            await ConfigService.AddConnectionAsync(newConnection);
        }
        else
        {
            EditingConnection.Name = ConnectionForm.Name;
            EditingConnection.Type = ConnectionForm.Type;
            EditingConnection.Enabled = ConnectionForm.Enabled;
            await ConfigService.UpdateConnectionAsync(EditingConnection);
        }

        await MqttService.PublishConfigReloadAsync("connections");
        CloseDialogs();
    }

    private void ConfirmDeleteConnection(DataForeman.Shared.Models.ConnectionConfig connection)
    {
        DeleteItemName = connection.Name;
        DeleteAction = async () =>
        {
            await ConfigService.DeleteConnectionAsync(connection.Id);
            await MqttService.PublishConfigReloadAsync("connections");
        };
        ShowDeleteDialog = true;
    }

    private void ViewTags(DataForeman.Shared.Models.ConnectionConfig connection)
    {
        SelectedConnectionId = connection.Id;
        ActiveTab = "tags";
    }

    private void ShowAddTagDialog()
    {
        EditingTag = null;
        EditingTagConnectionId = null;
        TagForm = new TagFormModel();
        TagConnectionId = string.IsNullOrEmpty(SelectedConnectionId) 
            ? ConfigService.Connections.FirstOrDefault()?.Id ?? "" 
            : SelectedConnectionId;
        ShowTagDialog = true;
    }

    private void EditTag(DataForeman.Shared.Models.ConnectionConfig connection, DataForeman.Shared.Models.TagConfig tag)
    {
        EditingTag = tag;
        EditingTagConnectionId = connection.Id;
        TagForm = new TagFormModel
        {
            Name = tag.Name,
            Address = tag.Address,
            DataType = tag.DataType,
            PollRateMs = tag.PollRateMs,
            Unit = tag.Unit ?? "",
            Description = tag.Description ?? "",
            Enabled = tag.Enabled
        };
        ShowTagDialog = true;
    }

    private async Task SaveTag()
    {
        if (string.IsNullOrWhiteSpace(TagForm.Name)) return;

        if (EditingTag == null)
        {
            if (string.IsNullOrEmpty(TagConnectionId)) return;
            
            var newTag = new DataForeman.Shared.Models.TagConfig
            {
                Name = TagForm.Name,
                Address = TagForm.Address,
                DataType = TagForm.DataType,
                PollRateMs = TagForm.PollRateMs,
                Unit = string.IsNullOrWhiteSpace(TagForm.Unit) ? null : TagForm.Unit,
                Description = string.IsNullOrWhiteSpace(TagForm.Description) ? null : TagForm.Description,
                Enabled = TagForm.Enabled
            };
            await ConfigService.AddTagAsync(TagConnectionId, newTag);
        }
        else
        {
            EditingTag.Name = TagForm.Name;
            EditingTag.Address = TagForm.Address;
            EditingTag.DataType = TagForm.DataType;
            EditingTag.PollRateMs = TagForm.PollRateMs;
            EditingTag.Unit = string.IsNullOrWhiteSpace(TagForm.Unit) ? null : TagForm.Unit;
            EditingTag.Description = string.IsNullOrWhiteSpace(TagForm.Description) ? null : TagForm.Description;
            EditingTag.Enabled = TagForm.Enabled;
            await ConfigService.UpdateTagAsync(EditingTagConnectionId!, EditingTag);
        }

        await MqttService.PublishConfigReloadAsync("connections");
        CloseDialogs();
    }

    private void ConfirmDeleteTag(DataForeman.Shared.Models.ConnectionConfig connection, DataForeman.Shared.Models.TagConfig tag)
    {
        DeleteItemName = tag.Name;
        DeleteAction = async () =>
        {
            await ConfigService.DeleteTagAsync(connection.Id, tag.Id);
            await MqttService.PublishConfigReloadAsync("connections");
        };
        ShowDeleteDialog = true;
    }

    private async Task ExecuteDelete()
    {
        if (DeleteAction != null)
        {
            await DeleteAction();
        }
        CloseDialogs();
    }

    private void CloseDialogs()
    {
        ShowConnectionDialog = false;
        ShowTagDialog = false;
        ShowDeleteDialog = false;
        EditingConnection = null;
        EditingTag = null;
        EditingTagConnectionId = null;
        DeleteAction = null;
    }

    public void Dispose()
    {
        RealtimeData.OnDataChanged -= HandleDataChanged;
    }

    private class ConnectionFormModel
    {
        public string Name { get; set; } = "";
        public string Type { get; set; } = "Simulator";
        public bool Enabled { get; set; } = true;
    }

    private class TagFormModel
    {
        public string Name { get; set; } = "";
        public string Address { get; set; } = "";
        public string DataType { get; set; } = "Float";
        public int PollRateMs { get; set; } = 1000;
        public string Unit { get; set; } = "";
        public string Description { get; set; } = "";
        public bool Enabled { get; set; } = true;
    }
}
