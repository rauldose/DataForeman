@page "/dashboards"
@page "/dashboards/{DashboardId}"
@rendermode InteractiveServer
@using Syncfusion.Blazor.Layouts
@using Syncfusion.Blazor.CircularGauge
@inject ConfigService ConfigService
@inject RealtimeDataService RealtimeData
@inject MqttService MqttService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AppStateService AppState
@implements IDisposable

<PageTitle>Dashboards - DataForeman</PageTitle>

<div class="page-container">
    @if (string.IsNullOrEmpty(DashboardId))
    {
        <!-- Dashboard List View -->
        <div class="page-toolbar">
            <h2><i class="fa-solid fa-gauge"></i> Dashboards</h2>
            <div class="toolbar-actions">
                <PermissionGuard Feature="dashboards" Operation="create">
                    <SfButton CssClass="e-primary" IconCss="fa-solid fa-plus" @onclick="CreateNewDashboard">New Dashboard</SfButton>
                </PermissionGuard>
            </div>
        </div>
        
        @if (!VisibleDashboards.Any())
        {
            <div class="empty-state">
                <i class="fa-solid fa-gauge"></i>
                <span>No dashboards configured</span>
                <SfButton CssClass="e-primary e-small" @onclick="CreateNewDashboard">Create your first dashboard</SfButton>
            </div>
        }
        else
        {
            <div class="dashboard-grid">
                @foreach (var dashboard in VisibleDashboards)
                {
                    <div class="dashboard-card" @onclick="() => ViewDashboard(dashboard.Id)">
                        <div class="dashboard-card-header">
                            <i class="fa-solid fa-gauge"></i>
                            <span class="dashboard-name">@dashboard.Name</span>
                            @if (dashboard.IsShared)
                            {
                                <span class="shared-badge" title="Shared with others"><i class="fa-solid fa-share-nodes"></i></span>
                            }
                            @if (!AppState.IsOwner(dashboard.OwnerId) && dashboard.IsShared)
                            {
                                <span class="readonly-badge" title="Read only">Read Only</span>
                            }
                        </div>
                        <div class="dashboard-card-body">
                            <span class="dashboard-description">@(dashboard.Description ?? "No description")</span>
                            <div class="dashboard-stats">
                                <span><i class="fa-solid fa-table-cells"></i> @dashboard.Panels.Count panels</span>
                            </div>
                        </div>
                        <div class="dashboard-card-actions" @onclick:stopPropagation="true">
                            @if (AppState.IsOwner(dashboard.OwnerId))
                            {
                                <PermissionGuard Feature="dashboards" Operation="update">
                                    <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-pen" @onclick="() => EditDashboard(dashboard.Id)"></SfButton>
                                </PermissionGuard>
                                <PermissionGuard Feature="dashboards" Operation="delete">
                                    <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-trash" @onclick="() => ConfirmDeleteDashboard(dashboard.Id)"></SfButton>
                                </PermissionGuard>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    }
    else
    {
        <!-- Dashboard View/Edit -->
        <div class="dashboard-viewer">
            <!-- Toolbar -->
            <div class="editor-toolbar">
                <div class="toolbar-left">
                    <SfButton CssClass="e-flat" IconCss="fa-solid fa-arrow-left" @onclick="GoBack"></SfButton>
                    @if (IsEditMode)
                    {
                        <SfTextBox @bind-Value="CurrentDashboard.Name" Placeholder="Dashboard Name" CssClass="name-input"></SfTextBox>
                    }
                    else
                    {
                        <h2 class="dashboard-title">@CurrentDashboard.Name</h2>
                    }
                </div>
                
                <div class="toolbar-center">
                    <!-- Time Range Controls -->
                    <div class="time-controls">
                        <SfDropDownList TItem="TimeRangeOption" TValue="string" DataSource="@TimeRanges" 
                                        @bind-Value="SelectedTimeRange" Width="120px" CssClass="time-dropdown">
                            <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                        </SfDropDownList>
                        <SfButton CssClass="e-flat" IconCss="fa-solid fa-sync" @onclick="RefreshData"></SfButton>
                    </div>
                </div>
                
                <div class="toolbar-right">
                    @if (IsEditMode)
                    {
                        <SfButton CssClass="e-flat" IconCss="fa-solid fa-chart-line" Content="Add Chart" @onclick="ShowChartLibrary"></SfButton>
                        <SfButton CssClass="e-flat" IconCss="fa-solid fa-play" Content="Add Flow" @onclick="ShowFlowLibrary"></SfButton>
                        <SfButton CssClass="e-flat" IconCss="fa-solid fa-plus" Content="Add Panel" @onclick="ShowAddPanel"></SfButton>
                        @if (AppState.IsOwner(CurrentDashboard.OwnerId))
                        {
                            <div class="share-toggle" title="@(CurrentDashboard.IsShared ? "Shared with others" : "Private")">
                                <SfCheckBox @bind-Checked="CurrentDashboard.IsShared" Label="Share" TChecked="bool"></SfCheckBox>
                            </div>
                            <PermissionGuard Feature="dashboards" Operation="update">
                                <SfButton CssClass="e-primary" IconCss="fa-solid fa-floppy-disk" @onclick="SaveDashboard">Save</SfButton>
                            </PermissionGuard>
                        }
                        <SfButton CssClass="e-flat" @onclick="ExitEditMode">Cancel</SfButton>
                    }
                    else
                    {
                        <SfButton CssClass="e-flat" IconCss="fa-solid fa-tv" @onclick="ShowTVModeDialog" Content="TV Mode"></SfButton>
                        <SfButton CssClass="e-flat" IconCss="fa-solid fa-file-export" @onclick="ExportDashboard" Content="Export"></SfButton>
                        <SfButton CssClass="e-flat" IconCss="fa-solid fa-file-import" @onclick="ShowImportDialog" Content="Import"></SfButton>
                        @if (AppState.IsOwner(CurrentDashboard.OwnerId))
                        {
                            <SfButton CssClass="e-flat" IconCss="fa-solid fa-pen" @onclick="EnterEditMode">Edit</SfButton>
                        }
                        <SfButton CssClass="e-flat" IconCss="fa-solid fa-expand" @onclick="ToggleFullscreen"></SfButton>
                    }
                </div>
            </div>
            
            <!-- Dashboard Grid using SfDashboardLayout -->
            <div class="dashboard-grid-container @(IsFullscreen ? "fullscreen" : "")" style="height: calc(100vh - 150px); width: 100%;">
                <SfDashboardLayout @ref="DashboardLayout" 
                                   Columns="12" 
                                   CellSpacing="@(new double[] { 10, 10 })"
                                   CellAspectRatio="0.6"
                                   AllowDragging="@IsEditMode"
                                   AllowResizing="@IsEditMode">
                    <DashboardLayoutEvents OnResizeStop="OnPanelResized" Changed="OnLayoutChanged"></DashboardLayoutEvents>
                    <DashboardLayoutPanels>
                        @foreach (var panel in CurrentDashboard.Panels)
                        {
                            <DashboardLayoutPanel Id="@panel.Id" 
                                                  Row="@panel.GridY" 
                                                  Column="@panel.GridX" 
                                                  SizeX="@panel.GridWidth" 
                                                  SizeY="@panel.GridHeight">
                                <HeaderTemplate>
                                    <div class="panel-header-content @(SelectedPanel?.Id == panel.Id ? "selected" : "")" @onclick="() => SelectPanel(panel)">
                                        <span class="panel-title">@panel.Title</span>
                                        @if (IsEditMode)
                                        {
                                            <div class="panel-actions" @onclick:stopPropagation="true">
                                                <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-cog" @onclick="() => ConfigurePanel(panel)"></SfButton>
                                                <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-trash" @onclick="() => RemovePanel(panel)"></SfButton>
                                            </div>
                                        }
                                    </div>
                                </HeaderTemplate>
                                <ContentTemplate>
                                    <div class="panel-content" @key="@($"{panel.Id}-v{GetPanelResizeVersion(panel.Id)}")">
                                        @RenderPanel(panel)
                                    </div>
                                </ContentTemplate>
                            </DashboardLayoutPanel>
                        }
                    </DashboardLayoutPanels>
                </SfDashboardLayout>
            </div>
        </div>
    }
</div>

<!-- Add Panel Dialog -->
@if (ShowAddPanelDialog)
{
    <SfDialog @bind-Visible="ShowAddPanelDialog" Width="400px" IsModal="true" ShowCloseIcon="true" Header="Add Panel">
        <DialogTemplates>
            <Content>
                <div class="add-panel-form">
                    <div class="form-group">
                        <label>Panel Type</label>
                        <SfDropDownList TItem="PanelTypeOption" TValue="PanelType" DataSource="@PanelTypes" @bind-Value="NewPanelType">
                            <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                        </SfDropDownList>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <SfTextBox @bind-Value="NewPanelTitle"></SfTextBox>
                    </div>
                </div>
            </Content>
            <FooterTemplate>
                <SfButton @onclick="() => ShowAddPanelDialog = false">Cancel</SfButton>
                <SfButton CssClass="e-primary" @onclick="AddPanel">Add</SfButton>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
}

<!-- Chart Library Dialog -->
@if (ShowChartLibraryDialog)
{
    <SfDialog @bind-Visible="ShowChartLibraryDialog" Width="480px" IsModal="true" ShowCloseIcon="true" Header="Chart Library" CssClass="chart-library-dialog">
        <DialogTemplates>
            <Content>
                <div class="chart-library">
                    <div class="form-group">
                        <SfTextBox @bind-Value="ChartLibrarySearch" Placeholder="Search charts..." CssClass="chart-search"></SfTextBox>
                    </div>
                    @{
                        var filteredCharts = ConfigService.Charts
                            .Where(c => string.IsNullOrEmpty(ChartLibrarySearch) 
                                || c.Name.Contains(ChartLibrarySearch, StringComparison.OrdinalIgnoreCase))
                            .ToList();
                    }
                    @if (!filteredCharts.Any())
                    {
                        <div class="empty-state" style="padding:24px;text-align:center;">
                            <i class="fa-solid fa-chart-line" style="font-size:32px;color:#666;"></i>
                            <p style="color:#999;margin-top:8px;">@(string.IsNullOrEmpty(ChartLibrarySearch) ? "No charts configured" : "No charts match your search")</p>
                        </div>
                    }
                    else
                    {
                        <div class="chart-library-list">
                            @foreach (var chart in filteredCharts)
                            {
                                <div class="chart-library-item" @onclick="() => AddChartWidget(chart.Id)">
                                    <div class="chart-library-item-info">
                                        <div class="chart-library-item-name">
                                            <i class="fa-solid fa-chart-line" style="color:@(chart.Series.FirstOrDefault()?.Color ?? "#3b82f6");margin-right:8px;"></i>
                                            @chart.Name
                                        </div>
                                        <div class="chart-library-item-meta">
                                            <span class="chart-library-chip">@chart.ChartType</span>
                                            <span class="chart-library-chip">@chart.Series.Count series</span>
                                        </div>
                                    </div>
                                    <button class="chart-library-add-btn" title="Add to dashboard">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    <div class="chart-library-footer">@filteredCharts.Count chart@(filteredCharts.Count != 1 ? "s" : "") available</div>
                </div>
            </Content>
        </DialogTemplates>
    </SfDialog>
}

<!-- Flow Library Dialog -->
@if (ShowFlowLibraryDialog)
{
    <SfDialog @bind-Visible="ShowFlowLibraryDialog" Width="480px" IsModal="true" ShowCloseIcon="true" Header="Add Flow to Dashboard">
        <DialogTemplates>
            <Content>
                <div class="chart-library">
                    <div class="form-group">
                        <SfTextBox @bind-Value="FlowLibrarySearch" Placeholder="Search flows..." CssClass="chart-search"></SfTextBox>
                    </div>
                    @{
                        var manualFlows = ConfigService.Flows
                            .Where(f => f.ExecutionMode == "manual")
                            .Where(f => string.IsNullOrEmpty(FlowLibrarySearch)
                                || f.Name.Contains(FlowLibrarySearch, StringComparison.OrdinalIgnoreCase))
                            .ToList();
                    }
                    @if (!manualFlows.Any())
                    {
                        <div class="empty-state" style="padding:24px;text-align:center;">
                            <i class="fa-solid fa-play" style="font-size:32px;color:#666;"></i>
                            <p style="color:#999;margin-top:8px;">@(string.IsNullOrEmpty(FlowLibrarySearch) ? "No manual flows available" : "No flows match your search")</p>
                        </div>
                    }
                    else
                    {
                        <div class="chart-library-list">
                            @foreach (var flow in manualFlows)
                            {
                                <div class="chart-library-item" @onclick="() => AddFlowWidget(flow.Id)">
                                    <div class="chart-library-item-info">
                                        <div class="chart-library-item-name">
                                            <i class="fa-solid fa-play" style="color:#8b5cf6;margin-right:8px;"></i>
                                            @flow.Name
                                        </div>
                                        <div class="chart-library-item-meta">
                                            <span class="chart-library-chip">@flow.Nodes.Count nodes</span>
                                            @if (!string.IsNullOrEmpty(flow.Description))
                                            {
                                                <span style="font-size:11px;color:#888;margin-left:4px;">@flow.Description</span>
                                            }
                                        </div>
                                    </div>
                                    <button class="chart-library-add-btn" title="Add to dashboard">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    <div class="chart-library-footer">@manualFlows.Count manual flow@(manualFlows.Count != 1 ? "s" : "") available</div>
                </div>
            </Content>
        </DialogTemplates>
    </SfDialog>
}

<!-- Panel Config Dialog -->
@if (ShowPanelConfigDialog)
{
    <SfDialog @bind-Visible="ShowPanelConfigDialog" Width="600px" IsModal="true" ShowCloseIcon="true" Header="Configure Panel">
        <DialogTemplates>
            <Content>
                @if (ConfiguringPanel != null)
                {
                    <div class="panel-config-form">
                        <div class="form-group">
                            <label>Title</label>
                            <SfTextBox @bind-Value="ConfiguringPanel.Title"></SfTextBox>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Width (columns)</label>
                                <SfNumericTextBox TValue="int" @bind-Value="ConfiguringPanel.GridWidth" Min="1" Max="12"></SfNumericTextBox>
                            </div>
                            <div class="form-group">
                                <label>Height (rows)</label>
                                <SfNumericTextBox TValue="int" @bind-Value="ConfiguringPanel.GridHeight" Min="1" Max="10"></SfNumericTextBox>
                            </div>
                        </div>
                        
                        @switch (ConfiguringPanel.Type)
                        {
                            case PanelType.Stat:
                                <div class="form-group">
                                    <label>Tag</label>
                                    <SfDropDownList TItem="TagOption" TValue="string" DataSource="@AvailableTags" 
                                                    Value="@(ConfiguringPanel.StatConfig?.TagId)" ValueChanged="@(v => SetStatTag(v))">
                                        <DropDownListFieldSettings Text="Name" Value="Id"></DropDownListFieldSettings>
                                    </SfDropDownList>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Unit</label>
                                        <SfTextBox Value="@(ConfiguringPanel.StatConfig?.Unit)" ValueChanged="@(v => SetStatUnit(v))"></SfTextBox>
                                    </div>
                                    <div class="form-group">
                                        <label>Decimals</label>
                                        <SfNumericTextBox TValue="int" Value="@(ConfiguringPanel.StatConfig?.Decimals ?? 2)" ValueChanged="@(v => SetStatDecimals(v))"></SfNumericTextBox>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <SfCheckBox TChecked="bool" Checked="@(ConfiguringPanel.StatConfig?.ShowSparkline ?? false)" CheckedChanged="@(v => SetStatSparkline(v))" Label="Show Sparkline"></SfCheckBox>
                                </div>
                                break;
                                
                            case PanelType.Gauge:
                                <div class="form-group">
                                    <label>Tag</label>
                                    <SfDropDownList TItem="TagOption" TValue="string" DataSource="@AvailableTags" 
                                                    Value="@(ConfiguringPanel.GaugeConfig?.TagId)" ValueChanged="@(v => SetGaugeTag(v))">
                                        <DropDownListFieldSettings Text="Name" Value="Id"></DropDownListFieldSettings>
                                    </SfDropDownList>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Min Value</label>
                                        <SfNumericTextBox TValue="double" Value="@(ConfiguringPanel.GaugeConfig?.MinValue ?? 0)" ValueChanged="@(v => SetGaugeMin(v))"></SfNumericTextBox>
                                    </div>
                                    <div class="form-group">
                                        <label>Max Value</label>
                                        <SfNumericTextBox TValue="double" Value="@(ConfiguringPanel.GaugeConfig?.MaxValue ?? 100)" ValueChanged="@(v => SetGaugeMax(v))"></SfNumericTextBox>
                                    </div>
                                </div>
                                break;
                                
                            case PanelType.Chart:
                                <div class="form-group">
                                    <label>Data Sources</label>
                                    @foreach (var tag in AvailableTags)
                                    {
                                        var isSelected = ConfiguringPanel.ChartConfig?.DataSources?.Any(d => d.TagId == tag.Id) ?? false;
                                        <div class="tag-selector">
                                            <SfCheckBox TChecked="bool" Checked="@isSelected" CheckedChanged="@(v => ToggleChartDataSource(tag.Id, v))" Label="@tag.Name"></SfCheckBox>
                                        </div>
                                    }
                                </div>
                                break;
                                
                            case PanelType.Table:
                                <div class="form-group">
                                    <label>Tags</label>
                                    @foreach (var tag in AvailableTags)
                                    {
                                        var isSelected = ConfiguringPanel.TableConfig?.TagIds?.Contains(tag.Id) ?? false;
                                        <div class="tag-selector">
                                            <SfCheckBox TChecked="bool" Checked="@isSelected" CheckedChanged="@(v => ToggleTableTag(tag.Id, v))" Label="@tag.Name"></SfCheckBox>
                                        </div>
                                    }
                                </div>
                                break;
                        }
                    </div>
                }
            </Content>
            <FooterTemplate>
                <SfButton @onclick="() => ShowPanelConfigDialog = false">Close</SfButton>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
}

<!-- Delete Confirmation Dialog -->
@if (ShowDeleteDialog)
{
    <SfDialog @bind-Visible="ShowDeleteDialog" Width="350px" IsModal="true" ShowCloseIcon="true">
        <DialogTemplates>
            <Header>Confirm Delete</Header>
            <Content>
                <p>Delete this dashboard?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </Content>
            <FooterTemplate>
                <SfButton @onclick="() => ShowDeleteDialog = false">Cancel</SfButton>
                <SfButton CssClass="e-danger" @onclick="ExecuteDeleteDashboard">Delete</SfButton>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
}

<!-- TV Mode Settings Dialog -->
@if (_showTVSettingsDialog)
{
    <SfDialog @bind-Visible="_showTVSettingsDialog" Width="420px" IsModal="true" ShowCloseIcon="true" Header="TV Mode Settings">
        <DialogTemplates>
            <Content>
                <div class="add-panel-form">
                    <div class="form-group">
                        <label>Rotation Interval</label>
                        <SfDropDownList TItem="TVIntervalOption" TValue="int" DataSource="@TVIntervals" @bind-Value="_tvRotationMs">
                            <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                        </SfDropDownList>
                    </div>
                    <div class="form-group">
                        <label>Select Dashboards to Rotate</label>
                        @foreach (var d in ConfigService.Dashboards)
                        {
                            var isSelected = _tvSelectedDashboardIds.Contains(d.Id);
                            <div class="tag-selector">
                                <SfCheckBox TChecked="bool" Checked="@isSelected"
                                            CheckedChanged="@(v => ToggleTVDashboard(d.Id, v))"
                                            Label="@d.Name"></SfCheckBox>
                            </div>
                        }
                    </div>
                </div>
            </Content>
            <FooterTemplate>
                <SfButton @onclick="() => _showTVSettingsDialog = false">Cancel</SfButton>
                <SfButton CssClass="e-primary" Disabled="@(!_tvSelectedDashboardIds.Any())" @onclick="StartTVMode">Start TV Mode</SfButton>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
}

<!-- TV Mode Overlay -->
@if (_tvModeActive)
{
    <div class="tv-mode-overlay" @onmousemove="TVMouseMove" @onkeydown="TVKeyDown" tabindex="0">
        <div class="tv-mode-topbar @(_tvControlsVisible ? "" : "hidden")">
            <span class="tv-mode-title">@_tvDashboards.ElementAtOrDefault(_tvIndex)?.Name</span>
            <span class="tv-mode-counter">@(_tvIndex + 1) / @_tvDashboards.Count</span>
            <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-times" @onclick="StopTVMode">Exit (ESC)</SfButton>
        </div>
        <div class="tv-mode-content">
            @if (_tvDashboards.Any())
            {
                var tvDash = _tvDashboards[_tvIndex];
                <SfDashboardLayout Columns="12"
                                   CellSpacing="@(new double[] { 10, 10 })"
                                   CellAspectRatio="0.6"
                                   AllowDragging="false"
                                   AllowResizing="false">
                    <DashboardLayoutPanels>
                        @foreach (var panel in tvDash.Panels)
                        {
                            <DashboardLayoutPanel Id="@panel.Id"
                                                  Row="@panel.GridY"
                                                  Column="@panel.GridX"
                                                  SizeX="@panel.GridWidth"
                                                  SizeY="@panel.GridHeight">
                                <HeaderTemplate>
                                    <div class="panel-header-content">
                                        <span class="panel-title">@panel.Title</span>
                                    </div>
                                </HeaderTemplate>
                                <ContentTemplate>
                                    <div class="panel-content">
                                        @RenderPanel(panel)
                                    </div>
                                </ContentTemplate>
                            </DashboardLayoutPanel>
                        }
                    </DashboardLayoutPanels>
                </SfDashboardLayout>
            }
        </div>
        <div class="tv-mode-controls @(_tvControlsVisible ? "" : "hidden")">
            <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-backward" @onclick="TVPrev"></SfButton>
            <SfButton CssClass="e-flat e-small" IconCss="@(_tvPaused ? "fa-solid fa-play" : "fa-solid fa-pause")" @onclick="TVTogglePause"></SfButton>
            <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-forward" @onclick="TVNext"></SfButton>
        </div>
    </div>
}

<!-- Import Dashboard Dialog -->
@if (_showImportDialog)
{
    <SfDialog @bind-Visible="_showImportDialog" Width="480px" IsModal="true" ShowCloseIcon="true" Header="Import Dashboard">
        <DialogTemplates>
            <Content>
                <div class="add-panel-form">
                    @if (string.IsNullOrEmpty(_importJson))
                    {
                        <div class="form-group">
                            <label>Paste dashboard JSON</label>
                            <SfTextBox @bind-Value="_importJson" Multiline="true" HtmlAttributes="@(new Dictionary<string, object>{{"rows","8"}})" Placeholder="Paste JSON here..."></SfTextBox>
                        </div>
                    }
                    else
                    {
                        <div class="import-validation">
                            @if (!string.IsNullOrEmpty(_importError))
                            {
                                <div class="import-validation-item error">
                                    <i class="fa-solid fa-circle-xmark"></i>
                                    <span>@_importError</span>
                                </div>
                            }
                            else
                            {
                                <div class="import-validation-item valid">
                                    <i class="fa-solid fa-circle-check"></i>
                                    <span>Valid dashboard: "@_importPreviewName" with @_importPanelCount panels</span>
                                </div>
                                <div class="form-group" style="margin-top:12px;">
                                    <label>Dashboard Name</label>
                                    <SfTextBox @bind-Value="_importName"></SfTextBox>
                                </div>
                            }
                        </div>
                    }
                </div>
            </Content>
            <FooterTemplate>
                @if (!string.IsNullOrEmpty(_importJson))
                {
                    <SfButton @onclick="ResetImport">Back</SfButton>
                }
                else
                {
                    <SfButton @onclick="() => _showImportDialog = false">Cancel</SfButton>
                }
                @if (string.IsNullOrEmpty(_importJson))
                {
                    <SfButton CssClass="e-primary" @onclick="ValidateImport">Validate</SfButton>
                }
                else if (string.IsNullOrEmpty(_importError))
                {
                    <SfButton CssClass="e-primary" @onclick="ExecuteImport">Import</SfButton>
                }
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
}

@code {
    [Parameter] public string? DashboardId { get; set; }
    
    private SfDashboardLayout? DashboardLayout;
    private DashboardConfig CurrentDashboard = new();
    
    /// <summary>Dashboards visible to the current user: owned + shared.</summary>
    private IEnumerable<DashboardConfig> VisibleDashboards => ConfigService.Dashboards
        .Where(d => AppState.IsOwner(d.OwnerId) || d.IsShared);
    private DashboardPanel? SelectedPanel;
    private DashboardPanel? ConfiguringPanel;
    private bool IsEditMode;
    private bool IsFullscreen;
    private bool ShowDeleteDialog;
    private bool ShowAddPanelDialog;
    private bool ShowPanelConfigDialog;
    private bool ShowChartLibraryDialog;
    private bool ShowFlowLibraryDialog;
    private string DeleteDashboardId = "";
    private string ChartLibrarySearch = "";
    private string FlowLibrarySearch = "";
    private string SelectedTimeRange = "5m";
    private PanelType NewPanelType = PanelType.Stat;
    private string NewPanelTitle = "";
    
    private System.Timers.Timer? _refreshTimer;
    
    // Track panel resize versions to force chart re-render
    private Dictionary<string, int> _panelResizeVersions = new();
    
    // ── TV Mode state ──
    private bool _showTVSettingsDialog;
    private bool _tvModeActive;
    private bool _tvPaused;
    private bool _tvControlsVisible = true;
    private int _tvRotationMs = 10000;
    private int _tvIndex;
    private List<string> _tvSelectedDashboardIds = new();
    private List<DashboardConfig> _tvDashboards = new();
    private System.Timers.Timer? _tvTimer;

    private List<TVIntervalOption> TVIntervals = new()
    {
        new() { Value = 5000, Label = "5 seconds" },
        new() { Value = 10000, Label = "10 seconds" },
        new() { Value = 30000, Label = "30 seconds" },
        new() { Value = 60000, Label = "1 minute" },
        new() { Value = 180000, Label = "3 minutes" },
        new() { Value = 300000, Label = "5 minutes" }
    };
    
    // ── Import/Export state ──
    private bool _showImportDialog;
    private string _importJson = "";
    private string _importName = "";
    private string _importError = "";
    private string _importPreviewName = "";
    private int _importPanelCount;
    
    private List<TimeRangeOption> TimeRanges = new()
    {
        new() { Value = "1m", Label = "Last 1m" },
        new() { Value = "5m", Label = "Last 5m" },
        new() { Value = "15m", Label = "Last 15m" },
        new() { Value = "30m", Label = "Last 30m" },
        new() { Value = "1h", Label = "Last 1h" },
        new() { Value = "6h", Label = "Last 6h" },
        new() { Value = "24h", Label = "Last 24h" }
    };
    
    private List<PanelTypeOption> PanelTypes = new()
    {
        new() { Value = PanelType.Stat, Label = "Single Stat" },
        new() { Value = PanelType.Gauge, Label = "Gauge" },
        new() { Value = PanelType.Table, Label = "Table" }
    };
    
    private List<TagOption> AvailableTags => ConfigService.GetAllTagsWithConnection()
        .Select(t => new TagOption { Id = t.Tag.Id, Name = $"{t.Connection.Name}/{t.Tag.Name}" })
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await ConfigService.LoadAllAsync();
        RealtimeData.OnDataChanged += HandleDataChanged;
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(DashboardId))
        {
            if (DashboardId == "new")
            {
                CurrentDashboard = new DashboardConfig
                {
                    Name = "New Dashboard",
                    OwnerId = AppState.CurrentUser?.Id
                };
                IsEditMode = true;
            }
            else
            {
                var dashboard = ConfigService.GetDashboard(DashboardId);
                if (dashboard != null)
                {
                    CurrentDashboard = dashboard;
                }
            }
            StartRefreshTimer();
        }
        else
        {
            StopRefreshTimer();
        }
    }

    private void StartRefreshTimer()
    {
        StopRefreshTimer();
        _refreshTimer = new System.Timers.Timer(CurrentDashboard.Settings.RefreshIntervalMs);
        _refreshTimer.Elapsed += (s, e) => InvokeAsync(StateHasChanged);
        _refreshTimer.Start();
    }

    private void StopRefreshTimer()
    {
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
        _refreshTimer = null;
    }

    private void HandleDataChanged() => InvokeAsync(StateHasChanged);
    
    private async Task OnPanelResized(Syncfusion.Blazor.Layouts.ResizeArgs args)
    {
        // Increment version for each resized panel to force chart re-render via @key
        if (!string.IsNullOrEmpty(args.Id))
        {
            _panelResizeVersions[args.Id] = _panelResizeVersions.GetValueOrDefault(args.Id, 0) + 1;
        }
        
        // Sync panel positions/sizes from the layout component to our model and save
        await SyncPanelLayoutAndSave();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task OnLayoutChanged(Syncfusion.Blazor.Layouts.ChangeEventArgs args)
    {
        // Sync panel positions/sizes from the layout component to our model and save
        await SyncPanelLayoutAndSave();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task SyncPanelLayoutAndSave()
    {
        // Only save layout changes when in edit mode
        if (DashboardLayout == null || !IsEditMode) return;
        
        try
        {
            // Get the current panel state from the SfDashboardLayout
            var panelObjects = await DashboardLayout.Serialize();
            
            Console.WriteLine($"SyncPanelLayoutAndSave: Got {panelObjects?.Count ?? 0} panels from Serialize()");
            
            // panelObjects is a list of panel data with Row, Column, SizeX, SizeY
            foreach (var panelObj in panelObjects)
            {
                // Extract ID and position from serialized panel
                var id = panelObj.Id;
                var panel = CurrentDashboard.Panels.FirstOrDefault(p => p.Id == id);
                if (panel != null)
                {
                    Console.WriteLine($"  Panel '{id}': Row={panelObj.Row}, Col={panelObj.Column}, W={panelObj.SizeX}, H={panelObj.SizeY}");
                    panel.GridX = (int)panelObj.Column;
                    panel.GridY = (int)panelObj.Row;
                    panel.GridWidth = (int)panelObj.SizeX;
                    panel.GridHeight = (int)panelObj.SizeY;
                }
            }
            
            // Save the updated dashboard
            Console.WriteLine($"Saving dashboard '{CurrentDashboard.Id}' with {CurrentDashboard.Panels.Count} panels");
            await ConfigService.UpdateDashboardAsync(CurrentDashboard);
            Console.WriteLine("Dashboard saved successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error syncing panel layout: {ex.Message}");
        }
    }
    
    private int GetPanelResizeVersion(string panelId) 
        => _panelResizeVersions.GetValueOrDefault(panelId, 0);

    private void CreateNewDashboard() => Navigation.NavigateTo("/dashboards/new");
    private void ViewDashboard(string id) => Navigation.NavigateTo($"/dashboards/{id}");
    private void EditDashboard(string id) { Navigation.NavigateTo($"/dashboards/{id}"); IsEditMode = true; }
    private void GoBack() => Navigation.NavigateTo("/dashboards");
    
    private async Task EnterEditMode()
    {
        if (!AppState.IsOwner(CurrentDashboard.OwnerId))
        {
            if (DataForeman.App.Components.Layout.MainLayout.Instance is { } l)
                await l.ShowToastAsync("Only the owner can edit this dashboard", "e-toast-warning", "Permission Denied");
            return;
        }
        IsEditMode = true;
    }
    private void ExitEditMode() => IsEditMode = false;
    private void ToggleFullscreen() => IsFullscreen = !IsFullscreen;
    private void RefreshData() => StateHasChanged();
    
    private void SelectPanel(DashboardPanel panel)
    {
        if (IsEditMode)
            SelectedPanel = SelectedPanel?.Id == panel.Id ? null : panel;
    }
    
    private void ShowAddPanel()
    {
        NewPanelType = PanelType.Stat;
        NewPanelTitle = "";
        ShowAddPanelDialog = true;
    }
    
    private void ShowChartLibrary()
    {
        ChartLibrarySearch = "";
        ShowChartLibraryDialog = true;
    }
    
    private void ShowFlowLibrary()
    {
        FlowLibrarySearch = "";
        ShowFlowLibraryDialog = true;
    }
    
    /// <summary>
    /// Adds a flow widget to the dashboard — mirrors React's addFlowWidget(flowId).
    /// </summary>
    private void AddFlowWidget(string flowId)
    {
        var flow = ConfigService.Flows.FirstOrDefault(f => f.Id == flowId);
        if (flow == null) return;
        
        var panel = new DashboardPanel
        {
            Title = flow.Name,
            Type = PanelType.Flow,
            GridX = 0,
            GridY = CurrentDashboard.Panels.Count > 0 
                ? CurrentDashboard.Panels.Max(p => p.GridY + p.GridHeight) 
                : 0,
            GridWidth = 4,
            GridHeight = 3,
            FlowConfig = new FlowPanelConfig { FlowId = flowId }
        };
        
        CurrentDashboard.Panels.Add(panel);
        ShowFlowLibraryDialog = false;
    }
    
    private async Task TriggerFlow(string flowId)
    {
        var topic = DataForeman.Shared.Mqtt.MqttTopics.GetFlowManualTriggerTopic(flowId);
        await MqttService.PublishMessageAsync(topic, "{}");
    }
    
    /// <summary>
    /// Adds a chart widget from the Chart Library — mirrors React's addWidget(chartId).
    /// Does NOT close the library so users can add multiple charts.
    /// </summary>
    private void AddChartWidget(string chartId)
    {
        var chart = ConfigService.Charts.FirstOrDefault(c => c.Id == chartId);
        if (chart == null) return;
        
        var panel = new DashboardPanel
        {
            Title = chart.Name,
            Type = PanelType.Chart,
            ChartRefId = chartId,
            GridX = 0,
            GridY = CurrentDashboard.Panels.Count > 0 
                ? CurrentDashboard.Panels.Max(p => p.GridY + p.GridHeight) 
                : 0,
            GridWidth = 6,
            GridHeight = 4,
            ChartConfig = BuildChartPanelConfig(chartId)
        };
        
        CurrentDashboard.Panels.Add(panel);
    }
    
    private void AddPanel()
    {
        var panel = new DashboardPanel
        {
            Title = string.IsNullOrEmpty(NewPanelTitle) ? NewPanelType.ToString() : NewPanelTitle,
            Type = NewPanelType,
            GridX = 0,
            GridY = CurrentDashboard.Panels.Count > 0 
                ? CurrentDashboard.Panels.Max(p => p.GridY + p.GridHeight) 
                : 0,
            GridWidth = NewPanelType == PanelType.Table ? 12 : 4,
            GridHeight = 2
        };
        
        // Initialize panel-specific config
        switch (NewPanelType)
        {
            case PanelType.Stat:
                panel.StatConfig = new StatPanelConfig();
                break;
            case PanelType.Gauge:
                panel.GaugeConfig = new GaugePanelConfig();
                break;
            case PanelType.Table:
                panel.TableConfig = new TablePanelConfig();
                break;
        }
        
        CurrentDashboard.Panels.Add(panel);
        ShowAddPanelDialog = false;
    }
    
    /// <summary>
    /// Builds a ChartPanelConfig from a pre-configured chart, or returns empty config if not found.
    /// </summary>
    private ChartPanelConfig BuildChartPanelConfig(string? chartId)
    {
        if (string.IsNullOrEmpty(chartId)) return new ChartPanelConfig();
        
        var chart = ConfigService.Charts.FirstOrDefault(c => c.Id == chartId);
        if (chart == null) return new ChartPanelConfig();
        
        return new ChartPanelConfig
        {
            ChartType = chart.ChartType,
            ShowLegend = chart.Settings.ShowLegend,
            LegendPosition = chart.Settings.LegendPosition,
            EnableZoom = chart.Settings.EnableZoom,
            FillArea = chart.ChartType == "Area",
            DataSources = chart.Series.Select(s => new PanelDataSource
            {
                TagId = s.TagId,
                DisplayName = s.DisplayName,
                Color = s.Color,
                YAxisId = s.YAxisId,
                LineWidth = s.LineWidth
            }).ToList(),
            YAxes = chart.YAxes.Select(a => new ChartAxisConfig
            {
                Id = a.Id,
                Name = a.Name,
                Position = a.Position,
                Minimum = a.Minimum,
                Maximum = a.Maximum,
                Unit = a.Unit,
                Color = a.Color,
                AutoScale = a.AutoScale,
                LabelFormat = a.LabelFormat
            }).ToList()
        };
    }
    
    private void ConfigurePanel(DashboardPanel panel)
    {
        ConfiguringPanel = panel;
        ShowPanelConfigDialog = true;
    }
    
    private void RemovePanel(DashboardPanel panel)
    {
        CurrentDashboard.Panels.Remove(panel);
        if (SelectedPanel?.Id == panel.Id)
            SelectedPanel = null;
    }

    private async Task SaveDashboard()
    {
        if (!AppState.IsOwner(CurrentDashboard.OwnerId))
        {
            if (DataForeman.App.Components.Layout.MainLayout.Instance is { } l)
                await l.ShowToastAsync("Only the owner can save this dashboard", "e-toast-warning", "Permission Denied");
            return;
        }

        // Sync panel positions/sizes from the layout component before saving
        if (DashboardLayout != null && DashboardId != "new")
        {
            try
            {
                var panelObjects = await DashboardLayout.Serialize();
                foreach (var panelObj in panelObjects)
                {
                    var panel = CurrentDashboard.Panels.FirstOrDefault(p => p.Id == panelObj.Id);
                    if (panel != null)
                    {
                        panel.GridX = (int)panelObj.Column;
                        panel.GridY = (int)panelObj.Row;
                        panel.GridWidth = (int)panelObj.SizeX;
                        panel.GridHeight = (int)panelObj.SizeY;
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error syncing panel layout: {ex.Message}");
            }
        }
        
        // UpdatedAt is set in the service layer
        if (DashboardId == "new")
            await ConfigService.AddDashboardAsync(CurrentDashboard);
        else
            await ConfigService.UpdateDashboardAsync(CurrentDashboard);
        
        if (DashboardId == "new")
            Navigation.NavigateTo($"/dashboards/{CurrentDashboard.Id}", replace: true);

        if (DataForeman.App.Components.Layout.MainLayout.Instance is { } layout)
            await layout.ShowToastAsync("Dashboard saved", "e-toast-success", "Saved");
    }

    private async Task ConfirmDeleteDashboard(string id)
    {
        var dashboard = ConfigService.GetDashboard(id);
        if (dashboard != null && !AppState.IsOwner(dashboard.OwnerId))
        {
            if (DataForeman.App.Components.Layout.MainLayout.Instance is { } l)
                await l.ShowToastAsync("Only the owner can delete this dashboard", "e-toast-warning", "Permission Denied");
            return;
        }
        DeleteDashboardId = id;
        ShowDeleteDialog = true;
    }

    private async Task ExecuteDeleteDashboard()
    {
        var dashboard = ConfigService.GetDashboard(DeleteDashboardId);
        if (dashboard != null && !AppState.IsOwner(dashboard.OwnerId))
        {
            if (DataForeman.App.Components.Layout.MainLayout.Instance is { } l)
                await l.ShowToastAsync("Only the owner can delete this dashboard", "e-toast-warning", "Permission Denied");
            ShowDeleteDialog = false;
            return;
        }

        await ConfigService.DeleteDashboardAsync(DeleteDashboardId);
        ShowDeleteDialog = false;
    }

    // Panel config helpers
    private void SetStatTag(string tagId)
    {
        if (ConfiguringPanel?.StatConfig != null)
            ConfiguringPanel.StatConfig.TagId = tagId;
    }
    private void SetStatUnit(string unit)
    {
        if (ConfiguringPanel?.StatConfig != null)
            ConfiguringPanel.StatConfig.Unit = unit;
    }
    private void SetStatDecimals(int decimals)
    {
        if (ConfiguringPanel?.StatConfig != null)
            ConfiguringPanel.StatConfig.Decimals = decimals;
    }
    private void SetStatSparkline(bool show)
    {
        if (ConfiguringPanel?.StatConfig != null)
            ConfiguringPanel.StatConfig.ShowSparkline = show;
    }
    private void SetGaugeTag(string tagId)
    {
        if (ConfiguringPanel?.GaugeConfig != null)
            ConfiguringPanel.GaugeConfig.TagId = tagId;
    }
    private void SetGaugeMin(double min)
    {
        if (ConfiguringPanel?.GaugeConfig != null)
            ConfiguringPanel.GaugeConfig.MinValue = min;
    }
    private void SetGaugeMax(double max)
    {
        if (ConfiguringPanel?.GaugeConfig != null)
            ConfiguringPanel.GaugeConfig.MaxValue = max;
    }
    private void ToggleChartDataSource(string tagId, bool include)
    {
        if (ConfiguringPanel?.ChartConfig == null) return;
        ConfiguringPanel.ChartConfig.DataSources ??= new();
        if (include)
        {
            if (!ConfiguringPanel.ChartConfig.DataSources.Any(d => d.TagId == tagId))
            {
                var tag = AvailableTags.FirstOrDefault(t => t.Id == tagId);
                var colors = new[] { "#3b82f6", "#22c55e", "#f59e0b", "#ef4444", "#8b5cf6" };
                ConfiguringPanel.ChartConfig.DataSources.Add(new PanelDataSource
                {
                    TagId = tagId,
                    DisplayName = tag?.Name ?? tagId,
                    Color = colors[ConfiguringPanel.ChartConfig.DataSources.Count % colors.Length]
                });
            }
        }
        else
        {
            ConfiguringPanel.ChartConfig.DataSources.RemoveAll(d => d.TagId == tagId);
        }
    }
    private void ToggleTableTag(string tagId, bool include)
    {
        if (ConfiguringPanel?.TableConfig == null) return;
        ConfiguringPanel.TableConfig.TagIds ??= new();
        if (include)
        {
            if (!ConfiguringPanel.TableConfig.TagIds.Contains(tagId))
                ConfiguringPanel.TableConfig.TagIds.Add(tagId);
        }
        else
        {
            ConfiguringPanel.TableConfig.TagIds.Remove(tagId);
        }
    }

    // Panel rendering
    private RenderFragment RenderPanel(DashboardPanel panel) => builder =>
    {
        switch (panel.Type)
        {
            case PanelType.Stat:
                RenderStatPanel(builder, panel);
                break;
            case PanelType.Gauge:
                RenderGaugePanel(builder, panel);
                break;
            case PanelType.Chart:
                RenderChartPanel(builder, panel);
                break;
            case PanelType.Table:
                RenderTablePanel(builder, panel);
                break;
            case PanelType.Flow:
                RenderFlowPanel(builder, panel);
                break;
        }
    };

    private void RenderStatPanel(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, DashboardPanel panel)
    {
        var config = panel.StatConfig;
        if (config == null) return;
        
        var tagValue = RealtimeData.GetTagValue(config.TagId);
        var value = tagValue?.NumericValue ?? 0;
        var color = GetThresholdColor(config.Thresholds, value);
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "stat-panel");
        
        if (!string.IsNullOrEmpty(config.Icon))
        {
            builder.OpenElement(2, "i");
            builder.AddAttribute(3, "class", $"{config.Icon} stat-icon");
            builder.AddAttribute(4, "style", $"color: {color}");
            builder.CloseElement();
        }
        
        builder.OpenElement(5, "div");
        builder.AddAttribute(6, "class", "stat-value");
        builder.AddAttribute(7, "style", $"color: {color}");
        builder.AddContent(8, value.ToString($"F{config.Decimals}"));
        builder.CloseElement();
        
        if (!string.IsNullOrEmpty(config.Unit))
        {
            builder.OpenElement(9, "div");
            builder.AddAttribute(10, "class", "stat-unit");
            builder.AddContent(11, config.Unit);
            builder.CloseElement();
        }
        
        builder.CloseElement();
    }

    private void RenderGaugePanel(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, DashboardPanel panel)
    {
        var config = panel.GaugeConfig;
        if (config == null) return;
        
        var tagValue = RealtimeData.GetTagValue(config.TagId);
        var value = tagValue?.NumericValue ?? 0;
        var color = GetThresholdColor(config.Thresholds, value);
        
        // Syncfusion Circular Gauge
        builder.OpenComponent<SfCircularGauge>(0);
        builder.AddAttribute(1, "Theme", Syncfusion.Blazor.Theme.TailwindDark);
        builder.AddAttribute(2, "Height", "100%");
        builder.AddAttribute(3, "Width", "100%");
        builder.AddAttribute(4, "Background", "transparent");
        builder.AddAttribute(5, "ChildContent", (RenderFragment)(gaugeBuilder =>
        {
            // Axes collection
            gaugeBuilder.OpenComponent<CircularGaugeAxes>(0);
            gaugeBuilder.AddAttribute(1, "ChildContent", (RenderFragment)(axesBuilder =>
            {
                axesBuilder.OpenComponent<CircularGaugeAxis>(0);
                axesBuilder.AddAttribute(1, "StartAngle", 220.0);
                axesBuilder.AddAttribute(2, "EndAngle", 140.0);
                axesBuilder.AddAttribute(3, "Minimum", config.MinValue);
                axesBuilder.AddAttribute(4, "Maximum", config.MaxValue);
                axesBuilder.AddAttribute(5, "Radius", "80%");
                axesBuilder.AddAttribute(6, "ChildContent", (RenderFragment)(axisBuilder =>
                {
                    // Line style
                    axisBuilder.OpenComponent<CircularGaugeAxisLineStyle>(0);
                    axisBuilder.AddAttribute(1, "Width", 0.0);
                    axisBuilder.CloseComponent();
                    
                    // Labels
                    axisBuilder.OpenComponent<CircularGaugeAxisLabelStyle>(0);
                    axisBuilder.AddAttribute(1, "Offset", -10d);
                    axisBuilder.AddAttribute(2, "ChildContent", (RenderFragment)(labelBuilder =>
                    {
                        labelBuilder.OpenComponent<CircularGaugeAxisLabelFont>(0);
                        labelBuilder.AddAttribute(1, "Size", "11px");
                        labelBuilder.AddAttribute(2, "Color", "#94a3b8");
                        labelBuilder.AddAttribute(3, "FontFamily", "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif");
                        labelBuilder.CloseComponent();
                    }));
                    axisBuilder.CloseComponent();
                    
                    // Major ticks
                    axisBuilder.OpenComponent<CircularGaugeAxisMajorTicks>(0);
                    axisBuilder.AddAttribute(1, "Height", 10d);
                    axisBuilder.AddAttribute(2, "Offset", 5d);
                    axisBuilder.AddAttribute(3, "Color", "#475569");
                    axisBuilder.CloseComponent();
                    
                    // Minor ticks
                    axisBuilder.OpenComponent<CircularGaugeAxisMinorTicks>(0);
                    axisBuilder.AddAttribute(1, "Height", 5d);
                    axisBuilder.AddAttribute(2, "Offset", 5d);
                    axisBuilder.AddAttribute(3, "Color", "#334155");
                    axisBuilder.CloseComponent();
                    
                    // Ranges collection
                    axisBuilder.OpenComponent<CircularGaugeRanges>(0);
                    axisBuilder.AddAttribute(1, "ChildContent", (RenderFragment)(rangesBuilder =>
                    {
                        // Background range
                        rangesBuilder.OpenComponent<CircularGaugeRange>(0);
                        rangesBuilder.AddAttribute(1, "Start", config.MinValue);
                        rangesBuilder.AddAttribute(2, "End", config.MaxValue);
                        rangesBuilder.AddAttribute(3, "Color", "#1e293b");
                        rangesBuilder.AddAttribute(4, "StartWidth", "18");
                        rangesBuilder.AddAttribute(5, "EndWidth", "18");
                        rangesBuilder.AddAttribute(6, "Radius", "90%");
                        rangesBuilder.CloseComponent();
                        
                        // Value range
                        rangesBuilder.OpenComponent<CircularGaugeRange>(0);
                        rangesBuilder.AddAttribute(1, "Start", config.MinValue);
                        rangesBuilder.AddAttribute(2, "End", value);
                        rangesBuilder.AddAttribute(3, "Color", color);
                        rangesBuilder.AddAttribute(4, "StartWidth", "18");
                        rangesBuilder.AddAttribute(5, "EndWidth", "18");
                        rangesBuilder.AddAttribute(6, "Radius", "90%");
                        rangesBuilder.CloseComponent();
                    }));
                    axisBuilder.CloseComponent();
                    
                    // Pointers collection
                    axisBuilder.OpenComponent<CircularGaugePointers>(0);
                    axisBuilder.AddAttribute(1, "ChildContent", (RenderFragment)(pointersBuilder =>
                    {
                        pointersBuilder.OpenComponent<CircularGaugePointer>(0);
                        pointersBuilder.AddAttribute(1, "Value", value);
                        pointersBuilder.AddAttribute(2, "Radius", "60%");
                        pointersBuilder.AddAttribute(3, "Color", color);
                        pointersBuilder.AddAttribute(4, "PointerWidth", 8.0);
                        pointersBuilder.AddAttribute(5, "ChildContent", (RenderFragment)(ptrBuilder =>
                        {
                            ptrBuilder.OpenComponent<CircularGaugePointerAnimation>(0);
                            ptrBuilder.AddAttribute(1, "Enable", false);
                            ptrBuilder.CloseComponent();
                            
                            ptrBuilder.OpenComponent<CircularGaugeCap>(0);
                            ptrBuilder.AddAttribute(1, "Radius", 8.0);
                            ptrBuilder.AddAttribute(2, "Color", color);
                            ptrBuilder.AddAttribute(3, "ChildContent", (RenderFragment)(capBuilder =>
                            {
                                capBuilder.OpenComponent<CircularGaugeCapBorder>(0);
                                capBuilder.AddAttribute(1, "Width", 0.0);
                                capBuilder.CloseComponent();
                            }));
                            ptrBuilder.CloseComponent();
                        }));
                        pointersBuilder.CloseComponent();
                    }));
                    axisBuilder.CloseComponent();
                    
                    // Annotations for value display
                    axisBuilder.OpenComponent<CircularGaugeAnnotations>(0);
                    axisBuilder.AddAttribute(1, "ChildContent", (RenderFragment)(annotationsBuilder =>
                    {
                        annotationsBuilder.OpenComponent<CircularGaugeAnnotation>(0);
                        annotationsBuilder.AddAttribute(1, "Angle", 0.0);
                        annotationsBuilder.AddAttribute(2, "Radius", "0%");
                        annotationsBuilder.AddAttribute(3, "ZIndex", "1");
                        var format = $"F{config.Decimals}";
                        var displayValue = $"{value.ToString(format)}{config.Unit}";
                        annotationsBuilder.AddAttribute(4, "ContentTemplate", (RenderFragment)(annBuilder =>
                        {
                            annBuilder.OpenElement(0, "div");
                            annBuilder.AddAttribute(1, "style", $"color: {color}; font-size: 1.5rem; font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;");
                            annBuilder.AddContent(2, displayValue);
                            annBuilder.CloseElement();
                        }));
                        annotationsBuilder.CloseComponent();
                    }));
                    axisBuilder.CloseComponent();
                }));
                axesBuilder.CloseComponent();
            }));
            gaugeBuilder.CloseComponent();
        }));
        builder.CloseComponent();
    }

    private void RenderChartPanel(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, DashboardPanel panel)
    {
        var config = panel.ChartConfig;
        if (config?.DataSources == null || !config.DataSources.Any()) 
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "empty-panel");
            builder.AddContent(2, "No data sources configured");
            builder.CloseElement();
            return;
        }
        
        // Use @key based on resize version to force re-render when panel is resized
        var resizeVersion = GetPanelResizeVersion(panel.Id);
        builder.OpenComponent<SfChart>(0);
        builder.SetKey($"{panel.Id}-{resizeVersion}");
        builder.AddAttribute(1, "Theme", Syncfusion.Blazor.Theme.TailwindDark);
        builder.AddAttribute(2, "Height", "100%");
        builder.AddAttribute(3, "Width", "100%");
        builder.AddAttribute(4, "ChildContent", (RenderFragment)(chartBuilder =>
        {
            chartBuilder.OpenComponent<ChartPrimaryXAxis>(0);
            chartBuilder.AddAttribute(1, "ValueType", Syncfusion.Blazor.Charts.ValueType.DateTime);
            chartBuilder.AddAttribute(2, "LabelFormat", "HH:mm:ss");
            chartBuilder.CloseComponent();
            
            chartBuilder.OpenComponent<ChartSeriesCollection>(0);
            chartBuilder.AddAttribute(1, "ChildContent", (RenderFragment)(seriesCollBuilder =>
            {
                foreach (var ds in config.DataSources)
                {
                    var data = GetChartData(ds.TagId);
                    seriesCollBuilder.OpenComponent<Syncfusion.Blazor.Charts.ChartSeries>(0);
                    seriesCollBuilder.AddAttribute(1, "DataSource", data);
                    seriesCollBuilder.AddAttribute(2, "XName", "Timestamp");
                    seriesCollBuilder.AddAttribute(3, "YName", "Value");
                    seriesCollBuilder.AddAttribute(4, "Name", ds.DisplayName);
                    seriesCollBuilder.AddAttribute(5, "Type", ChartSeriesType.Line);
                    seriesCollBuilder.AddAttribute(6, "Fill", ds.Color);
                    seriesCollBuilder.AddAttribute(7, "Width", ds.LineWidth);
                    seriesCollBuilder.CloseComponent();
                }
            }));
            chartBuilder.CloseComponent();
            
            chartBuilder.OpenComponent<ChartLegendSettings>(0);
            chartBuilder.AddAttribute(1, "Visible", config.ShowLegend);
            chartBuilder.CloseComponent();
            
            chartBuilder.OpenComponent<ChartTooltipSettings>(0);
            chartBuilder.AddAttribute(1, "Enable", true);
            chartBuilder.CloseComponent();
        }));
        builder.CloseComponent();
    }

    private void RenderTablePanel(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, DashboardPanel panel)
    {
        var config = panel.TableConfig;
        if (config?.TagIds == null || !config.TagIds.Any())
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "empty-panel");
            builder.AddContent(2, "No tags configured");
            builder.CloseElement();
            return;
        }
        
        var data = config.TagIds
            .Select(id => RealtimeData.GetTagValue(id))
            .Where(v => v != null)
            .Take(config.MaxRows)
            .ToList();
        
        builder.OpenComponent<SfGrid<DataForeman.App.Services.TagValueCache>>(0);
        builder.AddAttribute(1, "DataSource", data);
        builder.AddAttribute(2, "ChildContent", (RenderFragment)(gridBuilder =>
        {
            gridBuilder.OpenComponent<GridColumns>(0);
            gridBuilder.AddAttribute(1, "ChildContent", (RenderFragment)(colsBuilder =>
            {
                colsBuilder.OpenComponent<GridColumn>(0);
                colsBuilder.AddAttribute(1, "Field", "TagName");
                colsBuilder.AddAttribute(2, "HeaderText", "Tag");
                colsBuilder.CloseComponent();
                
                colsBuilder.OpenComponent<GridColumn>(0);
                colsBuilder.AddAttribute(1, "Field", "FormattedValue");
                colsBuilder.AddAttribute(2, "HeaderText", "Value");
                colsBuilder.CloseComponent();
                
                if (config.ShowTimestamp)
                {
                    colsBuilder.OpenComponent<GridColumn>(0);
                    colsBuilder.AddAttribute(1, "Field", "Timestamp");
                    colsBuilder.AddAttribute(2, "HeaderText", "Timestamp");
                    colsBuilder.AddAttribute(3, "Format", "HH:mm:ss.fff");
                    colsBuilder.CloseComponent();
                }
                
                if (config.ShowQuality)
                {
                    colsBuilder.OpenComponent<GridColumn>(0);
                    colsBuilder.AddAttribute(1, "Field", "QualityText");
                    colsBuilder.AddAttribute(2, "HeaderText", "Quality");
                    colsBuilder.CloseComponent();
                }
            }));
            gridBuilder.CloseComponent();
        }));
        builder.CloseComponent();
    }

    private void RenderFlowPanel(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, DashboardPanel panel)
    {
        var config = panel.FlowConfig;
        if (config == null) return;
        
        var flow = ConfigService.Flows.FirstOrDefault(f => f.Id == config.FlowId);
        var flowName = flow?.Name ?? config.FlowId;
        var flowDesc = flow?.Description ?? "";
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "flow-panel");
        
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "flow-panel-info");
        
        builder.OpenElement(4, "i");
        builder.AddAttribute(5, "class", "fa-solid fa-play");
        builder.AddAttribute(6, "style", "color:#8b5cf6;font-size:24px;");
        builder.CloseElement();
        
        builder.OpenElement(7, "div");
        builder.AddAttribute(8, "class", "flow-panel-name");
        builder.AddContent(9, flowName);
        builder.CloseElement();
        
        if (!string.IsNullOrEmpty(flowDesc))
        {
            builder.OpenElement(10, "div");
            builder.AddAttribute(11, "style", "font-size:11px;color:#888;margin-top:2px;");
            builder.AddContent(12, flowDesc);
            builder.CloseElement();
        }
        
        builder.CloseElement(); // flow-panel-info
        
        builder.OpenElement(13, "button");
        builder.AddAttribute(14, "class", "flow-trigger-btn");
        builder.AddAttribute(15, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create(this, () => TriggerFlow(config.FlowId)));
        builder.OpenElement(16, "i");
        builder.AddAttribute(17, "class", "fa-solid fa-play");
        builder.CloseElement();
        builder.AddContent(18, " Run");
        builder.CloseElement();
        
        builder.CloseElement(); // flow-panel
    }

    private string GetThresholdColor(List<GaugeThreshold>? thresholds, double value)
    {
        if (thresholds == null || !thresholds.Any())
            return "#3b82f6";
        
        var sorted = thresholds.OrderByDescending(t => t.Value).ToList();
        foreach (var threshold in sorted)
        {
            if (value >= threshold.Value)
                return threshold.Color;
        }
        return sorted.Last().Color;
    }

    private List<ChartDataPoint> GetChartData(string tagId)
    {
        var history = RealtimeData.GetTagHistoryForChart(tagId, GetTimeWindowSeconds());
        return history.Select(v => new ChartDataPoint
        {
            Timestamp = v.Timestamp,
            Value = v.NumericValue ?? 0
        }).ToList();
    }

    private int GetTimeWindowSeconds() => SelectedTimeRange switch
    {
        "1m" => 60,
        "5m" => 300,
        "15m" => 900,
        "30m" => 1800,
        "1h" => 3600,
        "6h" => 21600,
        "24h" => 86400,
        _ => 300
    };

    // ── TV Mode methods ──────────────────────────────────
    private void ShowTVModeDialog()
    {
        _tvSelectedDashboardIds = new List<string> { CurrentDashboard.Id };
        _showTVSettingsDialog = true;
    }

    private void ToggleTVDashboard(string id, bool include)
    {
        if (include && !_tvSelectedDashboardIds.Contains(id))
            _tvSelectedDashboardIds.Add(id);
        else if (!include)
            _tvSelectedDashboardIds.Remove(id);
    }

    private void StartTVMode()
    {
        _showTVSettingsDialog = false;
        _tvDashboards = ConfigService.Dashboards
            .Where(d => _tvSelectedDashboardIds.Contains(d.Id))
            .ToList();
        if (!_tvDashboards.Any()) return;

        _tvIndex = 0;
        _tvPaused = false;
        _tvModeActive = true;
        _tvControlsVisible = true;

        _tvTimer = new System.Timers.Timer(_tvRotationMs);
        _tvTimer.Elapsed += (s, e) =>
        {
            if (!_tvPaused && _tvDashboards.Count > 1)
            {
                _tvIndex = (_tvIndex + 1) % _tvDashboards.Count;
                InvokeAsync(StateHasChanged);
            }
        };
        _tvTimer.Start();
    }

    private void StopTVMode()
    {
        _tvModeActive = false;
        _tvTimer?.Stop();
        _tvTimer?.Dispose();
        _tvTimer = null;
    }

    private void TVPrev()
    {
        if (_tvDashboards.Count == 0) return;
        _tvIndex = (_tvIndex - 1 + _tvDashboards.Count) % _tvDashboards.Count;
    }

    private void TVNext()
    {
        if (_tvDashboards.Count == 0) return;
        _tvIndex = (_tvIndex + 1) % _tvDashboards.Count;
    }

    private void TVTogglePause() => _tvPaused = !_tvPaused;

    private DateTime _tvLastMouseMove = DateTime.MinValue;

    private void TVMouseMove()
    {
        var now = DateTime.UtcNow;
        if ((now - _tvLastMouseMove).TotalMilliseconds < 500) return;
        _tvLastMouseMove = now;
        _tvControlsVisible = true;
    }

    private void TVKeyDown(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "Escape": StopTVMode(); break;
            case " ": TVTogglePause(); break;
            case "ArrowLeft": TVPrev(); break;
            case "ArrowRight": TVNext(); break;
        }
    }

    // ── Export/Import methods ─────────────────────────────
    private async Task ExportDashboard()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(CurrentDashboard, new System.Text.Json.JsonSerializerOptions
        {
            WriteIndented = true,
            PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
        });
        var safeName = System.Text.RegularExpressions.Regex.Replace(CurrentDashboard.Name, @"[^a-zA-Z0-9_\-]", "-");
        var fileName = $"{safeName}-{DateTime.Now:yyyyMMdd-HHmm}.json";
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("dataforeman.downloadJson", fileName, base64);
    }

    private void ShowImportDialog()
    {
        _importJson = "";
        _importName = "";
        _importError = "";
        _importPreviewName = "";
        _importPanelCount = 0;
        _showImportDialog = true;
    }

    private void ResetImport()
    {
        _importJson = "";
        _importError = "";
    }

    private void ValidateImport()
    {
        try
        {
            var dashboard = System.Text.Json.JsonSerializer.Deserialize<DashboardConfig>(_importJson,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (dashboard == null)
            {
                _importError = "Invalid JSON: could not parse dashboard";
                return;
            }

            _importPreviewName = dashboard.Name ?? "Unnamed";
            _importName = dashboard.Name ?? "Imported Dashboard";
            _importPanelCount = dashboard.Panels?.Count ?? 0;
            _importError = "";
        }
        catch (System.Text.Json.JsonException ex)
        {
            _importError = $"Invalid JSON: {ex.Message}";
        }
    }

    private async Task ExecuteImport()
    {
        try
        {
            var dashboard = System.Text.Json.JsonSerializer.Deserialize<DashboardConfig>(_importJson,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (dashboard == null) return;

            dashboard.Id = Guid.NewGuid().ToString();
            dashboard.Name = _importName;
            dashboard.CreatedAt = DateTime.UtcNow;
            dashboard.UpdatedAt = DateTime.UtcNow;

            foreach (var panel in dashboard.Panels)
                panel.Id = Guid.NewGuid().ToString();

            await ConfigService.AddDashboardAsync(dashboard);
            _showImportDialog = false;

            if (DataForeman.App.Components.Layout.MainLayout.Instance is { } layout)
                await layout.ShowToastAsync($"Dashboard \"{_importName}\" imported", "e-toast-success", "Imported");

            Navigation.NavigateTo($"/dashboards/{dashboard.Id}");
        }
        catch (Exception ex)
        {
            _importError = $"Import failed: {ex.Message}";
        }
    }

    public void Dispose()
    {
        RealtimeData.OnDataChanged -= HandleDataChanged;
        StopRefreshTimer();
        StopTVMode();
    }

    public class TimeRangeOption { public string Value { get; set; } = ""; public string Label { get; set; } = ""; }
    public class PanelTypeOption { public PanelType Value { get; set; } public string Label { get; set; } = ""; }
    public class TagOption { public string Id { get; set; } = ""; public string Name { get; set; } = ""; }
    public class ChartDataPoint { public DateTime Timestamp { get; set; } public double Value { get; set; } }
    public class TVIntervalOption { public int Value { get; set; } public string Label { get; set; } = ""; }
}
