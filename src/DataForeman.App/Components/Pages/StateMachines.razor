@page "/state-machines"
@page "/state-machines/{StateMachineId}"
@rendermode InteractiveServer
@inject ConfigService ConfigService
@inject RealtimeDataService RealtimeData
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>State Machines - DataForeman</PageTitle>

<div class="page-container">
    @if (string.IsNullOrEmpty(StateMachineId))
    {
        <div class="page-toolbar">
            <h2><i class="fa-solid fa-diagram-project"></i> State Machines</h2>
            <div class="toolbar-actions">
                <SfButton CssClass="e-primary" IconCss="fa-solid fa-plus" @onclick="CreateNewStateMachine">New State Machine</SfButton>
            </div>
        </div>
        
        @if (!ConfigService.StateMachines.Any())
        {
            <div class="empty-state">
                <i class="fa-solid fa-diagram-project"></i>
                <span>No state machines configured</span>
                <SfButton CssClass="e-primary e-small" @onclick="CreateNewStateMachine">Create your first state machine</SfButton>
            </div>
        }
        else
        {
            <SfGrid DataSource="@StateMachinesList" AllowPaging="true">
                <GridPageSettings PageSize="10"></GridPageSettings>
                <GridColumns>
                    <GridColumn Field="@nameof(StateMachineDisplay.Name)" HeaderText="Name" Width="200"></GridColumn>
                    <GridColumn Field="@nameof(StateMachineDisplay.Description)" HeaderText="Description" Width="300"></GridColumn>
                    <GridColumn Field="@nameof(StateMachineDisplay.StateCount)" HeaderText="States" Width="80"></GridColumn>
                    <GridColumn HeaderText="Status" Width="100">
                        <Template>
                            @{
                                var item = (context as StateMachineDisplay);
                                <span class="status-indicator @(item?.Enabled == true ? "enabled" : "disabled")">
                                    <i class="fa-solid fa-circle"></i> @(item?.Enabled == true ? "Enabled" : "Disabled")
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn HeaderText="Actions" Width="120">
                        <Template>
                            @{
                                var item = (context as StateMachineDisplay);
                                <div class="action-buttons">
                                    <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-pen" @onclick="() => EditStateMachine(item!.Id)"></SfButton>
                                    <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-trash" @onclick="() => ConfirmDeleteStateMachine(item!.Id)"></SfButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        }
    }
    else
    {
        <div class="state-machine-editor" @key="@StateMachineId">
            <div class="editor-toolbar">
                <SfButton CssClass="e-flat" IconCss="fa-solid fa-arrow-left" @onclick="GoBack"></SfButton>
                <SfTextBox @bind-Value="CurrentStateMachine.Name" Placeholder="State Machine Name" CssClass="state-machine-name-input"></SfTextBox>
                <div class="toolbar-spacer"></div>
                <SfButton CssClass="@(CurrentStateMachine.Enabled ? "e-warning" : "e-success")" 
                          IconCss="@(CurrentStateMachine.Enabled ? "fa-solid fa-pause" : "fa-solid fa-play")"
                          Content="@(CurrentStateMachine.Enabled ? "Disable" : "Enable")"
                          @onclick="ToggleEnabled"></SfButton>
                <SfButton CssClass="e-primary" IconCss="fa-solid fa-floppy-disk" @onclick="SaveStateMachine">Save</SfButton>
            </div>
            
            <div class="editor-content">
                <div class="state-palette">
                    <div class="palette-header">STATE PALETTE</div>
                    <div class="palette-item" draggable="true" @ondragstart="() => OnPaletteDragStart(StateType.Normal)">
                        <i class="fa-solid fa-circle" style="color: #3b82f6;"></i>
                        <span>State</span>
                    </div>
                    <div class="palette-item" draggable="true" @ondragstart="() => OnPaletteDragStart(StateType.Initial)">
                        <i class="fa-solid fa-play-circle" style="color: #22c55e;"></i>
                        <span>Initial State</span>
                    </div>
                    <div class="palette-item" draggable="true" @ondragstart="() => OnPaletteDragStart(StateType.Final)">
                        <i class="fa-solid fa-stop-circle" style="color: #ef4444;"></i>
                        <span>Final State</span>
                    </div>
                </div>
                
                <div class="diagram-container" 
                     id="state-diagram-space"
                     @ondragover="OnDiagramDragOver"
                     @ondragover:preventDefault="true"
                     @ondrop="OnDiagramDrop"
                     @ondrop:preventDefault="true">
                    <SfDiagramComponent @ref="StateDiagram" 
                                        ID="state-diagram"
                                        Width="100%" 
                                        Height="100%"
                                        Nodes="@StateNodes"
                                        Connectors="@StateConnectors"
                                        NodeCreating="@OnNodeCreating"
                                        ConnectorCreating="@OnConnectorCreating"
                                        SelectionChanged="@OnSelectionChanged"
                                        ConnectionChanged="@OnConnectionChanged">
                        <SnapSettings>
                            <HorizontalGridLines LineColor="#3a4049" LineDashArray="2,4"></HorizontalGridLines>
                            <VerticalGridLines LineColor="#3a4049" LineDashArray="2,4"></VerticalGridLines>
                        </SnapSettings>
                        <ScrollSettings ScrollLimit="ScrollLimitMode.Diagram"></ScrollSettings>
                    </SfDiagramComponent>
                </div>
                
                <div class="properties-panel">
                    <div class="panel-header">PROPERTIES</div>
                    <div class="panel-content">
                        @if (SelectedStateNode != null)
                        {
                            <div class="form-group">
                                <label>State Name</label>
                                <SfTextBox @bind-Value="SelectedStateName" Placeholder="State name" @onchange="OnStateNameChanged"></SfTextBox>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <SfTextBox @bind-Value="SelectedStateDescription" Placeholder="State description" Multiline="true"></SfTextBox>
                            </div>
                            <div class="form-group">
                                <label>Color</label>
                                <input type="color" @bind="SelectedStateColor" class="color-picker" />
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" @bind="SelectedStateIsInitial" @bind:after="OnStateTypeChanged" />
                                    Initial State
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" @bind="SelectedStateIsFinal" @bind:after="OnStateTypeChanged" />
                                    Final State
                                </label>
                            </div>
                            
                            @* ── On-Enter Actions ────────────────── *@
                            <div class="panel-header" style="margin-top:12px;">ON ENTER ACTIONS</div>
                            <div class="info-panel" style="font-size:11px; color:#9ca3af; margin-bottom:4px;">Tag writes executed when entering this state</div>
                            @if (SelectedMachineState != null)
                            {
                                @for (int idx = 0; idx < SelectedMachineState.OnEnterActions.Count; idx++)
                                {
                                    var actionIdx = idx;
                                    var act = SelectedMachineState.OnEnterActions[actionIdx];
                                    <div style="display:flex; gap:4px; margin-bottom:4px; align-items:center;">
                                        <SfDropDownList TItem="string" TValue="string" @bind-Value="act.TagPath" DataSource="@_availableTagPaths"
                                                        Placeholder="Tag" AllowFiltering="true" PopupWidth="220px" CssClass="e-small" Width="120px"/>
                                        <span style="color:#6b7280;">=</span>
                                        <SfTextBox @bind-Value="act.Value" Placeholder="Value" CssClass="e-small" Width="70px"/>
                                        <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-xmark"
                                                  @onclick="() => SelectedMachineState.OnEnterActions.RemoveAt(actionIdx)"/>
                                    </div>
                                }
                                <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-plus" Content="Add Action"
                                          @onclick="() => SelectedMachineState.OnEnterActions.Add(new TagAction())"/>
                            }
                            
                            @* ── On-Exit Actions ─────────────────── *@
                            <div class="panel-header" style="margin-top:12px;">ON EXIT ACTIONS</div>
                            <div class="info-panel" style="font-size:11px; color:#9ca3af; margin-bottom:4px;">Tag writes executed when leaving this state</div>
                            @if (SelectedMachineState != null)
                            {
                                @for (int idx = 0; idx < SelectedMachineState.OnExitActions.Count; idx++)
                                {
                                    var actionIdx = idx;
                                    var act = SelectedMachineState.OnExitActions[actionIdx];
                                    <div style="display:flex; gap:4px; margin-bottom:4px; align-items:center;">
                                        <SfDropDownList TItem="string" TValue="string" @bind-Value="act.TagPath" DataSource="@_availableTagPaths"
                                                        Placeholder="Tag" AllowFiltering="true" PopupWidth="220px" CssClass="e-small" Width="120px"/>
                                        <span style="color:#6b7280;">=</span>
                                        <SfTextBox @bind-Value="act.Value" Placeholder="Value" CssClass="e-small" Width="70px"/>
                                        <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-xmark"
                                                  @onclick="() => SelectedMachineState.OnExitActions.RemoveAt(actionIdx)"/>
                                    </div>
                                }
                                <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-plus" Content="Add Action"
                                          @onclick="() => SelectedMachineState.OnExitActions.Add(new TagAction())"/>
                            }
                            
                            @* ── State Scripts ────────────────────── *@
                            <div class="panel-header" style="margin-top:12px;">C# SCRIPTS</div>
                            @if (SelectedMachineState != null)
                            {
                                <div class="form-group">
                                    <label>On Enter Script</label>
                                    <CSharpEditor Code="@(SelectedMachineState.OnEnterScript ?? "")"
                                                  CodeChanged="@(val => SelectedMachineState.OnEnterScript = string.IsNullOrWhiteSpace(val) ? null : val)"
                                                  Label="On Enter"
                                                  EditorId="@($"state-enter-{SelectedStateNode?.ID}")"
                                                  Height="150px" />
                                </div>
                                <div class="form-group">
                                    <label>On Exit Script</label>
                                    <CSharpEditor Code="@(SelectedMachineState.OnExitScript ?? "")"
                                                  CodeChanged="@(val => SelectedMachineState.OnExitScript = string.IsNullOrWhiteSpace(val) ? null : val)"
                                                  Label="On Exit"
                                                  EditorId="@($"state-exit-{SelectedStateNode?.ID}")"
                                                  Height="150px" />
                                </div>
                            }

                            @* ── State Flow Triggers ─────────────── *@
                            <div class="panel-header" style="margin-top:12px;">FLOW TRIGGERS</div>
                            <div class="info-panel" style="font-size:11px; color:#9ca3af; margin-bottom:4px;">Flows started on state entry or exit</div>
                            @if (SelectedMachineState != null)
                            {
                                <label style="font-size:12px; color:#d1d5db;">On Enter Flows</label>
                                @for (int idx = 0; idx < SelectedMachineState.OnEnterFlowIds.Count; idx++)
                                {
                                    var flowIdx = idx;
                                    <div style="display:flex; gap:4px; margin-bottom:4px; align-items:center;">
                                        <SfDropDownList TItem="FlowOption" TValue="string" Value="@SelectedMachineState.OnEnterFlowIds[flowIdx]"
                                                        ValueChanged="@((string val) => SelectedMachineState.OnEnterFlowIds[flowIdx] = val)"
                                                        DataSource="@_availableFlowOptions" AllowFiltering="true" PopupWidth="260px" CssClass="e-small"
                                                        Placeholder="Select flow">
                                            <DropDownListFieldSettings Text="Name" Value="Id"/>
                                        </SfDropDownList>
                                        <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-xmark"
                                                  @onclick="() => SelectedMachineState.OnEnterFlowIds.RemoveAt(flowIdx)"/>
                                    </div>
                                }
                                <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-plus" Content="Add Flow"
                                          @onclick="() => SelectedMachineState.OnEnterFlowIds.Add(string.Empty)"/>

                                <label style="font-size:12px; color:#d1d5db; margin-top:8px; display:block;">On Exit Flows</label>
                                @for (int idx = 0; idx < SelectedMachineState.OnExitFlowIds.Count; idx++)
                                {
                                    var flowIdx = idx;
                                    <div style="display:flex; gap:4px; margin-bottom:4px; align-items:center;">
                                        <SfDropDownList TItem="FlowOption" TValue="string" Value="@SelectedMachineState.OnExitFlowIds[flowIdx]"
                                                        ValueChanged="@((string val) => SelectedMachineState.OnExitFlowIds[flowIdx] = val)"
                                                        DataSource="@_availableFlowOptions" AllowFiltering="true" PopupWidth="260px" CssClass="e-small"
                                                        Placeholder="Select flow">
                                            <DropDownListFieldSettings Text="Name" Value="Id"/>
                                        </SfDropDownList>
                                        <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-xmark"
                                                  @onclick="() => SelectedMachineState.OnExitFlowIds.RemoveAt(flowIdx)"/>
                                    </div>
                                }
                                <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-plus" Content="Add Flow"
                                          @onclick="() => SelectedMachineState.OnExitFlowIds.Add(string.Empty)"/>
                            }

                            <div style="margin-top:12px;">
                                <SfButton CssClass="e-danger" IconCss="fa-solid fa-trash" Content="Delete State" @onclick="DeleteSelectedState"></SfButton>
                            </div>
                        }
                        else if (_selectedTransition != null)
                        {
                            @* ── Transition Properties ────────────── *@
                            <div class="panel-header" style="color:#4caf50;">TRANSITION</div>
                            <div class="info-panel" style="font-size:12px; margin-bottom:8px;">
                                <span style="color:#ef4444;">@(LookupStateName(_selectedTransition.FromStateId))</span>
                                →
                                <span style="color:#22c55e;">@(LookupStateName(_selectedTransition.ToStateId))</span>
                            </div>
                            <div class="form-group">
                                <label>Event Name</label>
                                <SfTextBox @bind-Value="_selectedTransition.Event" Placeholder="e.g. start, stop, fault"></SfTextBox>
                            </div>
                            <div class="form-group">
                                <label>Priority</label>
                                <SfNumericTextBox TValue="int" @bind-Value="_selectedTransition.Priority" Min="0" Max="100"></SfNumericTextBox>
                            </div>
                            
                            @* ── Trigger Condition ────────────────── *@
                            <div class="panel-header" style="margin-top:12px;">TRIGGER CONDITION</div>
                            <div class="info-panel" style="font-size:11px; color:#9ca3af; margin-bottom:4px;">
                                When this tag condition is true, the transition fires automatically
                            </div>
                            @if (_selectedTransition.Trigger == null)
                            {
                                <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-plus" Content="Add Tag Trigger"
                                          @onclick="() => _selectedTransition.Trigger = new TagTrigger()"/>
                            }
                            else
                            {
                                <div class="form-group">
                                    <label>Tag</label>
                                    <SfDropDownList TItem="string" TValue="string" @bind-Value="_selectedTransition.Trigger.TagPath" DataSource="@_availableTagPaths"
                                                    Placeholder="Select tag" AllowFiltering="true" PopupWidth="280px"/>
                                </div>
                                <div style="display:flex; gap:6px; align-items:flex-end;">
                                    <div class="form-group" style="flex:1;">
                                        <label>Operator</label>
                                        <SfDropDownList TItem="OperatorOption" TValue="TriggerOperator" @bind-Value="_selectedTransition.Trigger.Operator"
                                                        DataSource="@_operatorOptions">
                                            <DropDownListFieldSettings Text="Label" Value="Op"/>
                                        </SfDropDownList>
                                    </div>
                                    <div class="form-group" style="flex:1;">
                                        <label>Threshold</label>
                                        <SfTextBox @bind-Value="_selectedTransition.Trigger.Threshold" Placeholder="e.g. 80"/>
                                    </div>
                                </div>
                                <div style="margin-top:4px;">
                                    <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-trash" Content="Remove Trigger"
                                              @onclick="() => _selectedTransition.Trigger = null"/>
                                </div>
                            }
                            
                            @* ── Transition Actions ───────────────── *@
                            <div class="panel-header" style="margin-top:12px;">TRANSITION ACTIONS</div>
                            <div class="info-panel" style="font-size:11px; color:#9ca3af; margin-bottom:4px;">Tag writes executed when this transition fires</div>
                            @for (int idx = 0; idx < _selectedTransition.Actions.Count; idx++)
                            {
                                var actionIdx = idx;
                                var act = _selectedTransition.Actions[actionIdx];
                                <div style="display:flex; gap:4px; margin-bottom:4px; align-items:center;">
                                    <SfDropDownList TItem="string" TValue="string" @bind-Value="act.TagPath" DataSource="@_availableTagPaths"
                                                    Placeholder="Tag" AllowFiltering="true" PopupWidth="220px" CssClass="e-small" Width="120px"/>
                                    <span style="color:#6b7280;">=</span>
                                    <SfTextBox @bind-Value="act.Value" Placeholder="Value" CssClass="e-small" Width="70px"/>
                                    <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-xmark"
                                              @onclick="() => _selectedTransition.Actions.RemoveAt(actionIdx)"/>
                                </div>
                            }
                            <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-plus" Content="Add Action"
                                      @onclick="() => _selectedTransition.Actions.Add(new TagAction())"/>
                            
                            @* ── Transition Scripts ──────────────── *@
                            <div class="panel-header" style="margin-top:12px;">C# SCRIPTS</div>
                            <div class="form-group">
                                <label>Script Condition <span style="font-size:10px; color:#6b7280;">(must return bool)</span></label>
                                <CSharpEditor Code="@(_selectedTransition.ScriptCondition ?? "")"
                                              CodeChanged="@(val => _selectedTransition.ScriptCondition = string.IsNullOrWhiteSpace(val) ? null : val)"
                                              Label="Condition"
                                              EditorId="@($"trans-cond-{_selectedTransition.Id}")"
                                              Height="150px" />
                            </div>
                            <div class="form-group">
                                <label>Script Action</label>
                                <CSharpEditor Code="@(_selectedTransition.ScriptAction ?? "")"
                                              CodeChanged="@(val => _selectedTransition.ScriptAction = string.IsNullOrWhiteSpace(val) ? null : val)"
                                              Label="Action"
                                              EditorId="@($"trans-action-{_selectedTransition.Id}")"
                                              Height="150px" />
                            </div>

                            @* ── Transition Flow Triggers ──────── *@
                            <div class="panel-header" style="margin-top:12px;">FLOW TRIGGERS</div>
                            <div class="info-panel" style="font-size:11px; color:#9ca3af; margin-bottom:4px;">Flows started when this transition fires</div>
                            @for (int idx = 0; idx < _selectedTransition.FlowIds.Count; idx++)
                            {
                                var flowIdx = idx;
                                <div style="display:flex; gap:4px; margin-bottom:4px; align-items:center;">
                                    <SfDropDownList TItem="FlowOption" TValue="string" Value="@_selectedTransition.FlowIds[flowIdx]"
                                                    ValueChanged="@((string val) => _selectedTransition.FlowIds[flowIdx] = val)"
                                                    DataSource="@_availableFlowOptions" AllowFiltering="true" PopupWidth="260px" CssClass="e-small"
                                                    Placeholder="Select flow">
                                        <DropDownListFieldSettings Text="Name" Value="Id"/>
                                    </SfDropDownList>
                                    <SfButton CssClass="e-flat e-small e-danger" IconCss="fa-solid fa-xmark"
                                              @onclick="() => _selectedTransition.FlowIds.RemoveAt(flowIdx)"/>
                                </div>
                            }
                            <SfButton CssClass="e-flat e-small" IconCss="fa-solid fa-plus" Content="Add Flow"
                                      @onclick="() => _selectedTransition.FlowIds.Add(string.Empty)"/>

                            <div style="margin-top:12px;">
                                <SfButton CssClass="e-danger" IconCss="fa-solid fa-trash" Content="Delete Transition" @onclick="DeleteSelectedTransition"/>
                            </div>
                        }
                        else
                        {
                            <div class="form-group">
                                <label>Machine Description</label>
                                <SfTextBox @bind-Value="CurrentStateMachine.Description" Placeholder="State machine description" Multiline="true"></SfTextBox>
                            </div>
                            <div class="info-panel">
                                <p><strong>States:</strong> @CurrentStateMachine.States.Count</p>
                                <p><strong>Transitions:</strong> @CurrentStateMachine.Transitions.Count</p>
                            </div>
                            @if (CurrentStateMachine.Enabled && _liveInfo != null)
                            {
                                <div class="panel-header" style="margin-top:12px;">RUNTIME STATUS</div>
                                <div class="info-panel" style="border:1px solid #333; border-radius:6px; padding:8px; background:#1a1a1a;">
                                    <p><strong>Current State:</strong> <span style="color:#22c55e;">@(_liveInfo.NowStateName ?? "—")</span></p>
                                    <p><strong>Previous State:</strong> @(_liveInfo.BeforeStateName ?? "—")</p>
                                    <p><strong>Last Event:</strong> @(_liveInfo.LastTrigger ?? "—")</p>
                                    <p><strong>Last Changed:</strong> @_liveInfo.ChangedAtUtc.ToString("HH:mm:ss")</p>
                                    @if (_liveInfo.Audit.Any())
                                    {
                                        <div style="margin-top:8px;">
                                            <strong>Recent Transitions:</strong>
                                            <div style="max-height:120px; overflow-y:auto; margin-top:4px;">
                                                @foreach (var entry in _liveInfo.Audit.AsEnumerable().Reverse().Take(10))
                                                {
                                                    <div style="font-size:11px; color:#9ca3af; padding:2px 0; border-bottom:1px solid #222;">
                                                        <span style="color:#6b7280;">@entry.When.ToString("HH:mm:ss")</span>
                                                        <span style="color:#ef4444;">@entry.SrcName</span>
                                                        →
                                                        <span style="color:#22c55e;">@entry.DstName</span>
                                                        <span style="color:#6b7280;">[@entry.Trigger]</span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else if (CurrentStateMachine.Enabled)
                            {
                                <div class="panel-header" style="margin-top:12px;">RUNTIME STATUS</div>
                                <div class="info-panel" style="color:#6b7280;">
                                    <p>Waiting for engine connection…</p>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<SfDialog @ref="_deleteDialog" @bind-Visible="_deleteDialogVisible" Width="400px" IsModal="true" ShowCloseIcon="true">
    <DialogTemplates>
        <Header>Confirm Delete</Header>
        <Content>
            <p>Are you sure you want to delete this state machine?</p>
            <p><strong>@_deletingStateMachineName</strong></p>
        </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="Cancel" OnClick="CancelDelete" />
        <DialogButton Content="Delete" IsPrimary="true" CssClass="e-danger" OnClick="ConfirmDelete" />
    </DialogButtons>
</SfDialog>

@code {
    [Parameter]
    public string? StateMachineId { get; set; }

    private StateMachineConfig CurrentStateMachine { get; set; } = new();
    private List<StateMachineDisplay> StateMachinesList { get; set; } = new();
    private SfDialog? _deleteDialog;
    private bool _deleteDialogVisible = false;
    private string? _deletingStateMachineId;
    private string? _deletingStateMachineName;
    
    // Diagram components
    private SfDiagramComponent? StateDiagram;
    private DiagramObjectCollection<Node> StateNodes = new();
    private DiagramObjectCollection<Connector> StateConnectors = new();
    private Node? SelectedStateNode;
    private string SelectedStateName = "";
    private string SelectedStateDescription = "";
    private string SelectedStateColor = "#3b82f6";
    private bool SelectedStateIsInitial = false;
    private bool SelectedStateIsFinal = false;
    
    // Transition selection
    private StateTransition? _selectedTransition;
    private Connector? _selectedConnector;
    
    // Palette state
    private StateType? _draggingStateType;
    
    // Available tag paths for dropdowns
    private List<string> _availableTagPaths = new();
    
    // Available flows for trigger dropdowns
    private List<FlowOption> _availableFlowOptions = new();
    
    // Operator options for trigger dropdown
    private static readonly List<OperatorOption> _operatorOptions = new()
    {
        new() { Op = TriggerOperator.Eq,  Label = "== (Equal)" },
        new() { Op = TriggerOperator.Neq, Label = "!= (Not Equal)" },
        new() { Op = TriggerOperator.Gt,  Label = "> (Greater)" },
        new() { Op = TriggerOperator.Gte, Label = ">= (Greater or Equal)" },
        new() { Op = TriggerOperator.Lt,  Label = "< (Less)" },
        new() { Op = TriggerOperator.Lte, Label = "<= (Less or Equal)" }
    };
    
    // Runtime info from engine (populated when the MQTT service delivers
    // MachineRuntimeInfo messages; stays null when engine is offline)
    private MachineRuntimeInfo? _liveInfo;
    
    // ID of the state node currently highlighted as "active" on the diagram
    private string? _highlightedStateId;
    
    // State to diagram node mapping
    private Dictionary<string, string> _stateToNodeMap = new();
    
    // The MachineState object for the currently selected node
    private MachineState? SelectedMachineState =>
        SelectedStateNode != null
            ? CurrentStateMachine.States.FirstOrDefault(s => s.Id == SelectedStateNode.ID)
            : null;

    private string? _lastLoadedMachineId;
    private bool _diagramNeedsReload;

    protected override void OnInitialized()
    {
        LoadStateMachines();
        
        // Build available tag paths for trigger/action dropdowns
        _availableTagPaths = ConfigService.GetAllTagsWithConnection()
            .Select(ct => $"{ct.Connection.Name}/{ct.Tag.Name}")
            .OrderBy(p => p)
            .ToList();
        
        // Build available flows for flow trigger dropdowns
        _availableFlowOptions = ConfigService.Flows
            .Select(f => new FlowOption { Id = f.Id, Name = f.Name })
            .OrderBy(f => f.Name)
            .ToList();
        
        // Subscribe to state machine runtime updates from the Engine via MQTT
        RealtimeData.OnStateMachineStateChanged += HandleMachineStateUpdate;
    }

    protected override void OnParametersSet()
    {
        if (StateMachineId == _lastLoadedMachineId)
            return;

        _lastLoadedMachineId = StateMachineId;

        // Clear selection state from previous machine
        SelectedStateNode = null;
        _selectedTransition = null;
        _selectedConnector = null;

        if (!string.IsNullOrEmpty(StateMachineId))
        {
            LoadStateMachine(StateMachineId);
            _diagramNeedsReload = true;
        }
        else
        {
            _diagramNeedsReload = false;
            LoadStateMachines();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_diagramNeedsReload && !string.IsNullOrEmpty(StateMachineId))
        {
            _diagramNeedsReload = false;
            await LoadStatesIntoDiagram();
        }
    }

    private void LoadStateMachines()
    {
        StateMachinesList = ConfigService.StateMachines
            .Select(sm => new StateMachineDisplay
            {
                Id = sm.Id,
                Name = sm.Name,
                Description = sm.Description ?? "",
                StateCount = sm.States.Count,
                Enabled = sm.Enabled
            })
            .ToList();
    }

    private void LoadStateMachine(string id)
    {
        var stateMachine = ConfigService.GetStateMachine(id);
        if (stateMachine != null)
        {
            CurrentStateMachine = stateMachine;
            StateNodes = new DiagramObjectCollection<Node>();
            StateConnectors = new DiagramObjectCollection<Connector>();
            _stateToNodeMap.Clear();
            // Grab cached runtime state from the MQTT-synced store
            _liveInfo = RealtimeData.GetMachineState(id);
        }
        else
        {
            Navigation.NavigateTo("/state-machines");
        }
    }
    
    private async Task LoadStatesIntoDiagram()
    {
        if (StateDiagram == null) return;
        
        // Load existing states as nodes
        foreach (var state in CurrentStateMachine.States)
        {
            var node = CreateStateNode(state.Id, state.Name, state.Color, state.X, state.Y, state.IsInitial, state.IsFinal);
            StateNodes.Add(node);
            _stateToNodeMap[state.Id] = state.Id;
        }
        
        // Load existing transitions as connectors
        foreach (var transition in CurrentStateMachine.Transitions)
        {
            var connector = CreateStateConnector(transition.Id, transition.FromStateId, transition.ToStateId, transition.Event);
            StateConnectors.Add(connector);
        }
        
        // If we already have live info, highlight the active state
        if (_liveInfo != null)
            HighlightActiveState(_liveInfo.NowStateId);
        
        StateHasChanged();
    }

    private void CreateNewStateMachine()
    {
        var newId = Guid.NewGuid().ToString();
        Navigation.NavigateTo($"/state-machines/{newId}");
        CurrentStateMachine = new StateMachineConfig
        {
            Id = newId,
            Name = "New State Machine",
            Description = "State machine description"
        };
    }

    private void EditStateMachine(string id)
    {
        Navigation.NavigateTo($"/state-machines/{id}");
    }

    private async Task ToggleEnabled()
    {
        CurrentStateMachine.Enabled = !CurrentStateMachine.Enabled;
        await SaveStateMachine();
    }

    private async Task SaveStateMachine()
    {
        // Sync diagram nodes back to state machine config
        SyncDiagramToConfig();
        
        CurrentStateMachine.UpdatedAt = DateTime.UtcNow;
        
        var existing = ConfigService.GetStateMachine(CurrentStateMachine.Id);
        if (existing != null)
        {
            await ConfigService.UpdateStateMachineAsync(CurrentStateMachine);
        }
        else
        {
            await ConfigService.AddStateMachineAsync(CurrentStateMachine);
        }
        
        LoadStateMachines();

        if (DataForeman.App.Components.Layout.MainLayout.Instance is { } layout)
            await layout.ShowToastAsync("State machine saved", "e-toast-success", "Saved");
    }
    
    private void SyncDiagramToConfig()
    {
        // Update state positions from diagram nodes
        foreach (var node in StateNodes)
        {
            var state = CurrentStateMachine.States.FirstOrDefault(s => s.Id == node.ID);
            if (state != null)
            {
                state.X = node.OffsetX;
                state.Y = node.OffsetY;
            }
        }
        
        // Reconcile transitions: keep existing ones (with their triggers/actions)
        // and add new ones from diagram connectors
        var existingIds = new HashSet<string>(CurrentStateMachine.Transitions.Select(t => t.Id));
        var connectorIds = new HashSet<string>();
        
        foreach (var connector in StateConnectors)
        {
            if (string.IsNullOrEmpty(connector.SourceID) || string.IsNullOrEmpty(connector.TargetID))
                continue;
                
            var connId = connector.ID ?? Guid.NewGuid().ToString();
            connectorIds.Add(connId);
            
            if (!existingIds.Contains(connId))
            {
                // New connector drawn by user — add transition
                CurrentStateMachine.Transitions.Add(new StateTransition
                {
                    Id = connId,
                    FromStateId = connector.SourceID,
                    ToStateId = connector.TargetID,
                    Event = "transition",
                    Priority = 0
                });
            }
            else
            {
                // Existing transition — update source/target in case they changed
                var existing = CurrentStateMachine.Transitions.FirstOrDefault(t => t.Id == connId);
                if (existing != null)
                {
                    existing.FromStateId = connector.SourceID;
                    existing.ToStateId = connector.TargetID;
                }
            }
        }
        
        // Remove transitions whose connector was deleted
        CurrentStateMachine.Transitions.RemoveAll(t => !connectorIds.Contains(t.Id));
    }

    // Diagram event handlers
    private void OnPaletteDragStart(StateType stateType)
    {
        _draggingStateType = stateType;
    }
    
    private void OnDiagramDragOver(Microsoft.AspNetCore.Components.Web.DragEventArgs e) 
    { 
        e.DataTransfer.DropEffect = "copy"; 
    }
    
    private async Task OnDiagramDrop(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (_draggingStateType == null || StateDiagram == null) return;
        
        try
        {
            var diagramRect = await JSRuntime.InvokeAsync<Dictionary<string, double>>("eval", 
                "(() => { const rect = document.getElementById('state-diagram-space').getBoundingClientRect(); return { left: rect.left, top: rect.top }; })()");
            double diagramX = e.ClientX - diagramRect["left"];
            double diagramY = e.ClientY - diagramRect["top"];
            
            await AddStateFromPalette(_draggingStateType.Value, diagramX, diagramY);
        }
        finally 
        { 
            _draggingStateType = null; 
        }
    }
    
    private async Task AddStateFromPalette(StateType stateType, double x, double y)
    {
        if (StateDiagram == null) return;
        
        var stateId = Guid.NewGuid().ToString();
        string stateName = stateType switch
        {
            StateType.Initial => "Initial State",
            StateType.Final => "Final State",
            _ => $"State {CurrentStateMachine.States.Count + 1}"
        };
        
        string stateColor = stateType switch
        {
            StateType.Initial => "#22c55e",
            StateType.Final => "#ef4444",
            _ => "#3b82f6"
        };
        
        bool isInitial = stateType == StateType.Initial;
        bool isFinal = stateType == StateType.Final;
        
        // Create diagram node
        var node = CreateStateNode(stateId, stateName, stateColor, x, y, isInitial, isFinal);
        StateNodes.Add(node);
        
        // Create state in config
        var state = new MachineState
        {
            Id = stateId,
            Name = stateName,
            Color = stateColor,
            X = x,
            Y = y,
            IsInitial = isInitial,
            IsFinal = isFinal
        };
        CurrentStateMachine.States.Add(state);
        
        _stateToNodeMap[stateId] = stateId;
        StateHasChanged();
    }
    
    private Node CreateStateNode(string id, string label, string color, double x, double y, bool isInitial, bool isFinal)
    {
        var node = new Node
        {
            ID = id,
            OffsetX = x,
            OffsetY = y,
            Width = 120,
            Height = 60,
            Shape = isInitial || isFinal 
                ? new BasicShape { Type = NodeShapes.Basic, Shape = NodeBasicShapes.Ellipse }
                : new BasicShape { Type = NodeShapes.Basic, Shape = NodeBasicShapes.Rectangle, CornerRadius = 8 },
            Style = new ShapeStyle 
            { 
                Fill = "#1e1e1e", 
                StrokeColor = color, 
                StrokeWidth = 3 
            },
            Annotations = new DiagramObjectCollection<ShapeAnnotation>(),
            Ports = new DiagramObjectCollection<PointPort>(),
            Constraints = NodeConstraints.Default | NodeConstraints.AllowDrop
        };
        
        // Add label
        node.Annotations.Add(new ShapeAnnotation 
        { 
            Content = label, 
            Style = new TextStyle { Color = "#ffffff", FontSize = 12, Bold = true }, 
            Offset = new DiagramPoint { X = 0.5, Y = 0.5 },
            HorizontalAlignment = HorizontalAlignment.Center,
            VerticalAlignment = VerticalAlignment.Center
        });
        
        // Add ports for connections
        node.Ports.Add(new PointPort 
        { 
            ID = "top", 
            Offset = new DiagramPoint { X = 0.5, Y = 0 }, 
            Visibility = PortVisibility.Visible,
            Shape = PortShapes.Circle,
            Width = 10,
            Height = 10,
            Style = new ShapeStyle { Fill = color, StrokeColor = "#ffffff", StrokeWidth = 2 },
            Constraints = PortConstraints.Default | PortConstraints.Draw
        });
        
        node.Ports.Add(new PointPort 
        { 
            ID = "right", 
            Offset = new DiagramPoint { X = 1, Y = 0.5 }, 
            Visibility = PortVisibility.Visible,
            Shape = PortShapes.Circle,
            Width = 10,
            Height = 10,
            Style = new ShapeStyle { Fill = color, StrokeColor = "#ffffff", StrokeWidth = 2 },
            Constraints = PortConstraints.Default | PortConstraints.Draw
        });
        
        node.Ports.Add(new PointPort 
        { 
            ID = "bottom", 
            Offset = new DiagramPoint { X = 0.5, Y = 1 }, 
            Visibility = PortVisibility.Visible,
            Shape = PortShapes.Circle,
            Width = 10,
            Height = 10,
            Style = new ShapeStyle { Fill = color, StrokeColor = "#ffffff", StrokeWidth = 2 },
            Constraints = PortConstraints.Default | PortConstraints.Draw
        });
        
        node.Ports.Add(new PointPort 
        { 
            ID = "left", 
            Offset = new DiagramPoint { X = 0, Y = 0.5 }, 
            Visibility = PortVisibility.Visible,
            Shape = PortShapes.Circle,
            Width = 10,
            Height = 10,
            Style = new ShapeStyle { Fill = color, StrokeColor = "#ffffff", StrokeWidth = 2 },
            Constraints = PortConstraints.Default | PortConstraints.Draw
        });
        
        return node;
    }
    
    private Connector CreateStateConnector(string id, string fromStateId, string toStateId, string eventLabel)
    {
        return new Connector
        {
            ID = id,
            SourceID = fromStateId,
            TargetID = toStateId,
            Type = ConnectorSegmentType.Orthogonal,
            Style = new ShapeStyle { StrokeColor = "#4caf50", StrokeWidth = 2 },
            CornerRadius = 5,
            TargetDecorator = new DecoratorSettings 
            { 
                Shape = DecoratorShape.Arrow, 
                Width = 10, 
                Height = 10, 
                Style = new ShapeStyle { Fill = "#4caf50", StrokeColor = "#4caf50" } 
            },
            Annotations = new DiagramObjectCollection<PathAnnotation>()
        };
    }
    
    private void OnNodeCreating(IDiagramObject obj)
    {
        if (obj is Node node)
        {
            node.Style.Fill = "#1e1e1e";
            if (node.Ports != null)
            {
                foreach (var port in node.Ports)
                {
                    port.Visibility = PortVisibility.Visible;
                    port.Width = 10;
                    port.Height = 10;
                    port.Constraints = PortConstraints.Default | PortConstraints.Draw;
                }
            }
        }
    }
    
    private void OnConnectorCreating(IDiagramObject obj)
    {
        if (obj is Connector connector)
        {
            connector.Type = ConnectorSegmentType.Orthogonal;
            connector.Style = new ShapeStyle { StrokeColor = "#4caf50", StrokeWidth = 2 };
            connector.CornerRadius = 5;
            connector.TargetDecorator = new DecoratorSettings 
            { 
                Shape = DecoratorShape.Arrow, 
                Width = 10, 
                Height = 10, 
                Style = new ShapeStyle { Fill = "#4caf50", StrokeColor = "#4caf50" } 
            };
        }
    }
    
    private void OnConnectionChanged(Syncfusion.Blazor.Diagram.ConnectionChangedEventArgs args)
    {
        // Connection created or modified
        StateHasChanged();
    }
    
    private void OnSelectionChanged(Syncfusion.Blazor.Diagram.SelectionChangedEventArgs args)
    {
        // Reset both selections
        SelectedStateNode = null;
        _selectedTransition = null;
        _selectedConnector = null;
        
        if (args.NewValue?.Count > 0)
        {
            if (args.NewValue[0] is Node node)
            {
                SelectedStateNode = node;
                var state = CurrentStateMachine.States.FirstOrDefault(s => s.Id == node.ID);
                if (state != null)
                {
                    SelectedStateName = state.Name;
                    SelectedStateDescription = state.Description ?? "";
                    SelectedStateColor = state.Color;
                    SelectedStateIsInitial = state.IsInitial;
                    SelectedStateIsFinal = state.IsFinal;
                }
            }
            else if (args.NewValue[0] is Connector connector)
            {
                _selectedConnector = connector;
                // Find existing transition or create a temporary reference
                _selectedTransition = CurrentStateMachine.Transitions
                    .FirstOrDefault(t => t.Id == connector.ID)
                    ?? CurrentStateMachine.Transitions
                        .FirstOrDefault(t => t.FromStateId == connector.SourceID && t.ToStateId == connector.TargetID);
            }
        }
        else
        {
            SelectedStateName = "";
            SelectedStateDescription = "";
        }
        StateHasChanged();
    }
    
    private async Task OnStateNameChanged()
    {
        if (SelectedStateNode == null) return;
        
        var state = CurrentStateMachine.States.FirstOrDefault(s => s.Id == SelectedStateNode.ID);
        if (state != null)
        {
            state.Name = SelectedStateName;
            if (SelectedStateNode.Annotations.Count > 0)
            {
                SelectedStateNode.Annotations[0].Content = SelectedStateName;
            }
            StateHasChanged();
        }
    }
    
    private void OnStateTypeChanged()
    {
        if (SelectedStateNode == null) return;
        
        var state = CurrentStateMachine.States.FirstOrDefault(s => s.Id == SelectedStateNode.ID);
        if (state != null)
        {
            state.IsInitial = SelectedStateIsInitial;
            state.IsFinal = SelectedStateIsFinal;
            
            // Update color based on type
            if (SelectedStateIsInitial)
            {
                SelectedStateColor = "#22c55e";
                state.Color = SelectedStateColor;
                SelectedStateNode.Style.StrokeColor = SelectedStateColor;
            }
            else if (SelectedStateIsFinal)
            {
                SelectedStateColor = "#ef4444";
                state.Color = SelectedStateColor;
                SelectedStateNode.Style.StrokeColor = SelectedStateColor;
            }
            
            StateHasChanged();
        }
    }
    
    private async Task DeleteSelectedState()
    {
        if (SelectedStateNode == null || StateDiagram == null) return;
        
        var stateId = SelectedStateNode.ID;
        
        // Remove from diagram
        StateNodes.Remove(SelectedStateNode);
        
        // Remove connected transitions
        var connectorsToRemove = StateConnectors.Where(c => c.SourceID == stateId || c.TargetID == stateId).ToList();
        foreach (var conn in connectorsToRemove)
        {
            StateConnectors.Remove(conn);
        }
        
        // Remove from config
        CurrentStateMachine.States.RemoveAll(s => s.Id == stateId);
        CurrentStateMachine.Transitions.RemoveAll(t => t.FromStateId == stateId || t.ToStateId == stateId);
        
        SelectedStateNode = null;
        StateHasChanged();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/state-machines");
    }

    private void ConfirmDeleteStateMachine(string id)
    {
        var stateMachine = ConfigService.GetStateMachine(id);
        if (stateMachine != null)
        {
            _deletingStateMachineId = id;
            _deletingStateMachineName = stateMachine.Name;
            _deleteDialogVisible = true;
        }
    }

    private async Task ConfirmDelete()
    {
        if (_deletingStateMachineId != null)
        {
            await ConfigService.DeleteStateMachineAsync(_deletingStateMachineId);
            LoadStateMachines();
            _deleteDialogVisible = false;
            _deletingStateMachineId = null;
            _deletingStateMachineName = null;
        }
    }

    private Task CancelDelete()
    {
        _deleteDialogVisible = false;
        _deletingStateMachineId = null;
        _deletingStateMachineName = null;
        return Task.CompletedTask;
    }

    private void HandleMachineStateUpdate(MachineRuntimeInfo info)
    {
        // Only refresh if we're viewing this specific machine
        if (info.ConfigId == CurrentStateMachine?.Id)
        {
            _liveInfo = info;
            HighlightActiveState(info.NowStateId);
            InvokeAsync(StateHasChanged);
        }
    }
    
    /// <summary>
    /// Visually highlights the active state node on the diagram and restores
    /// the previous active node to its original style.
    /// </summary>
    private void HighlightActiveState(string? activeStateId)
    {
        if (CurrentStateMachine == null) return;
        
        // Restore previous highlighted node
        if (_highlightedStateId != null && _highlightedStateId != activeStateId)
        {
            var prevNode = StateNodes.FirstOrDefault(n => n.ID == _highlightedStateId);
            var prevState = CurrentStateMachine.States.FirstOrDefault(s => s.Id == _highlightedStateId);
            if (prevNode != null && prevState != null)
            {
                prevNode.Style.StrokeColor = prevState.Color;
                prevNode.Style.StrokeWidth = 3;
                // Restore annotation to plain white
                if (prevNode.Annotations.Count > 0)
                    prevNode.Annotations[0].Style.Color = "#ffffff";
            }
        }
        
        // Highlight the new active node
        if (!string.IsNullOrEmpty(activeStateId))
        {
            var node = StateNodes.FirstOrDefault(n => n.ID == activeStateId);
            if (node != null)
            {
                node.Style.StrokeColor = "#00e676";
                node.Style.StrokeWidth = 5;
                if (node.Annotations.Count > 0)
                    node.Annotations[0].Style.Color = "#00e676";
            }
        }
        
        _highlightedStateId = activeStateId;
    }
    
    private async Task DeleteSelectedTransition()
    {
        if (_selectedConnector == null || _selectedTransition == null) return;
        
        StateConnectors.Remove(_selectedConnector);
        CurrentStateMachine.Transitions.Remove(_selectedTransition);
        _selectedConnector = null;
        _selectedTransition = null;
        StateHasChanged();
    }
    
    private string LookupStateName(string stateId)
        => CurrentStateMachine.States.FirstOrDefault(s => s.Id == stateId)?.Name ?? stateId;

    public void Dispose()
    {
        RealtimeData.OnStateMachineStateChanged -= HandleMachineStateUpdate;
    }

    private enum StateType
    {
        Normal,
        Initial,
        Final
    }

    private class StateMachineDisplay
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int StateCount { get; set; }
        public bool Enabled { get; set; }
    }
    
    private class OperatorOption
    {
        public TriggerOperator Op { get; set; }
        public string Label { get; set; } = string.Empty;
    }

    private class FlowOption
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }
}
