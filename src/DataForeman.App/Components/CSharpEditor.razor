@inject ScriptValidationService Validator
@implements IDisposable

<div class="csharp-editor-container" style="@ContainerStyle">
    <div class="editor-header" style="display:flex; justify-content:space-between; align-items:center; padding:4px 8px; background:#1a1a2e; border-bottom:1px solid #333; font-size:11px; flex-wrap:wrap; gap:4px;">
        <span style="color:#9ca3af; display:flex; align-items:center; gap:6px;">
            <i class="fa-solid fa-code" style="color:#178600;"></i>
            <span>C# Script</span>
            @if (!string.IsNullOrEmpty(Label))
            {
                <span> — @Label</span>
            }
            <select @onchange="OnTemplateSelected" style="background:#2d2d44; color:#ccc; border:1px solid #444; border-radius:3px; font-size:11px; padding:1px 4px; cursor:pointer;">
                <option value="">Insert template…</option>
                <option value="readwrite">Read / Write Tags</option>
                <option value="stateful">Stateful Counter</option>
                <option value="condition">Conditional Logic</option>
                <option value="multimethod">Helper Methods</option>
                <option value="classdef">Class Definition</option>
                <option value="regex">Regex Processing</option>
                <option value="alarm">Alarm Detection</option>
            </select>
        </span>
        <span style="display:flex; align-items:center; gap:8px;">
            <button @onclick="ToggleApiRef" title="Toggle API Reference" style="background:none; border:none; color:@(_showApiRef ? "#60a5fa" : "#6b7280"); cursor:pointer; font-size:12px; padding:0;">
                <i class="fa-solid fa-book"></i>
            </button>
            <button @onclick="ToggleFullscreen" title="@(_isFullscreen ? "Exit fullscreen" : "Fullscreen")" style="background:none; border:none; color:#6b7280; cursor:pointer; font-size:12px; padding:0;">
                <i class="fa-solid @(_isFullscreen ? "fa-compress" : "fa-expand")"></i>
            </button>
            @if (_isValidating)
            {
                <span style="color:#f59e0b;">Validating…</span>
            }
            else if (_diagnostics.Count == 0)
            {
                <span style="color:#22c55e;">✓ No issues</span>
            }
            else
            {
                var errorCount = _diagnostics.Count(d => d.Severity == "Error");
                var warnCount = _diagnostics.Count(d => d.Severity == "Warning");
                @if (errorCount > 0)
                {
                    <span style="color:#ef4444;">@errorCount error(s)</span>
                }
                @if (warnCount > 0)
                {
                    <span style="color:#f59e0b; margin-left:6px;">@warnCount warning(s)</span>
                }
            }
        </span>
    </div>
    <div style="display:flex; flex:1; overflow:hidden;">
        <div style="flex:1; min-width:0;">
            <StandaloneCodeEditor @ref="_editor"
                Id="@EditorId"
                ConstructionOptions="GetEditorOptions"
                OnDidChangeModelContent="OnContentChanged" />
        </div>
        @if (_showApiRef)
        {
            <div style="width:220px; background:#12121a; border-left:1px solid #333; overflow-y:auto; padding:8px; font-size:11px; font-family:monospace;">
                <div style="color:#60a5fa; font-weight:bold; margin-bottom:6px;">API Reference</div>
                @foreach (var apiSection in _apiSections)
                {
                    <div style="color:#9ca3af; font-size:10px; margin-top:8px; text-transform:uppercase; letter-spacing:0.5px;">@apiSection.Title</div>
                    @foreach (var entry in apiSection.Entries)
                    {
                        <div style="color:#c4c4c4; padding:2px 0; cursor:default;" title="@entry.Description">
                            <span style="color:#dcdcaa;">@entry.Signature</span>
                        </div>
                    }
                }
            </div>
        }
    </div>
    @if (_diagnostics.Any())
    {
        <div class="diagnostics-panel" style="max-height:80px; overflow-y:auto; background:#1a1a1a; border-top:1px solid #333; padding:4px 8px; font-size:11px; font-family:monospace;">
            @foreach (var diag in _diagnostics)
            {
                var color = diag.Severity == "Error" ? "#ef4444" : "#f59e0b";
                var icon = diag.Severity == "Error" ? "fa-circle-xmark" : "fa-triangle-exclamation";
                <div style="color:@color; padding:1px 0;">
                    <i class="fa-solid @icon" style="font-size:10px;"></i>
                    <span style="color:#6b7280;">(@diag.StartLine:@diag.StartColumn)</span>
                    @diag.Message
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string Code { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> CodeChanged { get; set; }
    [Parameter] public string Label { get; set; } = "";
    [Parameter] public string EditorId { get; set; } = "csharp-editor";
    [Parameter] public string Height { get; set; } = "350px";

    private StandaloneCodeEditor? _editor;
    private List<ScriptValidationService.DiagnosticEntry> _diagnostics = new();
    private bool _isValidating;
    private bool _showApiRef;
    private bool _isFullscreen;
    private System.Timers.Timer? _debounceTimer;
    private string _lastValidatedCode = "";

    private string ContainerStyle
    {
        get
        {
            if (_isFullscreen)
                return "position:fixed; top:0; left:0; right:0; bottom:0; z-index:9999; display:flex; flex-direction:column; background:#1e1e1e;";
            return $"border:1px solid #333; border-radius:4px; overflow:hidden; height:{Height}; display:flex; flex-direction:column;";
        }
    }

    private StandaloneEditorConstructionOptions GetEditorOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "csharp",
            Value = Code,
            Theme = "vs-dark",
            FontSize = 13,
            Minimap = new EditorMinimapOptions { Enabled = false },
            ScrollBeyondLastLine = false,
            RenderLineHighlight = "all",
            LineNumbers = "on",
            TabSize = 4,
            WordWrap = "on",
            SuggestOnTriggerCharacters = true,
            QuickSuggestions = new QuickSuggestionsOptions
            {
                Other = "on",
                Comments = "off",
                Strings = "on"
            },
            Folding = true,
            BracketPairColorization = new BracketPairColorizationOptions { Enabled = true }
        };
    }

    protected override void OnInitialized()
    {
        _debounceTimer = new System.Timers.Timer(800);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (_, _) => await ValidateCurrentCode();
    }

    private async Task OnContentChanged(ModelContentChangedEvent e)
    {
        if (_editor == null) return;
        var newCode = await _editor.GetValue();
        if (newCode != Code)
        {
            Code = newCode;
            await CodeChanged.InvokeAsync(newCode);
            _debounceTimer?.Stop();
            _debounceTimer?.Start();
        }
    }

    private async Task ValidateCurrentCode()
    {
        var code = Code;
        if (code == _lastValidatedCode) return;
        _lastValidatedCode = code;

        await InvokeAsync(() =>
        {
            _isValidating = true;
            StateHasChanged();
        });

        var diagnostics = await Task.Run(() => Validator.Validate(code));

        await InvokeAsync(() =>
        {
            _diagnostics = diagnostics;
            _isValidating = false;
            StateHasChanged();
        });
    }

    private void ToggleApiRef() => _showApiRef = !_showApiRef;

    private void ToggleFullscreen() => _isFullscreen = !_isFullscreen;

    private async Task OnTemplateSelected(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        var key = e.Value?.ToString();
        if (string.IsNullOrEmpty(key) || _editor == null) return;

        var template = key switch
        {
            "readwrite" => "// Read tag values\nvar temperature = ReadTagDouble(\"Conn/Temperature\");\nvar pressure = ReadTagDouble(\"Conn/Pressure\");\n\n// Compute result\nvar isOverLimit = temperature > 80 && pressure > 5.0;\n\n// Write output tag\nWriteTag(\"Conn/Alarm\", isOverLimit);\nLog($\"Temp={temperature:F1}, Pressure={pressure:F1}, Alarm={isOverLimit}\");\n\nreturn isOverLimit;",
            "stateful" => "// Retrieve persistent counter (survives across scan cycles)\nvar counter = GetState<int>(\"counter\", 0);\ncounter++;\nSetState(\"counter\", counter);\n\nLog($\"Scan cycle #{counter}\");\nreturn counter;",
            "condition" => "var speed = ReadTagDouble(\"Motor/Speed\");\nvar mode = ReadTagString(\"System/Mode\");\n\nif (mode == \"AUTO\" && speed > 1500)\n{\n    WriteTag(\"Motor/Warning\", true);\n    Log(\"Speed limit exceeded in AUTO mode\");\n    return \"WARNING\";\n}\nelse if (mode == \"MANUAL\")\n{\n    return \"MANUAL_OK\";\n}\n\nreturn \"NORMAL\";",
            "multimethod" => "// Define helper methods using local functions\ndouble CelsiusToFahrenheit(double c) => c * 1.8 + 32;\n\nbool IsInRange(double val, double lo, double hi) => val >= lo && val <= hi;\n\nstring ClassifyTemperature(double tempC)\n{\n    if (tempC < 20) return \"COLD\";\n    if (tempC < 60) return \"NORMAL\";\n    if (tempC < 80) return \"WARM\";\n    return \"HOT\";\n}\n\n// Main logic\nvar tempC = ReadTagDouble(\"Sensor/TempCelsius\");\nvar tempF = CelsiusToFahrenheit(tempC);\nvar classification = ClassifyTemperature(tempC);\nvar inSpec = IsInRange(tempC, 15, 75);\n\nLog($\"{tempC:F1}°C = {tempF:F1}°F [{classification}] InSpec={inSpec}\");\nWriteTag(\"Output/TempClass\", classification);\nreturn tempF;",
            "classdef" => "// Define a reusable class inside the script\nclass PidController\n{\n    public double Kp { get; }\n    public double Ki { get; }\n    public double Kd { get; }\n    private double _integral;\n    private double _prevError;\n\n    public PidController(double kp, double ki, double kd)\n    {\n        Kp = kp; Ki = ki; Kd = kd;\n    }\n\n    public double Compute(double setpoint, double actual, double dt)\n    {\n        var error = setpoint - actual;\n        _integral += error * dt;\n        var derivative = (error - _prevError) / dt;\n        _prevError = error;\n        return Kp * error + Ki * _integral + Kd * derivative;\n    }\n}\n\n// Use the PID controller\nvar pid = new PidController(kp: 1.2, ki: 0.3, kd: 0.05);\nvar setpoint = ReadTagDouble(\"Control/Setpoint\");\nvar measured = ReadTagDouble(\"Sensor/Level\");\n\nvar output = pid.Compute(setpoint, measured, dt: 0.5);\nvar clampedOutput = Clamp(output, 0, 100);\n\nWriteTag(\"Control/ValvePosition\", clampedOutput);\nLog($\"SP={setpoint:F1} PV={measured:F1} OUT={clampedOutput:F1}\");\nreturn clampedOutput;",
            "regex" => "// Parse structured tag data using Regex\nvar rawData = ReadTagString(\"Device/StatusMessage\");\n\nvar pattern = new Regex(@\"(\\w+)=(\\S+)\");\nvar matches = pattern.Matches(rawData);\nvar parsed = new Dictionary<string, string>();\n\nforeach (Match m in matches)\n    parsed[m.Groups[1].Value] = m.Groups[2].Value;\n\nif (parsed.TryGetValue(\"rpm\", out var rpmStr) && double.TryParse(rpmStr, out var rpm))\n{\n    WriteTag(\"Parsed/RPM\", rpm);\n    Log($\"Parsed RPM: {rpm}\");\n}\n\nreturn ToJson(parsed);",
            "alarm" => "// Multi-level alarm detection with hysteresis\nvar temp = ReadTagDouble(\"Process/Temperature\");\nvar prevLevel = GetState<string>(\"alarmLevel\", \"NORMAL\");\n\nstring DetermineLevel(double t, string prev)\n{\n    // Use hysteresis to prevent alarm chatter\n    return prev switch\n    {\n        \"NORMAL\" when t > 85 => \"HIGH\",\n        \"NORMAL\" when t > 70 => \"WARNING\",\n        \"WARNING\" when t > 85 => \"HIGH\",\n        \"WARNING\" when t < 65 => \"NORMAL\",\n        \"HIGH\" when t < 75 => \"WARNING\",\n        _ => prev\n    };\n}\n\nvar newLevel = DetermineLevel(temp, prevLevel);\nSetState(\"alarmLevel\", newLevel);\n\nif (newLevel != prevLevel)\n    Log($\"Alarm changed: {prevLevel} -> {newLevel} (temp={temp:F1})\");\n\nWriteTag(\"Alarms/TempLevel\", newLevel);\nWriteTag(\"Alarms/TempActive\", newLevel != \"NORMAL\");\nreturn newLevel;",
            _ => ""
        };

        if (!string.IsNullOrEmpty(template))
        {
            Code = template;
            await _editor.SetValue(template);
            await CodeChanged.InvokeAsync(template);
            _debounceTimer?.Stop();
            _debounceTimer?.Start();
        }
    }

    public async Task SetCodeAsync(string code)
    {
        Code = code;
        if (_editor != null)
        {
            await _editor.SetValue(code);
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
    }

    // ─── API Reference Data ─────────────────────────────────────

    private record ApiEntry(string Signature, string Description);
    private record ApiSection(string Title, List<ApiEntry> Entries);

    private static readonly List<ApiSection> _apiSections = new()
    {
        new("Tag Read", new()
        {
            new("ReadTag(path)", "Read raw value"),
            new("ReadTagDouble(path)", "Read as double"),
            new("ReadTagInt(path)", "Read as int"),
            new("ReadTagBool(path)", "Read as bool"),
            new("ReadTagString(path)", "Read as string"),
        }),
        new("Tag Write", new()
        {
            new("WriteTag(path, val)", "Write single tag"),
            new("WriteTags(dict)", "Write multiple tags"),
        }),
        new("State", new()
        {
            new("GetState(key)", "Get state value"),
            new("GetState<T>(key, def)", "Get typed state"),
            new("SetState(key, val)", "Set state value"),
            new("HasState(key)", "Check key exists"),
            new("ClearState(key)", "Remove key"),
        }),
        new("Logging", new()
        {
            new("Log(msg)", "Log a message"),
            new("Log(fmt, args)", "Log formatted"),
        }),
        new("Timing", new()
        {
            new("UtcNow", "Current UTC time"),
            new("Delay(ms)", "Pause (max 5s)"),
        }),
        new("Helpers", new()
        {
            new("Clamp(v, min, max)", "Clamp numeric"),
            new("Scale(v, i0,i1,o0,o1)", "Linear scale"),
            new("ParseJson(str)", "JSON → dict"),
            new("ToJson(obj)", "Object → JSON"),
        }),
        new("Input/Output", new()
        {
            new("Input", "Previous node value"),
            new("return expr", "Pass to next node"),
        }),
    };
}
