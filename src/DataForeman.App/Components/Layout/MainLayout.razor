@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject AppStateService AppState
@inject AuthStateProvider AuthProvider
@implements IDisposable

<div class="app-container">
    <!-- Minimal Top Menu Bar using SfAppBar -->
    <SfAppBar ColorMode="AppBarColor.Dark">
        <span class="brand-icon">⚙</span>
        <span class="brand-name">DataForeman</span>
        <AppBarSpacer></AppBarSpacer>
        <SfButton CssClass="@NavBtnClass("/")" @onclick='() => NavigateTo("/")'>Home</SfButton>
        @if (AppState.HasPermission("dashboards", "read"))
        {
            <SfButton CssClass="@NavBtnClass("/dashboards")" @onclick='() => NavigateTo("/dashboards")'>Dashboards</SfButton>
        }
        @if (AppState.HasPermission("connectivity", "read"))
        {
            <SfButton CssClass="@NavBtnClass("/connectivity")" @onclick='() => NavigateTo("/connectivity")'>Connectivity</SfButton>
        }
        <SfButton CssClass="@NavBtnClass("/internal-tags")" @onclick='() => NavigateTo("/internal-tags")'>Internal Tags</SfButton>
        @if (AppState.HasPermission("charts", "read"))
        {
            <SfButton CssClass="@NavBtnClass("/charts")" @onclick='() => NavigateTo("/charts")'>Charts</SfButton>
        }
        @if (AppState.HasPermission("flows", "read"))
        {
            <SfButton CssClass="@NavBtnClass("/flows")" @onclick='() => NavigateTo("/flows")'>Flows</SfButton>
        }
        @if (AppState.HasPermission("state_machines", "read"))
        {
            <SfButton CssClass="@NavBtnClass("/state-machines")" @onclick='() => NavigateTo("/state-machines")'>State Machines</SfButton>
        }
        @if (AppState.HasPermission("trends", "read"))
        {
            <SfButton CssClass="@NavBtnClass("/trends")" @onclick='() => NavigateTo("/trends")'>Trends</SfButton>
        }
        @if (AppState.HasPermission("diagnostics", "read"))
        {
            <SfButton CssClass="@NavBtnClass("/diagnostic")" @onclick='() => NavigateTo("/diagnostic")'>Diagnostic</SfButton>
        }
        @if (AppState.HasPermission("users", "read"))
        {
            <SfButton CssClass="@NavBtnClass("/users")" @onclick='() => NavigateTo("/users")'>Users</SfButton>
        }
        <AppBarSpacer></AppBarSpacer>
        <div class="engine-status @(EngineConnected ? "connected" : "disconnected")">
            <span class="status-dot">●</span>
            <span>Engine: @(EngineConnected ? "Online" : "Offline")</span>
        </div>
        <span class="user-label">@UserDisplayName</span>
        <SfButton CssClass="e-flat nav-btn" IconCss="fa-solid fa-right-from-bracket" @onclick="SignOut" title="Sign Out"></SfButton>
    </SfAppBar>

    <!-- Global toast container for user feedback -->
    <SfToast @ref="_toast"
             CssClass="df-toast" ShowCloseButton="true" NewestOnTop="true">
        <ToastPosition X="Right" Y="Top"></ToastPosition>
    </SfToast>
    
    <!-- Main Content -->
    <main class="main-content">
        @Body
    </main>
</div>

@code {
    [Inject] private Services.RealtimeDataService? RealtimeData { get; set; }
    
    private SfToast? _toast;
    private bool EngineConnected => RealtimeData?.GetEngineStatus()?.IsRunning ?? false;
    private string UserDisplayName = "";
    
    /// <summary>
    /// Accessible to child pages via CascadingValue or direct call through the static instance.
    /// </summary>
    internal static MainLayout? Instance { get; private set; }

    protected override void OnInitialized()
    {
        Instance = this;
        if (RealtimeData != null)
        {
            RealtimeData.OnEngineStatusChanged += HandleStatusChanged;
        }
        Navigation.LocationChanged += OnLocationChanged;
        AppState.OnChange += HandleStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadUserInfo();
            StateHasChanged();
        }
    }

    private async Task LoadUserInfo()
    {
        try
        {
            var user = await AuthProvider.GetCurrentUserAsync();
            if (user != null)
            {
                AppState.SetCurrentUser(user);
                UserDisplayName = user.DisplayName ?? user.Email;
            }
        }
        catch
        {
            // Expected during prerendering
        }
    }
    
    private void HandleStatusChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    private void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        StateHasChanged();
    }
    
    private void NavigateTo(string url)
    {
        Navigation.NavigateTo(url);
    }

    private async Task SignOut()
    {
        await AuthProvider.LogoutAsync();
        AppState.Clear();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    /// <summary>
    /// Returns the CSS class for a nav button, highlighting the active page.
    /// </summary>
    private string NavBtnClass(string href)
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var path = uri.AbsolutePath.TrimEnd('/');
        var target = href.TrimEnd('/');

        bool active = (target == "" && path == "") ||
                      (target != "" && path.StartsWith(target, StringComparison.OrdinalIgnoreCase));

        return active ? "e-flat nav-btn nav-active" : "e-flat nav-btn";
    }

    /// <summary>
    /// Shows a toast notification from any page.
    /// </summary>
    internal async Task ShowToastAsync(string message, string cssClass = "e-toast-success", string title = "")
    {
        if (_toast == null) return;
        await _toast.ShowAsync(new ToastModel
        {
            Title = title,
            Content = message,
            CssClass = cssClass,
            Timeout = 3000
        });
    }

    public void Dispose()
    {
        Instance = null;
        if (RealtimeData != null)
        {
            RealtimeData.OnEngineStatusChanged -= HandleStatusChanged;
        }
        Navigation.LocationChanged -= OnLocationChanged;
        AppState.OnChange -= HandleStateChanged;
    }
}
