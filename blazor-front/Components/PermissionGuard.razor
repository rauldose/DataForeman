@* 
    PermissionGuard Component - Blazor equivalent of React's PermissionGuard.
    Conditionally renders child content based on user permissions.
    
    Usage:
        <PermissionGuard Feature="flows" Operation="update">
            <SfButton Content="Save" OnClick="@SaveFlow" />
        </PermissionGuard>
        
        <PermissionGuard Feature="flows" Operation="delete" ShowFallback="true" FallbackMessage="No permission to delete">
            <SfButton Content="Delete" OnClick="@DeleteFlow" />
        </PermissionGuard>
*@

@inject AppStateService AppState

@if (HasRequiredPermission())
{
    @ChildContent
}
else if (ShowFallback)
{
    <span class="permission-denied" title="@FallbackMessage">@FallbackMessage</span>
}

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string Feature { get; set; } = "";
    [Parameter] public string Operation { get; set; } = "read";
    [Parameter] public bool RequireAll { get; set; } = false;
    [Parameter] public bool ShowFallback { get; set; } = false;
    [Parameter] public string FallbackMessage { get; set; } = "Insufficient permissions";

    private bool HasRequiredPermission()
    {
        if (string.IsNullOrEmpty(Feature))
            return true;

        // Support comma-separated operations (e.g., "create,update")
        if (Operation.Contains(','))
        {
            var operations = Operation.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            if (RequireAll)
            {
                return operations.All(op => AppState.HasPermission(Feature, op));
            }
            return operations.Any(op => AppState.HasPermission(Feature, op));
        }

        return AppState.HasPermission(Feature, Operation);
    }
}
