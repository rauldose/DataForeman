@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager Navigation
@inject CustomAuthStateProvider AuthProvider
@inject AppStateService AppState

<div class="page-wrapper">
    <nav class="sidebar @(SidebarToggle ? "expanded" : "collapsed")">
        <div class="sidebar-header">
            <span class="sidebar-logo e-icons e-settings"></span>
            @if (SidebarToggle)
            {
                <span class="sidebar-title">DataForeman</span>
            }
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item @(IsActive("/") ? "active" : "")">
                <a href="/">
                    <span class="menu-icon e-icons e-chart"></span>
                    @if (SidebarToggle) { <span class="menu-text">Dashboard</span> }
                </a>
            </li>
            <li class="menu-item @(IsActive("/flows") ? "active" : "")">
                <a href="/flows">
                    <span class="menu-icon e-icons e-flow"></span>
                    @if (SidebarToggle) { <span class="menu-text">Flow Studio</span> }
                </a>
            </li>
            <li class="menu-item @(IsActive("/charts") ? "active" : "")">
                <a href="/charts">
                    <span class="menu-icon e-icons e-line-chart"></span>
                    @if (SidebarToggle) { <span class="menu-text">Chart Composer</span> }
                </a>
            </li>
            <li class="menu-item @(IsActive("/connectivity") ? "active" : "")">
                <a href="/connectivity">
                    <span class="menu-icon e-icons e-link"></span>
                    @if (SidebarToggle) { <span class="menu-text">Connectivity</span> }
                </a>
            </li>
            <li class="menu-item @(IsActive("/diagnostics") ? "active" : "")">
                <a href="/diagnostics">
                    <span class="menu-icon e-icons e-diagnose"></span>
                    @if (SidebarToggle) { <span class="menu-text">Diagnostics</span> }
                </a>
            </li>
            @if (ShowUsersMenu)
            {
                <li class="menu-item @(IsActive("/users") ? "active" : "")">
                    <a href="/users">
                        <span class="menu-icon e-icons e-people"></span>
                        @if (SidebarToggle) { <span class="menu-text">Users</span> }
                    </a>
                </li>
            }
        </ul>
    </nav>
    
    <div class="main-content">
        <header class="top-bar">
            <button class="sidebar-toggle-btn" @onclick="ToggleSidebar">
                <span>☰</span>
            </button>
            <div class="top-bar-title">DataForeman</div>
            <div class="top-bar-actions">
                <div class="user-menu">
                    <SfButton CssClass="e-flat" IconCss="e-icons e-user" Content="@UserName" OnClick="@ToggleUserMenu"></SfButton>
                    @if (ShowUserMenu)
                    {
                        <div class="user-dropdown-menu">
                            <div class="user-dropdown-item" @onclick="@GoToProfile">
                                <span class="menu-icon e-icons e-user"></span>
                                <span>My Profile</span>
                            </div>
                            <div class="user-dropdown-item" @onclick="@SignOut">
                                <span class="menu-icon e-icons e-exit"></span>
                                <span>Sign Out</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </header>
        
        <main class="page-content">
            @Body
        </main>
    </div>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool SidebarToggle = true;
    private string UserName = "User";
    private bool ShowUsersMenu = false;
    private bool ShowUserMenu = false;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        AppState.OnChange += StateHasChanged;
    }
    
    private async Task LoadUserInfo()
    {
        try
        {
            var user = await AuthProvider.GetCurrentUserAsync();
            if (user != null)
            {
                UserName = user.DisplayName ?? user.Email;
                AppState.SetCurrentUser(user);
                
                // Load permissions
                await AppState.LoadPermissionsAsync(user.Id);
                ShowUsersMenu = AppState.HasPermission("users", "read");
            }
        }
        catch (Exception)
        {
            // User info not available - will be redirected to login if not authenticated
        }
    }
    
    private void ToggleSidebar()
    {
        SidebarToggle = !SidebarToggle;
    }
    
    private void ToggleUserMenu()
    {
        ShowUserMenu = !ShowUserMenu;
    }
    
    private bool IsActive(string path)
    {
        var currentPath = Navigation.ToBaseRelativePath(Navigation.Uri);
        if (path == "/")
        {
            return string.IsNullOrEmpty(currentPath);
        }
        var fullPath = string.IsNullOrEmpty(currentPath) ? "/" : "/" + currentPath;
        return fullPath.StartsWith(path);
    }
    
    private void GoToProfile()
    {
        ShowUserMenu = false;
        Navigation.NavigateTo("/profile");
    }
    
    private async Task SignOut()
    {
        ShowUserMenu = false;
        await AuthProvider.LogoutAsync();
        AppState.Clear();
        Navigation.NavigateTo("/login");
    }
    
    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}
