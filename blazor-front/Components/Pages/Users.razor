@page "/users"
@rendermode InteractiveServer
@using DataForeman.BlazorUI.Services
@inject DataService DataService
@inject AppStateService AppState
@attribute [Authorize]

<PageTitle>Users - DataForeman</PageTitle>

<div class="users-page">
    <div class="page-header">
        <h1>Users</h1>
        <div class="page-actions">
            @if (AppState.HasPermission("users", "create"))
            {
                <SfButton CssClass="e-primary" IconCss="e-icons e-plus" Content="Add User" OnClick="@OpenAddUserDialog"></SfButton>
            }
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="loading-indicator">
            <SfSpinner Visible="true"></SfSpinner>
            <span>Loading users...</span>
        </div>
    }
    else
    {
        <SfGrid DataSource="@UsersList" AllowPaging="true" AllowSorting="true" AllowFiltering="true">
            <GridColumns>
                <GridColumn Field="@nameof(UserListItem.Email)" HeaderText="Email" Width="250"></GridColumn>
                <GridColumn Field="@nameof(UserListItem.DisplayName)" HeaderText="Display Name" Width="200"></GridColumn>
                <GridColumn HeaderText="Status" Width="100">
                    <Template>
                        @{
                            var user = context as UserListItem;
                            if (user != null)
                            {
                                <span class="status-badge @(user.IsActive ? "active" : "inactive")">
                                    @(user.IsActive ? "Active" : "Inactive")
                                </span>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(UserListItem.CreatedAt)" HeaderText="Created" Width="150" Format="g"></GridColumn>
                <GridColumn Field="@nameof(UserListItem.LastLoginAt)" HeaderText="Last Login" Width="150" Format="g"></GridColumn>
                <GridColumn HeaderText="Actions" Width="150">
                    <Template>
                        @{
                            var user = context as UserListItem;
                            if (user != null)
                            {
                                <div class="action-buttons">
                                    @if (AppState.HasPermission("users", "update"))
                                    {
                                        <SfButton CssClass="e-flat e-small" IconCss="e-icons e-edit" OnClick="@(() => EditUser(user))" title="Edit"></SfButton>
                                        <SfButton CssClass="e-flat e-small" IconCss="e-icons e-key" OnClick="@(() => ManagePermissions(user))" title="Permissions"></SfButton>
                                    }
                                    @if (AppState.HasPermission("users", "delete"))
                                    {
                                        <SfButton CssClass="e-flat e-small e-danger" IconCss="e-icons e-delete" OnClick="@(() => DeleteUser(user))" title="Delete"></SfButton>
                                    }
                                </div>
                            }
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
        </SfGrid>
    }
</div>

@* Add/Edit User Dialog *@
<SfDialog @bind-Visible="ShowUserDialog" Header="@(IsEditMode ? "Edit User" : "Add User")" Width="500px" IsModal="true">
    <DialogTemplates>
        <Content>
            <div class="dialog-form">
                @if (!string.IsNullOrEmpty(_validationError))
                {
                    <div class="validation-error">
                        <span class="e-icons e-circle-close"></span>
                        @_validationError
                    </div>
                }
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <SfTextBox @bind-Value="EditingUser.Email" Placeholder="Enter email address" Enabled="@(!IsEditMode)"></SfTextBox>
                </div>
                <div class="form-group">
                    <label>Display Name</label>
                    <SfTextBox @bind-Value="EditingUser.DisplayName" Placeholder="Enter display name"></SfTextBox>
                </div>
                @if (!IsEditMode)
                {
                    <div class="form-group">
                        <label>Password <span class="required">*</span></label>
                        <SfTextBox @bind-Value="EditingUser.Password" Placeholder="Minimum 8 characters" Type="InputType.Password"></SfTextBox>
                        <span class="field-hint">Minimum 8 characters</span>
                    </div>
                }
                <div class="form-group">
                    <label>Active</label>
                    <SfSwitch @bind-Checked="EditingUser.IsActive" TChecked="bool"></SfSwitch>
                </div>
            </div>
        </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="Cancel" OnClick="@CloseUserDialog"></DialogButton>
        <DialogButton Content="@(IsEditMode ? "Update" : "Create")" IsPrimary="true" OnClick="@SaveUser"></DialogButton>
    </DialogButtons>
</SfDialog>

@* Delete Confirmation Dialog *@
<SfDialog @bind-Visible="ShowDeleteConfirmDialog" Header="Confirm Delete" Width="400px" IsModal="true">
    <DialogTemplates>
        <Content>
            <p>Are you sure you want to delete user <strong>@UserToDelete?.Email</strong>?</p>
            <p style="color: #ff5252; font-size: 13px;">This action cannot be undone.</p>
        </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="Cancel" OnClick="@(() => ShowDeleteConfirmDialog = false)"></DialogButton>
        <DialogButton Content="Delete" IsPrimary="true" CssClass="e-danger" OnClick="@ConfirmDeleteUser"></DialogButton>
    </DialogButtons>
</SfDialog>

@* Toast Notification *@
@if (_showToast)
{
    <div class="toast-notification @_toastType">
        <span class="e-icons @(_toastType == "success" ? "e-check" : "e-close")"></span>
        <span>@_toastMessage</span>
    </div>
}

@* Permissions Dialog *@
<SfDialog @bind-Visible="ShowPermissionsDialog" Header="@($"Permissions - {SelectedUser?.Email}")" Width="700px" IsModal="true">
    <DialogTemplates>
        <Content>
            <div class="permissions-form">
                <SfGrid DataSource="@UserPermissions" AllowPaging="false">
                    <GridEditSettings AllowEditing="true" Mode="EditMode.Normal"></GridEditSettings>
                    <GridColumns>
                        <GridColumn Field="@nameof(UserPermissionInfo.Feature)" HeaderText="Feature" Width="200" IsPrimaryKey="true" AllowEditing="false"></GridColumn>
                        <GridColumn Field="@nameof(UserPermissionInfo.CanRead)" HeaderText="Read" Width="80">
                            <Template>
                                @{
                                    var perm = context as UserPermissionInfo;
                                    if (perm != null)
                                    {
                                        <SfCheckBox @bind-Checked="perm.CanRead" TChecked="bool"></SfCheckBox>
                                    }
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field="@nameof(UserPermissionInfo.CanCreate)" HeaderText="Create" Width="80">
                            <Template>
                                @{
                                    var perm = context as UserPermissionInfo;
                                    if (perm != null)
                                    {
                                        <SfCheckBox @bind-Checked="perm.CanCreate" TChecked="bool"></SfCheckBox>
                                    }
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field="@nameof(UserPermissionInfo.CanUpdate)" HeaderText="Update" Width="80">
                            <Template>
                                @{
                                    var perm = context as UserPermissionInfo;
                                    if (perm != null)
                                    {
                                        <SfCheckBox @bind-Checked="perm.CanUpdate" TChecked="bool"></SfCheckBox>
                                    }
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field="@nameof(UserPermissionInfo.CanDelete)" HeaderText="Delete" Width="80">
                            <Template>
                                @{
                                    var perm = context as UserPermissionInfo;
                                    if (perm != null)
                                    {
                                        <SfCheckBox @bind-Checked="perm.CanDelete" TChecked="bool"></SfCheckBox>
                                    }
                                }
                            </Template>
                        </GridColumn>
                    </GridColumns>
                </SfGrid>
            </div>
        </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="Cancel" OnClick="@ClosePermissionsDialog"></DialogButton>
        <DialogButton Content="Save Permissions" IsPrimary="true" OnClick="@SavePermissions"></DialogButton>
    </DialogButtons>
</SfDialog>

<style>
    .status-badge.active {
        background: rgba(34, 197, 94, 0.2);
        color: var(--status-ok);
    }

    .status-badge.inactive {
        background: rgba(107, 114, 128, 0.2);
        color: var(--text-muted);
    }

    .permissions-form {
        max-height: 400px;
        overflow-y: auto;
    }
</style>

@code {
    private bool IsLoading = true;
    private List<UserListItem> UsersList = new();

    // Dialog state
    private bool ShowUserDialog = false;
    private bool IsEditMode = false;
    private EditUserModel EditingUser = new();

    private bool ShowPermissionsDialog = false;
    private UserListItem? SelectedUser;
    private List<UserPermissionInfo> UserPermissions = new();

    // Delete confirmation
    private bool ShowDeleteConfirmDialog = false;
    private UserListItem? UserToDelete;

    // Toast notifications
    private bool _showToast = false;
    private string _toastMessage = "";
    private string _toastType = "success"; // success or error

    // Validation
    private string? _validationError;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        IsLoading = true;
        try
        {
            var (users, _) = await DataService.GetUsersAsync();
            if (users != null)
            {
                UsersList = users.Select(u => new UserListItem
                {
                    Id = u.Id,
                    Email = u.Email,
                    DisplayName = u.DisplayName,
                    IsActive = u.IsActive,
                    CreatedAt = u.CreatedAt,
                    LastLoginAt = u.UpdatedAt
                }).ToList();
            }
        }
        catch (Exception ex)
        {
            // Handle error
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void OpenAddUserDialog()
    {
        EditingUser = new EditUserModel { IsActive = true };
        IsEditMode = false;
        ShowUserDialog = true;
    }

    private void EditUser(UserListItem user)
    {
        EditingUser = new EditUserModel
        {
            Id = user.Id,
            Email = user.Email,
            DisplayName = user.DisplayName ?? "",
            IsActive = user.IsActive
        };
        IsEditMode = true;
        ShowUserDialog = true;
    }

    private void CloseUserDialog()
    {
        ShowUserDialog = false;
    }

    private async Task SaveUser()
    {
        _validationError = null;

        // Validate email format
        if (string.IsNullOrWhiteSpace(EditingUser.Email) || !EditingUser.Email.Contains("@"))
        {
            _validationError = "Please enter a valid email address";
            return;
        }

        if (IsEditMode)
        {
            var success = await DataService.UpdateUserAsync(
                EditingUser.Id,
                EditingUser.DisplayName,
                null, // Don't update email
                EditingUser.IsActive,
                null // Password not changed
            );

            if (success)
            {
                _toastMessage = "User updated successfully";
                _toastType = "success";
            }
            else
            {
                _toastMessage = "Failed to update user";
                _toastType = "error";
            }
        }
        else
        {
            // Validate password for new users
            if (string.IsNullOrWhiteSpace(EditingUser.Password))
            {
                _validationError = "Password is required";
                return;
            }
            if (EditingUser.Password.Length < 8)
            {
                _validationError = "Password must be at least 8 characters";
                return;
            }

            var user = await DataService.CreateUserAsync(EditingUser.Email, EditingUser.Password, EditingUser.DisplayName);
            if (user != null)
            {
                _toastMessage = "User created successfully";
                _toastType = "success";
            }
            else
            {
                _toastMessage = "Failed to create user (email may already exist)";
                _toastType = "error";
            }
        }

        _showToast = true;
        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            _showToast = false;
            InvokeAsync(StateHasChanged);
        });

        ShowUserDialog = false;
        await LoadUsers();
    }

    private void DeleteUser(UserListItem user)
    {
        UserToDelete = user;
        ShowDeleteConfirmDialog = true;
    }

    private async Task ConfirmDeleteUser()
    {
        if (UserToDelete != null)
        {
            var success = await DataService.DeleteUserAsync(UserToDelete.Id);
            if (success)
            {
                _toastMessage = "User deleted successfully";
                _toastType = "success";
            }
            else
            {
                _toastMessage = "Failed to delete user";
                _toastType = "error";
            }
            _showToast = true;
            _ = Task.Delay(3000).ContinueWith(_ =>
            {
                _showToast = false;
                InvokeAsync(StateHasChanged);
            });

            await LoadUsers();
        }
        ShowDeleteConfirmDialog = false;
        UserToDelete = null;
    }

    private async Task ManagePermissions(UserListItem user)
    {
        SelectedUser = user;
        var permissions = await DataService.GetUserPermissionsAsync(user.Id);
        
        if (permissions != null)
        {
            UserPermissions = permissions.Select(p => new UserPermissionInfo
            {
                Feature = p.Feature,
                CanCreate = p.CanCreate,
                CanRead = p.CanRead,
                CanUpdate = p.CanUpdate,
                CanDelete = p.CanDelete
            }).ToList();
        }
        else
        {
            // Default permissions
            UserPermissions = new List<UserPermissionInfo>
            {
                new() { Feature = "dashboards", CanRead = true, CanCreate = true, CanUpdate = true, CanDelete = false },
                new() { Feature = "flows", CanRead = true, CanCreate = true, CanUpdate = true, CanDelete = false },
                new() { Feature = "chart_composer", CanRead = true, CanCreate = true, CanUpdate = true, CanDelete = false },
                new() { Feature = "connectivity.devices", CanRead = true, CanCreate = false, CanUpdate = false, CanDelete = false },
                new() { Feature = "connectivity.tags", CanRead = true, CanCreate = false, CanUpdate = false, CanDelete = false },
                new() { Feature = "diagnostics", CanRead = true, CanCreate = false, CanUpdate = false, CanDelete = false },
                new() { Feature = "users", CanRead = false, CanCreate = false, CanUpdate = false, CanDelete = false }
            };
        }
        
        ShowPermissionsDialog = true;
    }

    private void ClosePermissionsDialog()
    {
        ShowPermissionsDialog = false;
        SelectedUser = null;
    }

    private async Task SavePermissions()
    {
        if (SelectedUser != null)
        {
            var permissionUpdates = UserPermissions.Select(p => new UserPermissionUpdate
            {
                Feature = p.Feature,
                CanCreate = p.CanCreate,
                CanRead = p.CanRead,
                CanUpdate = p.CanUpdate,
                CanDelete = p.CanDelete
            }).ToList();

            var success = await DataService.UpdateUserPermissionsAsync(SelectedUser.Id, permissionUpdates);
            if (success)
            {
                _toastMessage = "Permissions saved successfully";
                _toastType = "success";
            }
            else
            {
                _toastMessage = "Failed to save permissions";
                _toastType = "error";
            }
            _showToast = true;
            StateHasChanged();

            // Auto-hide toast after 3 seconds
            _ = Task.Delay(3000).ContinueWith(_ =>
            {
                _showToast = false;
                InvokeAsync(StateHasChanged);
            });
        }
        ShowPermissionsDialog = false;
    }

    class EditUserModel
    {
        public Guid Id { get; set; }
        public string Email { get; set; } = "";
        public string? DisplayName { get; set; }
        public string? Password { get; set; }
        public bool IsActive { get; set; }
    }
}
