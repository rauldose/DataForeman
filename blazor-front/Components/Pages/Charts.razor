@page "/charts"
@rendermode InteractiveServer
@using DataForeman.BlazorUI.Services
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Navigations
@using System.Text.Json
@inject DataService DataService
@inject AppStateService AppState
@implements IDisposable

<PageTitle>Chart Composer - DataForeman</PageTitle>

<div class="charts-page">
    <div class="page-header">
        <h1>Chart Composer</h1>
        <div class="page-actions">
            <PermissionGuard Feature="charts" Operation="create">
                <SfButton CssClass="e-primary" IconCss="e-icons e-plus" Content="New Chart" OnClick="@CreateNewChart"></SfButton>
            </PermissionGuard>
        </div>
    </div>
    
    @if (IsLoading)
    {
        <div class="loading-indicator">Loading charts...</div>
    }
    else
    {
        <div class="charts-container">
            <div class="charts-sidebar">
                <h3>Saved Charts</h3>
                @if (SavedCharts.Count == 0)
                {
                    <p class="no-items">No charts saved yet</p>
                }
                else
                {
                    <SfListView TValue="ChartListItem" DataSource="@SavedCharts" ShowHeader="false" CssClass="chart-list">
                        <ListViewFieldSettings TValue="ChartListItem" Id="Id" Text="Name"></ListViewFieldSettings>
                        <ListViewTemplates TValue="ChartListItem">
                            <Template>
                                @{
                                    var chart = context as ChartListItem;
                                    if (chart != null)
                                    {
                                        <div class="chart-list-item @(SelectedChart?.Id == chart.Id ? "selected" : "")" @onclick="@(() => SelectChart(chart))">
                                            <span class="chart-icon e-icons e-line-chart"></span>
                                            <div class="chart-info">
                                                <span class="chart-name">@chart.Name</span>
                                                <span class="chart-type">@chart.ChartType</span>
                                            </div>
                                        </div>
                                    }
                                }
                            </Template>
                        </ListViewTemplates>
                    </SfListView>
                }
                
                <h3>Available Tags</h3>
                <p class="help-text">Click a tag to add it to the chart</p>
                <SfTextBox Placeholder="Search tags..." @bind-Value="TagSearchQuery" CssClass="tag-search"></SfTextBox>
                <div class="tag-list">
                    @if (FilteredTags.Count == 0)
                    {
                        <p class="no-items">No tags available</p>
                    }
                    else
                    {
                        @foreach (var tag in FilteredTags)
                        {
                            <div class="tag-item" @onclick="@(() => AddTagToChart(tag))" title="Click to add to chart">
                                <span class="tag-icon e-icons e-bookmark"></span>
                                <span class="tag-path">@tag.Path</span>
                                <span class="add-icon">+</span>
                            </div>
                        }
                    }
                </div>
            </div>
            
            <div class="chart-editor">
                @if (SelectedChart != null)
                {
                    <div class="chart-toolbar">
                        <SfTextBox @bind-Value="SelectedChart.Name" Placeholder="Chart Name" CssClass="chart-name-input"></SfTextBox>
                        <SfDropDownList TItem="string" TValue="string" DataSource="@ChartTypes" @bind-Value="SelectedChart.ChartType" Placeholder="Chart Type"></SfDropDownList>
                        <div class="toolbar-spacer"></div>
                        @if (_showSaveMessage)
                        {
                            <span class="save-message">@_saveMessage</span>
                        }
                        <SfDropDownList TItem="TimeRangeOption" TValue="string" DataSource="@TimeRanges" @bind-Value="SelectedTimeRange" Placeholder="Time Range">
                            <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                        </SfDropDownList>
                        @if (SelectedTimeRange == "custom")
                        {
                            <SfDateTimePicker @bind-Value="@CustomStartDate" Placeholder="Start Date" Format="yyyy-MM-dd HH:mm" CssClass="custom-date-picker"></SfDateTimePicker>
                            <span class="date-separator">to</span>
                            <SfDateTimePicker @bind-Value="@CustomEndDate" Placeholder="End Date" Format="yyyy-MM-dd HH:mm" CssClass="custom-date-picker"></SfDateTimePicker>
                        }
                        <SfButton CssClass="e-outline" IconCss="e-icons e-refresh" Content="Refresh"></SfButton>
                        <PermissionGuard Feature="charts" Operation="update">
                            <SfButton CssClass="e-primary" IconCss="e-icons e-save" Content="Save" OnClick="@SaveChart"></SfButton>
                        </PermissionGuard>
                    </div>
                    
                    <div class="chart-content-area">
                        <div class="chart-preview">
                            @if (ChartSeries.Count > 0 && ChartSeries.Any(s => s.Visible && s.Data?.Count > 0))
                            {
                                @if (SelectedChart.ChartType.Equals("Line", StringComparison.OrdinalIgnoreCase))
                                {
                                    <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                        <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" LabelFormat="HH:mm:ss"></ChartPrimaryXAxis>
                                        <ChartSeriesCollection>
                                            @foreach (var series in ChartSeries.Where(s => s.Visible && s.Data?.Count > 0))
                                            {
                                                <ChartSeries DataSource="@series.Data" XName="Timestamp" YName="Value" Name="@series.DisplayName" Type="ChartSeriesType.Spline" Opacity="@series.Opacity" Fill="@series.Color">
                                                </ChartSeries>
                                            }
                                        </ChartSeriesCollection>
                                    </SfChart>
                                }
                                else if (SelectedChart.ChartType.Equals("Bar", StringComparison.OrdinalIgnoreCase))
                                {
                                    <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                        <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Category"></ChartPrimaryXAxis>
                                        <ChartSeriesCollection>
                                            <ChartSeries DataSource="@BarChartData" XName="Category" YName="Value" Type="ChartSeriesType.Column">
                                            </ChartSeries>
                                        </ChartSeriesCollection>
                                    </SfChart>
                                }
                                else if (SelectedChart.ChartType.Equals("Area", StringComparison.OrdinalIgnoreCase))
                                {
                                    <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                        <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" LabelFormat="HH:mm:ss"></ChartPrimaryXAxis>
                                        <ChartSeriesCollection>
                                            @foreach (var series in ChartSeries.Where(s => s.Visible && s.Data?.Count > 0))
                                            {
                                                <ChartSeries DataSource="@series.Data" XName="Timestamp" YName="Value" Name="@series.DisplayName" Type="ChartSeriesType.SplineArea" Opacity="@series.Opacity" Fill="@series.Color">
                                                </ChartSeries>
                                            }
                                        </ChartSeriesCollection>
                                    </SfChart>
                                }
                            }
                            else
                            {
                                <div class="no-data">Add tags from the sidebar to display chart data</div>
                            }
                        </div>
                    
                        <div class="configuration-panel">
                            <SfTab CssClass="config-tabs">
                            <TabItems>
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Series Configuration"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <div class="tab-content">
                                            @if (ChartSeries.Count == 0)
                                            {
                                                <p class="no-items">No series added. Click tags from the sidebar to add series.</p>
                                            }
                                            else
                                            {
                                                @foreach (var series in ChartSeries)
                                                {
                                                    <div class="series-config-card">
                                                        <div class="config-header" @onclick="@(() => ToggleSeriesExpanded(series))">
                                                            <span class="expand-icon e-icons @(series.IsExpanded ? "e-chevron-down" : "e-chevron-right")"></span>
                                                            <span class="series-color-indicator" style="background: @series.Color"></span>
                                                            <span class="config-series-name">@series.DisplayName</span>
                                                            <div class="config-actions">
                                                                <SfSwitch TChecked="bool" Checked="@series.Visible" CheckedChanged="@((bool val) => { series.Visible = val; RefreshChart(); })" CssClass="visibility-switch" OnLabel="ON" OffLabel="OFF"></SfSwitch>
                                                                <SfButton CssClass="e-flat e-small" IconCss="e-icons e-delete" OnClick="@(() => RemoveSeries(series))"></SfButton>
                                                            </div>
                                                        </div>
                                                        @if (series.IsExpanded)
                                                        {
                                                            <div class="config-body">
                                                                <div class="config-section">
                                                                    <label class="config-label">Display Name</label>
                                                                    <SfTextBox Value="@series.DisplayName" ValueChanged="@((string val) => { series.DisplayName = val; RefreshChart(); })" Placeholder="Series name"></SfTextBox>
                                                                </div>
                                                                
                                                                <div class="config-row">
                                                                    <div class="config-section">
                                                                        <label class="config-label">Color</label>
                                                                        <SfColorPicker Value="@series.Color" ValueChanged="@((string val) => { series.Color = val; RefreshChart(); })" Mode="ColorPickerMode.Palette" ModeSwitcher="false"></SfColorPicker>
                                                                    </div>
                                                                    
                                                                    <div class="config-section">
                                                                        <label class="config-label">Line Type</label>
                                                                        <SfDropDownList TItem="string" TValue="string" Value="@series.LineType" ValueChanged="@((string val) => { series.LineType = val; RefreshChart(); })" DataSource="@LineTypes" Width="100%"></SfDropDownList>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="config-row">
                                                                    <div class="config-section">
                                                                        <label class="config-label">Line Width: @series.LineWidth.ToString("F1")</label>
                                                                        <SfSlider TValue="double" Value="@series.LineWidth" ValueChanged="@((double val) => { series.LineWidth = val; RefreshChart(); })" Min="0.5" Max="5" Step="0.5" Type="SliderType.MinRange">
                                                                            <SliderTicks Placement="Placement.After" ShowSmallTicks="false"></SliderTicks>
                                                                        </SfSlider>
                                                                    </div>
                                                                    
                                                                    <div class="config-section">
                                                                        <label class="config-label">Opacity: @series.Opacity.ToString("P0")</label>
                                                                        <SfSlider TValue="double" Value="@series.Opacity" ValueChanged="@((double val) => { series.Opacity = val; RefreshChart(); })" Min="0" Max="1" Step="0.1" Type="SliderType.MinRange">
                                                                            <SliderTicks Placement="Placement.After" ShowSmallTicks="false"></SliderTicks>
                                                                        </SfSlider>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="config-section">
                                                                    <label class="config-label">Dash Style</label>
                                                                    <SfDropDownList TItem="string" TValue="string" Value="@series.DashStyle" ValueChanged="@((string val) => { series.DashStyle = val; RefreshChart(); })" DataSource="@DashStyles" Width="100%"></SfDropDownList>
                                                                </div>
                                                                
                                                                <div class="config-row">
                                                                    <div class="config-section">
                                                                        <SfCheckBox TChecked="bool" Checked="@series.ShowMarkers" CheckedChanged="@((bool val) => { series.ShowMarkers = val; RefreshChart(); })" Label="Show Markers"></SfCheckBox>
                                                                    </div>
                                                                    
                                                                    @if (series.ShowMarkers)
                                                                    {
                                                                        <div class="config-section">
                                                                            <label class="config-label">Marker Size</label>
                                                                            <SfNumericTextBox TValue="int" Value="@series.MarkerSize" ValueChanged="@((int val) => { series.MarkerSize = val; RefreshChart(); })" Min="3" Max="12" Step="1" Width="100%"></SfNumericTextBox>
                                                                        </div>
                                                                    }
                                                                </div>
                                                                
                                                                <div class="config-section">
                                                                    <label class="config-label">Y-Axis Assignment</label>
                                                                    <SfDropDownList TItem="AxisOption" TValue="string" Value="@series.YAxisName" ValueChanged="@((string val) => { series.YAxisName = val; RefreshChart(); })" DataSource="@ChartAxes" Width="100%">
                                                                        <DropDownListFieldSettings Text="Label" Value="Name"></DropDownListFieldSettings>
                                                                    </SfDropDownList>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </ContentTemplate>
                                </TabItem>
                                
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Axes"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <div class="tab-content">
                                            <div class="axes-header">
                                                <span>Y-Axes</span>
                                                <SfButton CssClass="e-flat e-small" IconCss="e-icons e-plus" Content="Add Axis" OnClick="@AddYAxis"></SfButton>
                                            </div>
                                            
                                            @foreach (var axis in ChartAxes)
                                            {
                                                <div class="axis-config-card">
                                                    <div class="config-header" @onclick="@(() => axis.IsExpanded = !axis.IsExpanded)">
                                                        <span class="expand-icon e-icons @(axis.IsExpanded ? "e-chevron-down" : "e-chevron-right")"></span>
                                                        <span class="axis-color-indicator" style="background: @axis.Color"></span>
                                                        <span class="config-axis-name">@axis.Label</span>
                                                        <div class="config-actions">
                                                            <span class="axis-position">@(axis.OpposedPosition ? "Right" : "Left")</span>
                                                            @if (axis.Name != "primary")
                                                            {
                                                                <SfButton CssClass="e-flat e-small" IconCss="e-icons e-delete" OnClick="@(() => RemoveYAxis(axis))"></SfButton>
                                                            }
                                                        </div>
                                                    </div>
                                                    @if (axis.IsExpanded)
                                                    {
                                                        <div class="config-body">
                                                            <div class="config-section">
                                                                <label class="config-label">Axis Label</label>
                                                                <SfTextBox Value="@axis.Label" ValueChanged="@((string val) => { axis.Label = val; RefreshChart(); })" Placeholder="e.g., Temperature (°C)"></SfTextBox>
                                                            </div>
                                                            
                                                            <div class="config-row">
                                                                <div class="config-section">
                                                                    <label class="config-label">Position</label>
                                                                    <SfDropDownList TItem="string" TValue="string" Value="@(axis.OpposedPosition ? "Right" : "Left")" ValueChanged="@((string val) => { axis.OpposedPosition = val == "Right"; RefreshChart(); })" DataSource="@(new List<string> { "Left", "Right" })" Width="100%"></SfDropDownList>
                                                                </div>
                                                                <div class="config-section">
                                                                    <label class="config-label">Color</label>
                                                                    <SfColorPicker Value="@axis.Color" ValueChanged="@((string val) => { axis.Color = val; RefreshChart(); })" Mode="ColorPickerMode.Palette" ModeSwitcher="false"></SfColorPicker>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="config-section">
                                                                <SfCheckBox TChecked="bool" Checked="@axis.AutoScale" CheckedChanged="@((bool val) => { axis.AutoScale = val; RefreshChart(); })" Label="Auto Scale"></SfCheckBox>
                                                            </div>
                                                            
                                                            @if (!axis.AutoScale)
                                                            {
                                                                <div class="config-row">
                                                                    <div class="config-section">
                                                                        <label class="config-label">Minimum</label>
                                                                        <SfNumericTextBox TValue="double?" Value="@axis.Minimum" ValueChanged="@((double? val) => { axis.Minimum = val; RefreshChart(); })" Placeholder="Min" Width="100%"></SfNumericTextBox>
                                                                    </div>
                                                                    <div class="config-section">
                                                                        <label class="config-label">Maximum</label>
                                                                        <SfNumericTextBox TValue="double?" Value="@axis.Maximum" ValueChanged="@((double? val) => { axis.Maximum = val; RefreshChart(); })" Placeholder="Max" Width="100%"></SfNumericTextBox>
                                                                    </div>
                                                                </div>
                                                            }
                                                            
                                                            <div class="config-section">
                                                                <SfCheckBox TChecked="bool" Checked="@axis.ShowGridLines" CheckedChanged="@((bool val) => { axis.ShowGridLines = val; RefreshChart(); })" Label="Show Grid Lines"></SfCheckBox>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </ContentTemplate>
                                </TabItem>
                                
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Settings"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <div class="tab-content">
                                            <h4>Live Chart</h4>
                                            <div class="config-section">
                                                <SfSwitch TChecked="bool" Checked="@IsLiveMode" CheckedChanged="@ToggleLiveMode" OnLabel="LIVE" OffLabel="OFF" CssClass="live-switch"></SfSwitch>
                                                <span class="live-label @(IsLiveMode ? "active" : "")">@(IsLiveMode ? "● Live updating" : "Static view")</span>
                                            </div>
                                            
                                            @if (IsLiveMode)
                                            {
                                                <div class="config-section">
                                                    <label class="config-label">Update Interval (seconds)</label>
                                                    <SfNumericTextBox TValue="int" Value="@LiveUpdateIntervalSeconds" ValueChanged="@UpdateLiveInterval" Min="1" Max="60" Step="1" Width="100%"></SfNumericTextBox>
                                                </div>
                                            }
                                            
                                            <h4>Display Options</h4>
                                            <div class="config-section">
                                                <label class="config-label">Legend Position</label>
                                                <SfDropDownList TItem="string" TValue="string" Value="@LegendPosition" ValueChanged="@((string val) => { LegendPosition = val; RefreshChart(); })" DataSource="@LegendPositions" Width="100%"></SfDropDownList>
                                            </div>
                                            
                                            <div class="config-section">
                                                <SfCheckBox TChecked="bool" Checked="@ShowLegend" CheckedChanged="@((bool val) => { ShowLegend = val; RefreshChart(); })" Label="Show Legend"></SfCheckBox>
                                            </div>
                                            
                                            <div class="config-section">
                                                <SfCheckBox TChecked="bool" Checked="@ShowTooltip" CheckedChanged="@((bool val) => { ShowTooltip = val; RefreshChart(); })" Label="Enable Tooltip"></SfCheckBox>
                                            </div>
                                            
                                            <div class="config-section">
                                                <SfCheckBox TChecked="bool" Checked="@EnableZoom" CheckedChanged="@((bool val) => { EnableZoom = val; RefreshChart(); })" Label="Enable Zoom"></SfCheckBox>
                                            </div>
                                            
                                            <div class="config-section">
                                                <SfCheckBox TChecked="bool" Checked="@EnableCrosshair" CheckedChanged="@((bool val) => { EnableCrosshair = val; RefreshChart(); })" Label="Enable Crosshair"></SfCheckBox>
                                            </div>
                                        </div>
                                    </ContentTemplate>
                                </TabItem>
                                            </TabItems>
                                        </SfTab>
                                    </div>
                                </div>
                            }
                            else
                            {
                    <div class="no-chart-selected">
                        <span class="e-icons e-line-chart" style="font-size: 64px; margin-bottom: 16px;"></span>
                        <p>Select a chart to edit or create a new one</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .charts-page {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .page-header h1 {
        margin: 0;
    }
    
    .loading-indicator {
        text-align: center;
        padding: 40px;
        color: #9d9d9d;
    }
    
    .no-items {
        color: #9d9d9d;
        font-size: 13px;
        font-style: italic;
        padding: 8px 0;
    }
    
    .no-data {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #9d9d9d;
        font-style: italic;
    }
    
    .charts-container {
        display: flex;
        flex: 1;
        gap: 16px;
        overflow: hidden;
    }
    
    .charts-sidebar {
        width: 280px;
        background: #252526;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        max-height: calc(100vh - 200px);
    }
    
    .charts-sidebar h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #9d9d9d;
    }
    
    .chart-list-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        overflow: hidden;
        margin-bottom: 2px;
    }
    
    .chart-list-item:hover {
        background: #3c3c3c;
    }
    
    .chart-list-item.selected {
        background: #404040;
        border-left: 3px solid #4caf50;
        padding-left: 9px;
    }
    
    .chart-icon {
        font-size: 14px;
        color: #4caf50;
        flex-shrink: 0;
    }
    
    .chart-info {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 0;
        gap: 2px;
    }
    
    .chart-name {
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .chart-type {
        font-size: 12px;
        color: #9d9d9d;
    }
    
    .tag-search {
        margin-bottom: 12px;
    }
    
    .tag-list {
        flex: 1;
        overflow-y: auto;
        max-height: 400px;
    }
    
    .help-text {
        font-size: 11px;
        color: #9d9d9d;
        margin: 0 0 8px 0;
        font-style: italic;
    }
    
    .tag-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    
    .tag-item:hover {
        background: #3c3c3c;
        border-color: #4caf50;
    }
    
    .tag-item:hover .add-icon {
        opacity: 1;
    }
    
    .add-icon {
        margin-left: auto;
        color: #4caf50;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .tag-path {
        font-size: 13px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }
    
    .save-message {
        color: #4caf50;
        font-size: 13px;
        padding: 0 12px;
        animation: fadeIn 0.3s ease-in;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .chart-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #252526;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .chart-toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid #3c3c3c;
    }
    
    .chart-name-input {
        width: 200px;
    }
    
    .toolbar-spacer {
        flex: 1;
    }
    
    .custom-date-picker {
        width: 180px;
    }
    
    .date-separator {
        padding: 0 8px;
        color: #9d9d9d;
        font-size: 13px;
    }
    
    .chart-content-area {
        flex: 1;
        display: flex;
        flex-direction: row;
        gap: 16px;
        overflow: hidden;
        min-height: 0; /* Important for flex children to shrink and enable scrolling */
    }
    
    .chart-preview {
        flex: 1;
        padding: 16px;
        min-height: 400px;
        overflow: auto;
    }
    
    .configuration-panel {
        width: 320px;
        min-width: 280px;
        max-width: 400px;
        border-left: 1px solid #3c3c3c;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Let children handle scrolling */
    }
    
    .config-tabs {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0; /* Important for nested flex scrolling */
        overflow: hidden;
    }
    
    /* Override Syncfusion tab styles for proper scrolling */
    .config-tabs .e-tab-header {
        flex-shrink: 0;
    }
    
    .config-tabs .e-content {
        flex: 1;
        overflow-y: auto !important;
        min-height: 0;
    }
    
    .tab-content {
        padding: 12px;
        overflow-y: auto;
        max-height: 100%;
    }
    
    .axes-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        font-weight: 500;
    }
    
    .axis-color-indicator {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .config-axis-name {
        flex: 1;
        font-weight: 500;
        font-size: 14px;
    }
    
    .axis-position {
        font-size: 11px;
        color: #9d9d9d;
        padding: 2px 6px;
        background: #3c3c3c;
        border-radius: 3px;
    }
    
    .live-switch {
        margin-right: 12px;
    }
    
    .live-label {
        font-size: 12px;
        color: #9d9d9d;
    }
    
    .live-label.active {
        color: #4caf50;
        font-weight: 500;
    }
    
    .series-config-card, .axis-config-card {
        background: #2d2d2d;
        border-radius: 6px;
        margin-bottom: 12px;
        border: 1px solid #3c3c3c;
    }
    
    .config-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        cursor: pointer;
        user-select: none;
    }
    
    .config-header:hover {
        background: #3c3c3c;
    }
    
    .expand-icon {
        font-size: 12px;
        transition: transform 0.2s;
    }
    
    .series-color-indicator {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .config-series-name {
        flex: 1;
        font-weight: 500;
        font-size: 14px;
    }
    
    .config-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .visibility-switch {
        font-size: 11px;
    }
    
    .config-body {
        padding: 0 16px 16px 16px;
        border-top: 1px solid #3c3c3c;
    }
    
    .config-section {
        margin-top: 16px;
    }
    
    .config-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    
    .config-label {
        display: block;
        font-size: 12px;
        color: #9d9d9d;
        margin-bottom: 6px;
        font-weight: 500;
    }
    
    .axis-config-card {
        padding: 16px;
    }
    
    .axis-config-card h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #e0e0e0;
    }
    
    .no-chart-selected {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #9d9d9d;
    }
</style>

@code {
    private bool IsLoading = true;
    private ChartListItem? SelectedChart;
    private string TagSearchQuery = "";
    private string SelectedTimeRange = "1h";
    private DateTime? CustomStartDate = DateTime.Now.AddDays(-7);
    private DateTime? CustomEndDate = DateTime.Now;
    
    private List<string> ChartTypes = new() { "Line", "Bar", "Area", "Scatter" };
    private List<string> LineTypes = new() { "Line", "Spline", "StepLine" };
    private List<string> DashStyles = new() { "Solid", "Dash", "Dot", "DashDot", "LongDash" };
    private List<string> LegendPositions = new() { "Top", "Bottom", "Left", "Right" };
    
    // Multiple Y-Axes support
    private List<AxisOption> ChartAxes = new();
    private static readonly string[] AxisColors = { "#4caf50", "#2196f3", "#ff9800", "#e91e63", "#9c27b0", "#00bcd4" };
    private int _axisColorIndex = 0;
    
    // Chart Settings
    private string LegendPosition = "Bottom";
    private bool ShowLegend = true;
    private bool ShowTooltip = true;
    private bool EnableZoom = false;
    private bool EnableCrosshair = false;
    
    // Live chart support
    private bool IsLiveMode = false;
    private int LiveUpdateIntervalSeconds = 5;
    private Timer? _liveUpdateTimer;
    
    private List<TimeRangeOption> TimeRanges = new()
    {
        new("Last 15 minutes", "15m"),
        new("Last 1 hour", "1h"),
        new("Last 6 hours", "6h"),
        new("Last 24 hours", "24h"),
        new("Last 7 days", "7d"),
        new("Custom", "custom")
    };
    
    private List<ChartListItem> SavedCharts = new();
    private List<TagListItem> AvailableTags = new();
    
    private List<TagListItem> FilteredTags => string.IsNullOrEmpty(TagSearchQuery) 
        ? AvailableTags 
        : AvailableTags.Where(t => t.Path.Contains(TagSearchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
    
    private List<ChartSeriesData> ChartSeries = new();
    private List<BarChartDataPoint> BarChartData = new();
    
    protected override async Task OnInitializedAsync()
    {
        InitializeDefaultAxes();
        await LoadData();
    }
    
    private void InitializeDefaultAxes()
    {
        ChartAxes = new List<AxisOption>
        {
            new AxisOption
            {
                Name = "primary",
                Label = "Primary Y-Axis",
                Color = AxisColors[0],
                OpposedPosition = false,
                AutoScale = true,
                ShowGridLines = true,
                IsExpanded = true
            }
        };
        _axisColorIndex = 1;
    }
    
    private async Task LoadData()
    {
        IsLoading = true;
        
        try
        {
            // Load charts from DataService
            var charts = await DataService.GetChartsAsync();
            if (charts != null)
            {
                SavedCharts = charts.Select(c => new ChartListItem
                {
                    Id = c.Id.ToString(),
                    Name = c.Name,
                    // Normalize ChartType to Pascal case (Line, Bar, Area) to match dropdown
                    ChartType = NormalizeChartType(c.ChartType),
                    Options = c.Options ?? "{}",
                    LiveEnabled = c.LiveEnabled,
                    RefreshInterval = c.RefreshInterval,
                    EnableLegend = c.EnableLegend,
                    LegendPosition = c.LegendPosition ?? "bottom",
                    EnableZoom = c.EnableZoom,
                    EnablePan = c.EnablePan
                }).ToList();
            }
            
            // Load tags from DataService
            var tags = await DataService.GetTagsAsync();
            if (tags != null)
            {
                AvailableTags = tags.Select(t => new TagListItem
                {
                    Id = t.TagId,
                    Path = t.TagPath
                }).ToList();
            }
        }
        catch (Exception)
        {
            // Data not available
        }
        
        IsLoading = false;
    }
    
    private void CreateNewChart()
    {
        SelectedChart = new ChartListItem
        {
            Id = Guid.NewGuid().ToString(),
            Name = "New Chart",
            ChartType = "Line"
        };
        SavedCharts.Add(SelectedChart);
        ChartSeries = new List<ChartSeriesData>();
    }
    
    private void SelectChart(ChartListItem chart)
    {
        SelectedChart = chart;
        _colorIndex = 0;
        
        // Load settings from the saved chart
        IsLiveMode = chart.LiveEnabled;
        LiveUpdateIntervalSeconds = chart.RefreshInterval / 1000;
        if (LiveUpdateIntervalSeconds < 1) LiveUpdateIntervalSeconds = 5;
        ShowLegend = chart.EnableLegend;
        LegendPosition = chart.LegendPosition ?? "bottom";
        EnableZoom = chart.EnableZoom;
        // Note: EnablePan is not currently stored but we load it for future use
        
        // Try to load saved configuration from Options JSON
        ChartConfigOptions? config = null;
        if (!string.IsNullOrEmpty(chart.Options) && chart.Options != "{}")
        {
            try
            {
                config = JsonSerializer.Deserialize<ChartConfigOptions>(chart.Options);
            }
            catch
            {
                // If parsing fails, use default configuration
            }
        }
        
        var now = DateTime.Now;
        
        // Load saved series or create default
        if (config?.Series != null && config.Series.Count > 0)
        {
            ChartSeries = config.Series.Select(s => new ChartSeriesData
            {
                Name = s.Name,
                DisplayName = s.DisplayName,
                Color = s.Color,
                LineType = s.LineType,
                DashStyle = s.DashStyle,
                LineWidth = s.LineWidth,
                Opacity = s.Opacity,
                ShowMarkers = s.ShowMarkers,
                MarkerSize = s.MarkerSize,
                Visible = s.Visible,
                YAxisName = s.YAxisName,
                IsExpanded = false,
                // Generate sample data for each series
                Data = Enumerable.Range(0, 50).Select(i => new TimeSeriesPoint
                {
                    Timestamp = now.AddMinutes(-50 + i),
                    Value = Math.Round(50 + Math.Sin(i * 0.3) * 20 + Random.Shared.NextDouble() * 5, 2)
                }).ToList()
            }).ToList();
        }
        else
        {
            // Create default series if none saved
            var dataPoints = new List<TimeSeriesPoint>();
            for (int i = 0; i < 50; i++)
            {
                dataPoints.Add(new TimeSeriesPoint
                {
                    Timestamp = now.AddMinutes(-50 + i),
                    Value = Math.Round(50 + Math.Sin(i * 0.3) * 20 + Random.Shared.NextDouble() * 5, 2)
                });
            }
            
            ChartSeries = new List<ChartSeriesData>
            {
                new ChartSeriesData
                {
                    Name = "Sample Data",
                    DisplayName = $"{chart.Name} - Series 1",
                    Color = SeriesColors[0],
                    LineType = "Spline",
                    DashStyle = "Solid",
                    LineWidth = 2.0,
                    Opacity = 1.0,
                    ShowMarkers = true,
                    MarkerSize = 6,
                    Visible = true,
                    YAxisName = "primary",
                    IsExpanded = false,
                    Data = dataPoints
                }
            };
        }
        
        // Load saved axes or create default
        if (config?.Axes != null && config.Axes.Count > 0)
        {
            ChartAxes = config.Axes.Select(a => new AxisOption
            {
                Name = a.Name,
                Label = a.Label,
                Color = a.Color,
                OpposedPosition = a.OpposedPosition,
                AutoScale = a.AutoScale,
                Minimum = a.Minimum,
                Maximum = a.Maximum,
                ShowGridLines = a.ShowGridLines,
                IsExpanded = false
            }).ToList();
        }
        else
        {
            // Create default primary axis
            ChartAxes = new List<AxisOption>
            {
                new AxisOption
                {
                    Name = "primary",
                    Label = "Primary Y-Axis",
                    Color = "#4caf50",
                    OpposedPosition = false,
                    AutoScale = true,
                    ShowGridLines = true,
                    IsExpanded = false
                }
            };
        }
        
        StateHasChanged();
    }
    
    private bool _showSaveMessage = false;
    private string _saveMessage = "";
    private Timer? _messageTimer;
    
    private void HideMessage(object? state)
    {
        _showSaveMessage = false;
        InvokeAsync(StateHasChanged);
    }
    
    private async Task SaveChart()
    {
        if (SelectedChart != null)
        {
            try
            {
                // Serialize the chart configuration (series and axes)
                var config = new ChartConfigOptions
                {
                    Series = ChartSeries.Select(s => new SeriesConfig
                    {
                        Name = s.Name,
                        DisplayName = s.DisplayName,
                        Color = s.Color,
                        LineType = s.LineType,
                        DashStyle = s.DashStyle,
                        LineWidth = s.LineWidth,
                        Opacity = s.Opacity,
                        ShowMarkers = s.ShowMarkers,
                        MarkerSize = s.MarkerSize,
                        Visible = s.Visible,
                        YAxisName = s.YAxisName
                    }).ToList(),
                    Axes = ChartAxes.Select(a => new AxisConfig
                    {
                        Name = a.Name,
                        Label = a.Label,
                        Color = a.Color,
                        OpposedPosition = a.OpposedPosition,
                        AutoScale = a.AutoScale,
                        Minimum = a.Minimum,
                        Maximum = a.Maximum,
                        ShowGridLines = a.ShowGridLines
                    }).ToList()
                };
                
                var options = JsonSerializer.Serialize(config);
                
                // Update the chart in the database
                var success = await DataService.UpdateChartAsync(
                    Guid.Parse(SelectedChart.Id),
                    name: SelectedChart.Name,
                    chartType: SelectedChart.ChartType,
                    options: options,
                    liveEnabled: IsLiveMode,
                    refreshInterval: LiveUpdateIntervalSeconds * 1000,
                    enableLegend: ShowLegend,
                    legendPosition: LegendPosition,
                    enableZoom: EnableZoom,
                    enablePan: false // Not currently tracked
                );
                
                if (success)
                {
                    // Update the local cache
                    SelectedChart.Options = options;
                    SelectedChart.LiveEnabled = IsLiveMode;
                    SelectedChart.RefreshInterval = LiveUpdateIntervalSeconds * 1000;
                    SelectedChart.EnableLegend = ShowLegend;
                    SelectedChart.LegendPosition = LegendPosition;
                    SelectedChart.EnableZoom = EnableZoom;
                    
                    _saveMessage = "Chart saved successfully!";
                }
                else
                {
                    _saveMessage = "Failed to save chart";
                }
            }
            catch (Exception ex)
            {
                _saveMessage = $"Failed to save chart: {ex.Message}";
            }
            
            _showSaveMessage = true;
            StateHasChanged();
            
            _messageTimer?.Dispose();
            _messageTimer = new Timer(HideMessage, null, 3000, Timeout.Infinite);
        }
    }
    
    private static readonly string[] SeriesColors = { "#4caf50", "#2196f3", "#ff9800", "#e91e63", "#9c27b0", "#00bcd4", "#ff5722", "#795548" };
    private int _colorIndex = 0;
    private void AddTagToChart(TagListItem tag)
    {
        // Check if tag is already added
        if (ChartSeries.Any(s => s.Name == tag.Path.Split('.').Last()))
        {
            return;
        }
        
        var now = DateTime.Now;
        var color = SeriesColors[_colorIndex % SeriesColors.Length];
        _colorIndex++;
        
        var newSeries = new ChartSeriesData
        {
            Name = tag.Path.Split('.').Last(),
            DisplayName = tag.Path.Split('.').Last(),
            Color = color,
            LineType = "Line",
            DashStyle = "Solid",
            LineWidth = 2.0,
            Opacity = 1.0,
            ShowMarkers = true,
            MarkerSize = 6,
            Visible = true,
            YAxisName = "primary",
            IsExpanded = false,
            Data = Enumerable.Range(0, 50).Select(i => new TimeSeriesPoint
            {
                Timestamp = now.AddMinutes(-50 + i),
                Value = 50 + Random.Shared.NextDouble() * 30 // Thread-safe Random for Blazor Server
            }).ToList()
        };
        
        ChartSeries.Add(newSeries);
        StateHasChanged();
    }
    
    private void RemoveSeries(ChartSeriesData series)
    {
        ChartSeries.Remove(series);
        StateHasChanged();
    }
    
    private void ToggleSeriesExpanded(ChartSeriesData series)
    {
        series.IsExpanded = !series.IsExpanded;
        StateHasChanged();
    }
    
    private ChartSeriesType GetChartSeriesType(string lineType)
    {
        return lineType switch
        {
            "Spline" => ChartSeriesType.Spline,
            "StepLine" => ChartSeriesType.StepLine,
            _ => ChartSeriesType.Line
        };
    }
    
    private string GetDashArray(string dashStyle)
    {
        return dashStyle switch
        {
            "Dash" => "5,5",
            "Dot" => "2,2",
            "DashDot" => "5,2,2,2",
            "LongDash" => "10,5",
            _ => "" // Solid
        };
    }
    
    private Syncfusion.Blazor.Charts.LegendPosition GetLegendPosition()
    {
        return LegendPosition switch
        {
            "Top" => Syncfusion.Blazor.Charts.LegendPosition.Top,
            "Left" => Syncfusion.Blazor.Charts.LegendPosition.Left,
            "Right" => Syncfusion.Blazor.Charts.LegendPosition.Right,
            _ => Syncfusion.Blazor.Charts.LegendPosition.Bottom
        };
    }
    
    private static string NormalizeChartType(string chartType)
    {
        // Normalize to Pascal case to match dropdown options
        return chartType?.ToLowerInvariant() switch
        {
            "line" => "Line",
            "bar" => "Bar",
            "area" => "Area",
            "scatter" => "Scatter",
            _ => "Line"
        };
    }
    
    // Chart refresh and live update methods
    private void RefreshChart()
    {
        StateHasChanged();
    }
    
    private void ToggleLiveMode(bool enabled)
    {
        IsLiveMode = enabled;
        if (enabled)
        {
            StartLiveUpdates();
        }
        else
        {
            StopLiveUpdates();
        }
        StateHasChanged();
    }
    
    private void UpdateLiveInterval(int seconds)
    {
        LiveUpdateIntervalSeconds = seconds;
        if (IsLiveMode)
        {
            StopLiveUpdates();
            StartLiveUpdates();
        }
    }
    
    private void StartLiveUpdates()
    {
        _liveUpdateTimer?.Dispose();
        _liveUpdateTimer = new Timer(_ => 
        {
            try 
            {
                _ = UpdateLiveData();
            }
            catch { /* Timer callbacks should not throw */ }
        }, null, 0, LiveUpdateIntervalSeconds * 1000);
    }
    
    private void StopLiveUpdates()
    {
        _liveUpdateTimer?.Dispose();
        _liveUpdateTimer = null;
    }
    
    private async Task UpdateLiveData()
    {
        await InvokeAsync(() =>
        {
            var now = DateTime.Now;
            foreach (var series in ChartSeries)
            {
                if (series.Data.Count > 1)
                {
                    // Store last value before modifying collection
                    var lastValue = series.Data[series.Data.Count - 1].Value;
                    // Remove oldest point and add new one
                    series.Data.RemoveAt(0);
                    series.Data.Add(new TimeSeriesPoint
                    {
                        Timestamp = now,
                        Value = lastValue + (Random.Shared.NextDouble() - 0.5) * 10
                    });
                }
            }
            StateHasChanged();
        });
    }
    
    // Multiple Y-axis management
    private void AddYAxis()
    {
        var axisNumber = ChartAxes.Count + 1;
        var color = AxisColors[_axisColorIndex % AxisColors.Length];
        _axisColorIndex++;
        
        ChartAxes.Add(new AxisOption
        {
            Name = $"axis_{axisNumber}",
            Label = $"Y-Axis {axisNumber}",
            Color = color,
            OpposedPosition = ChartAxes.Count % 2 == 1, // Alternate left/right
            AutoScale = true,
            ShowGridLines = false,
            IsExpanded = true
        });
        StateHasChanged();
    }
    
    private void RemoveYAxis(AxisOption axis)
    {
        // Reassign any series using this axis to primary
        foreach (var series in ChartSeries.Where(s => s.YAxisName == axis.Name))
        {
            series.YAxisName = "primary";
        }
        ChartAxes.Remove(axis);
        StateHasChanged();
    }
    
    public void Dispose()
    {
        _liveUpdateTimer?.Dispose();
        _messageTimer?.Dispose();
    }
    
    record TimeRangeOption(string Label, string Value);
    
    class ChartListItem
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string ChartType { get; set; } = "Line";
        public string Options { get; set; } = "{}"; // JSON for chart configuration
        public bool LiveEnabled { get; set; } = false;
        public int RefreshInterval { get; set; } = 5000;
        public bool EnableLegend { get; set; } = true;
        public string LegendPosition { get; set; } = "bottom";
        public bool EnableZoom { get; set; } = true;
        public bool EnablePan { get; set; } = true;
    }
    
    class TagListItem
    {
        public int Id { get; set; }
        public string Path { get; set; } = "";
    }
    
    class ChartSeriesData
    {
        public string Name { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public string Color { get; set; } = "#4caf50";
        public string LineType { get; set; } = "Line";
        public string DashStyle { get; set; } = "Solid";
        public double LineWidth { get; set; } = 2.0;
        public double Opacity { get; set; } = 1.0;
        public bool ShowMarkers { get; set; } = true;
        public int MarkerSize { get; set; } = 6;
        public bool Visible { get; set; } = true;
        public string YAxisName { get; set; } = "primary";
        public bool IsExpanded { get; set; } = false;
        public List<TimeSeriesPoint> Data { get; set; } = new();
    }
    
    class AxisOption
    {
        public string Name { get; set; } = "";
        public string Label { get; set; } = "";
        public string Color { get; set; } = "#4caf50";
        public bool OpposedPosition { get; set; } = false; // false = Left, true = Right
        public bool AutoScale { get; set; } = true;
        public double? Minimum { get; set; }
        public double? Maximum { get; set; }
        public bool ShowGridLines { get; set; } = true;
        public bool IsExpanded { get; set; } = false;
    }
    
    class TimeSeriesPoint
    {
        public DateTime Timestamp { get; set; }
        public double Value { get; set; }
    }
    
    record BarChartDataPoint(string Category, double Value);
    
    // Classes for JSON serialization of chart configuration
    class ChartConfigOptions
    {
        public List<SeriesConfig> Series { get; set; } = new();
        public List<AxisConfig> Axes { get; set; } = new();
    }
    
    class SeriesConfig
    {
        public string Name { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public string Color { get; set; } = "#4caf50";
        public string LineType { get; set; } = "Line";
        public string DashStyle { get; set; } = "Solid";
        public double LineWidth { get; set; } = 2.0;
        public double Opacity { get; set; } = 1.0;
        public bool ShowMarkers { get; set; } = true;
        public int MarkerSize { get; set; } = 6;
        public bool Visible { get; set; } = true;
        public string YAxisName { get; set; } = "primary";
    }
    
    class AxisConfig
    {
        public string Name { get; set; } = "";
        public string Label { get; set; } = "";
        public string Color { get; set; } = "#4caf50";
        public bool OpposedPosition { get; set; } = false;
        public bool AutoScale { get; set; } = true;
        public double? Minimum { get; set; }
        public double? Maximum { get; set; }
        public bool ShowGridLines { get; set; } = true;
    }
}
