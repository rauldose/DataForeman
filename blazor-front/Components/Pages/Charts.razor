@page "/charts"
@rendermode InteractiveServer
@using DataForeman.BlazorUI.Services
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Navigations
@inject DataService DataService

<PageTitle>Chart Composer - DataForeman</PageTitle>

<div class="charts-page">
    <div class="page-header">
        <h1>Chart Composer</h1>
        <div class="page-actions">
            <SfButton CssClass="e-primary" IconCss="e-icons e-plus" Content="New Chart" OnClick="@CreateNewChart"></SfButton>
        </div>
    </div>
    
    @if (IsLoading)
    {
        <div class="loading-indicator">Loading charts...</div>
    }
    else
    {
        <div class="charts-container">
            <div class="charts-sidebar">
                <h3>Saved Charts</h3>
                @if (SavedCharts.Count == 0)
                {
                    <p class="no-items">No charts saved yet</p>
                }
                else
                {
                    <SfListView TValue="ChartListItem" DataSource="@SavedCharts" ShowHeader="false" CssClass="chart-list">
                        <ListViewFieldSettings TValue="ChartListItem" Id="Id" Text="Name"></ListViewFieldSettings>
                        <ListViewTemplates TValue="ChartListItem">
                            <Template>
                                @{
                                    var chart = context as ChartListItem;
                                    if (chart != null)
                                    {
                                        <div class="chart-list-item @(SelectedChart?.Id == chart.Id ? "selected" : "")" @onclick="@(() => SelectChart(chart))">
                                            <span class="chart-icon e-icons e-line-chart"></span>
                                            <div class="chart-info">
                                                <span class="chart-name">@chart.Name</span>
                                                <span class="chart-type">@chart.ChartType</span>
                                            </div>
                                        </div>
                                    }
                                }
                            </Template>
                        </ListViewTemplates>
                    </SfListView>
                }
                
                <h3>Available Tags</h3>
                <p class="help-text">Click a tag to add it to the chart</p>
                <SfTextBox Placeholder="Search tags..." @bind-Value="TagSearchQuery" CssClass="tag-search"></SfTextBox>
                <div class="tag-list">
                    @if (FilteredTags.Count == 0)
                    {
                        <p class="no-items">No tags available</p>
                    }
                    else
                    {
                        @foreach (var tag in FilteredTags)
                        {
                            <div class="tag-item" @onclick="@(() => AddTagToChart(tag))" title="Click to add to chart">
                                <span class="tag-icon e-icons e-bookmark"></span>
                                <span class="tag-path">@tag.Path</span>
                                <span class="add-icon">+</span>
                            </div>
                        }
                    }
                </div>
            </div>
            
            <div class="chart-editor">
                @if (SelectedChart != null)
                {
                    <div class="chart-toolbar">
                        <SfTextBox @bind-Value="SelectedChart.Name" Placeholder="Chart Name" CssClass="chart-name-input"></SfTextBox>
                        <SfDropDownList TItem="string" TValue="string" DataSource="@ChartTypes" @bind-Value="SelectedChart.ChartType" Placeholder="Chart Type"></SfDropDownList>
                        <div class="toolbar-spacer"></div>
                        @if (_showSaveMessage)
                        {
                            <span class="save-message">@_saveMessage</span>
                        }
                        <SfDropDownList TItem="TimeRangeOption" TValue="string" DataSource="@TimeRanges" @bind-Value="SelectedTimeRange" Placeholder="Time Range">
                            <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                        </SfDropDownList>
                        @if (SelectedTimeRange == "custom")
                        {
                            <SfDateTimePicker @bind-Value="@CustomStartDate" Placeholder="Start Date" Format="yyyy-MM-dd HH:mm" CssClass="custom-date-picker"></SfDateTimePicker>
                            <span class="date-separator">to</span>
                            <SfDateTimePicker @bind-Value="@CustomEndDate" Placeholder="End Date" Format="yyyy-MM-dd HH:mm" CssClass="custom-date-picker"></SfDateTimePicker>
                        }
                        <SfButton CssClass="e-outline" IconCss="e-icons e-refresh" Content="Refresh"></SfButton>
                        <SfButton CssClass="e-primary" IconCss="e-icons e-save" Content="Save" OnClick="@SaveChart"></SfButton>
                    </div>
                    
                    <div class="chart-preview">
                        @if (ChartSeries.Count > 0)
                        {
                            @if (SelectedChart.ChartType == "Line")
                            {
                                <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                    <ChartArea>
                                        <ChartAreaBorder Width="0"></ChartAreaBorder>
                                    </ChartArea>
                                    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" LabelFormat="HH:mm:ss">
                                        <ChartAxisMajorGridLines Width="0.5" Color="#3c3c3c"></ChartAxisMajorGridLines>
                                    </ChartPrimaryXAxis>
                                    <ChartPrimaryYAxis Title="@PrimaryAxisLabel" Minimum="@(PrimaryAxisAutoScale ? null : PrimaryAxisMin)" Maximum="@(PrimaryAxisAutoScale ? null : PrimaryAxisMax)">
                                        <ChartAxisMajorGridLines Width="@(PrimaryAxisShowGrid ? 0.5 : 0)" Color="#3c3c3c"></ChartAxisMajorGridLines>
                                    </ChartPrimaryYAxis>
                                    @if (EnableSecondaryAxis)
                                    {
                                        <ChartAxes>
                                            <ChartAxis Name="secondary" OpposedPosition="true" Title="@SecondaryAxisLabel" Minimum="@(SecondaryAxisAutoScale ? null : SecondaryAxisMin)" Maximum="@(SecondaryAxisAutoScale ? null : SecondaryAxisMax)">
                                                <ChartAxisMajorGridLines Width="@(SecondaryAxisShowGrid ? 0.5 : 0)" Color="#3c3c3c"></ChartAxisMajorGridLines>
                                            </ChartAxis>
                                        </ChartAxes>
                                    }
                                    <ChartTooltipSettings Enable="@ShowTooltip"></ChartTooltipSettings>
                                    <ChartLegendSettings Visible="@ShowLegend" Position="@GetLegendPosition()"></ChartLegendSettings>
                                    @if (EnableZoom)
                                    {
                                        <ChartZoomSettings EnableSelectionZooming="true" EnablePinchZooming="true" EnableMouseWheelZooming="true"></ChartZoomSettings>
                                    }
                                    @if (EnableCrosshair)
                                    {
                                        <ChartCrosshairSettings Enable="true"></ChartCrosshairSettings>
                                    }
                                    <ChartSeriesCollection>
                                        @foreach (var series in ChartSeries.Where(s => s.Visible))
                                        {
                                            <ChartSeries DataSource="@series.Data" XName="Timestamp" YName="Value" Name="@series.DisplayName" 
                                                         Type="@GetChartSeriesType(series.LineType)" 
                                                         Width="@series.LineWidth" 
                                                         Opacity="@series.Opacity" 
                                                         Fill="@series.Color"
                                                         DashArray="@GetDashArray(series.DashStyle)"
                                                         YAxisName="@series.YAxisName">
                                                <ChartMarker Visible="@series.ShowMarkers" Height="@series.MarkerSize" Width="@series.MarkerSize"></ChartMarker>
                                            </ChartSeries>
                                        }
                                    </ChartSeriesCollection>
                                </SfChart>
                            }
                            else if (SelectedChart.ChartType == "Bar")
                            {
                                <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Category"></ChartPrimaryXAxis>
                                    <ChartSeriesCollection>
                                        <ChartSeries DataSource="@BarChartData" XName="Category" YName="Value" Type="ChartSeriesType.Column">
                                        </ChartSeries>
                                    </ChartSeriesCollection>
                                </SfChart>
                            }
                            else if (SelectedChart.ChartType == "Area")
                            {
                                <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" LabelFormat="HH:mm:ss"></ChartPrimaryXAxis>
                                    <ChartSeriesCollection>
                                        @foreach (var series in ChartSeries.Where(s => s.Visible))
                                        {
                                            <ChartSeries DataSource="@series.Data" XName="Timestamp" YName="Value" Name="@series.DisplayName" Type="ChartSeriesType.SplineArea" Opacity="@series.Opacity" Fill="@series.Color">
                                            </ChartSeries>
                                        }
                                    </ChartSeriesCollection>
                                </SfChart>
                            }
                        }
                        else
                        {
                            <div class="no-data">Add tags from the sidebar to display chart data</div>
                        }
                    </div>
                    
                    <div class="configuration-panel">
                        <SfTab CssClass="config-tabs">
                            <TabItems>
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Series Configuration"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <div class="tab-content">
                                            @if (ChartSeries.Count == 0)
                                            {
                                                <p class="no-items">No series added. Click tags from the sidebar to add series.</p>
                                            }
                                            else
                                            {
                                                @foreach (var series in ChartSeries)
                                                {
                                                    <div class="series-config-card">
                                                        <div class="config-header" @onclick="@(() => ToggleSeriesExpanded(series))">
                                                            <span class="expand-icon e-icons @(series.IsExpanded ? "e-chevron-down" : "e-chevron-right")"></span>
                                                            <span class="series-color-indicator" style="background: @series.Color"></span>
                                                            <span class="config-series-name">@series.DisplayName</span>
                                                            <div class="config-actions">
                                                                <SfSwitch @bind-Checked="@series.Visible" CssClass="visibility-switch" OnLabel="ON" OffLabel="OFF"></SfSwitch>
                                                                <SfButton CssClass="e-flat e-small" IconCss="e-icons e-delete" OnClick="@(() => RemoveSeries(series))"></SfButton>
                                                            </div>
                                                        </div>
                                                        @if (series.IsExpanded)
                                                        {
                                                            <div class="config-body">
                                                                <div class="config-section">
                                                                    <label class="config-label">Display Name</label>
                                                                    <SfTextBox @bind-Value="@series.DisplayName" Placeholder="Series name"></SfTextBox>
                                                                </div>
                                                                
                                                                <div class="config-row">
                                                                    <div class="config-section">
                                                                        <label class="config-label">Color</label>
                                                                        <SfColorPicker @bind-Value="@series.Color" Mode="ColorPickerMode.Palette" ModeSwitcher="false"></SfColorPicker>
                                                                    </div>
                                                                    
                                                                    <div class="config-section">
                                                                        <label class="config-label">Line Type</label>
                                                                        <SfDropDownList TItem="string" TValue="string" @bind-Value="@series.LineType" DataSource="@LineTypes" Width="100%"></SfDropDownList>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="config-row">
                                                                    <div class="config-section">
                                                                        <label class="config-label">Line Width: @series.LineWidth.ToString("F1")</label>
                                                                        <SfSlider @bind-Value="@series.LineWidth" Min="0.5" Max="5" Step="0.5" Type="SliderType.MinRange">
                                                                            <SliderTicks Placement="Placement.After" ShowSmallTicks="false"></SliderTicks>
                                                                        </SfSlider>
                                                                    </div>
                                                                    
                                                                    <div class="config-section">
                                                                        <label class="config-label">Opacity: @series.Opacity.ToString("P0")</label>
                                                                        <SfSlider @bind-Value="@series.Opacity" Min="0" Max="1" Step="0.1" Type="SliderType.MinRange">
                                                                            <SliderTicks Placement="Placement.After" ShowSmallTicks="false"></SliderTicks>
                                                                        </SfSlider>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="config-section">
                                                                    <label class="config-label">Dash Style</label>
                                                                    <SfDropDownList TItem="string" TValue="string" @bind-Value="@series.DashStyle" DataSource="@DashStyles" Width="100%"></SfDropDownList>
                                                                </div>
                                                                
                                                                <div class="config-row">
                                                                    <div class="config-section">
                                                                        <SfCheckBox @bind-Checked="@series.ShowMarkers" Label="Show Markers"></SfCheckBox>
                                                                    </div>
                                                                    
                                                                    @if (series.ShowMarkers)
                                                                    {
                                                                        <div class="config-section">
                                                                            <label class="config-label">Marker Size</label>
                                                                            <SfNumericTextBox @bind-Value="@series.MarkerSize" Min="3" Max="12" Step="1" Width="100%"></SfNumericTextBox>
                                                                        </div>
                                                                    }
                                                                </div>
                                                                
                                                                <div class="config-section">
                                                                    <label class="config-label">Y-Axis Assignment</label>
                                                                    <SfDropDownList TItem="string" TValue="string" @bind-Value="@series.YAxisName" DataSource="@AxisOptions" Width="100%"></SfDropDownList>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </ContentTemplate>
                                </TabItem>
                                
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Axes Configuration"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <div class="tab-content">
                                            <div class="axis-config-card">
                                                <h4>Primary Y-Axis (Left)</h4>
                                                <div class="config-section">
                                                    <label class="config-label">Axis Label</label>
                                                    <SfTextBox @bind-Value="@PrimaryAxisLabel" Placeholder="e.g., Temperature (Â°C)"></SfTextBox>
                                                </div>
                                                
                                                <div class="config-section">
                                                    <SfCheckBox @bind-Checked="@PrimaryAxisAutoScale" Label="Auto Scale"></SfCheckBox>
                                                </div>
                                                
                                                @if (!PrimaryAxisAutoScale)
                                                {
                                                    <div class="config-row">
                                                        <div class="config-section">
                                                            <label class="config-label">Minimum</label>
                                                            <SfNumericTextBox @bind-Value="@PrimaryAxisMin" Placeholder="Min" Width="100%"></SfNumericTextBox>
                                                        </div>
                                                        <div class="config-section">
                                                            <label class="config-label">Maximum</label>
                                                            <SfNumericTextBox @bind-Value="@PrimaryAxisMax" Placeholder="Max" Width="100%"></SfNumericTextBox>
                                                        </div>
                                                    </div>
                                                }
                                                
                                                <div class="config-section">
                                                    <SfCheckBox @bind-Checked="@PrimaryAxisShowGrid" Label="Show Grid Lines"></SfCheckBox>
                                                </div>
                                            </div>
                                            
                                            <div class="axis-config-card">
                                                <h4>Secondary Y-Axis (Right)</h4>
                                                <div class="config-section">
                                                    <SfCheckBox @bind-Checked="@EnableSecondaryAxis" Label="Enable Secondary Axis"></SfCheckBox>
                                                </div>
                                                
                                                @if (EnableSecondaryAxis)
                                                {
                                                    <div class="config-section">
                                                        <label class="config-label">Axis Label</label>
                                                        <SfTextBox @bind-Value="@SecondaryAxisLabel" Placeholder="e.g., Pressure (kPa)"></SfTextBox>
                                                    </div>
                                                    
                                                    <div class="config-section">
                                                        <SfCheckBox @bind-Checked="@SecondaryAxisAutoScale" Label="Auto Scale"></SfCheckBox>
                                                    </div>
                                                    
                                                    @if (!SecondaryAxisAutoScale)
                                                    {
                                                        <div class="config-row">
                                                            <div class="config-section">
                                                                <label class="config-label">Minimum</label>
                                                                <SfNumericTextBox @bind-Value="@SecondaryAxisMin" Placeholder="Min" Width="100%"></SfNumericTextBox>
                                                            </div>
                                                            <div class="config-section">
                                                                <label class="config-label">Maximum</label>
                                                                <SfNumericTextBox @bind-Value="@SecondaryAxisMax" Placeholder="Max" Width="100%"></SfNumericTextBox>
                                                            </div>
                                                        </div>
                                                    }
                                                    
                                                    <div class="config-section">
                                                        <SfCheckBox @bind-Checked="@SecondaryAxisShowGrid" Label="Show Grid Lines"></SfCheckBox>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </ContentTemplate>
                                </TabItem>
                                
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Chart Settings"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <div class="tab-content">
                                            <div class="config-section">
                                                <label class="config-label">Legend Position</label>
                                                <SfDropDownList TItem="string" TValue="string" @bind-Value="@LegendPosition" DataSource="@LegendPositions" Width="100%"></SfDropDownList>
                                            </div>
                                            
                                            <div class="config-section">
                                                <SfCheckBox @bind-Checked="@ShowLegend" Label="Show Legend"></SfCheckBox>
                                            </div>
                                            
                                            <div class="config-section">
                                                <SfCheckBox @bind-Checked="@ShowTooltip" Label="Enable Tooltip"></SfCheckBox>
                                            </div>
                                            
                                            <div class="config-section">
                                                <SfCheckBox @bind-Checked="@EnableZoom" Label="Enable Zoom"></SfCheckBox>
                                            </div>
                                            
                                            <div class="config-section">
                                                <SfCheckBox @bind-Checked="@EnableCrosshair" Label="Enable Crosshair"></SfCheckBox>
                                            </div>
                                        </div>
                                    </ContentTemplate>
                                </TabItem>
                            </TabItems>
                        </SfTab>
                    </div>
                }
                else
                {
                    <div class="no-chart-selected">
                        <span class="e-icons e-line-chart" style="font-size: 64px; margin-bottom: 16px;"></span>
                        <p>Select a chart to edit or create a new one</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .charts-page {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .page-header h1 {
        margin: 0;
    }
    
    .loading-indicator {
        text-align: center;
        padding: 40px;
        color: #9d9d9d;
    }
    
    .no-items {
        color: #9d9d9d;
        font-size: 13px;
        font-style: italic;
        padding: 8px 0;
    }
    
    .no-data {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #9d9d9d;
        font-style: italic;
    }
    
    .charts-container {
        display: flex;
        flex: 1;
        gap: 16px;
        overflow: hidden;
    }
    
    .charts-sidebar {
        width: 280px;
        background: #252526;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        max-height: calc(100vh - 200px);
    }
    
    .charts-sidebar h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #9d9d9d;
    }
    
    .chart-list-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        overflow: hidden;
    }
    
    .chart-list-item:hover {
        background: #3c3c3c;
    }
    
    .chart-list-item.selected {
        background: #404040;
        border-left: 3px solid #4caf50;
        padding-left: 9px;
    }
    
    .chart-info {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 0;
    }
    
    .chart-name {
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .chart-type {
        font-size: 12px;
        color: #9d9d9d;
    }
    
    .tag-search {
        margin-bottom: 12px;
    }
    
    .tag-list {
        flex: 1;
        overflow-y: auto;
        max-height: 400px;
    }
    
    .help-text {
        font-size: 11px;
        color: #9d9d9d;
        margin: 0 0 8px 0;
        font-style: italic;
    }
    
    .tag-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    
    .tag-item:hover {
        background: #3c3c3c;
        border-color: #4caf50;
    }
    
    .tag-item:hover .add-icon {
        opacity: 1;
    }
    
    .add-icon {
        margin-left: auto;
        color: #4caf50;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .tag-path {
        font-size: 13px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }
    
    .save-message {
        color: #4caf50;
        font-size: 13px;
        padding: 0 12px;
        animation: fadeIn 0.3s ease-in;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .chart-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #252526;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .chart-toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid #3c3c3c;
    }
    
    .chart-name-input {
        width: 200px;
    }
    
    .toolbar-spacer {
        flex: 1;
    }
    
    .custom-date-picker {
        width: 180px;
    }
    
    .date-separator {
        padding: 0 8px;
        color: #9d9d9d;
        font-size: 13px;
    }
    
    .chart-preview {
        flex: 1;
        padding: 16px;
        min-height: 400px;
    }
    
    .configuration-panel {
        height: 300px;
        border-top: 1px solid #3c3c3c;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .config-tabs {
        height: 100%;
    }
    
    .tab-content {
        padding: 16px;
        height: calc(100% - 48px);
        overflow-y: auto;
    }
    
    .series-config-card, .axis-config-card {
        background: #2d2d2d;
        border-radius: 6px;
        margin-bottom: 12px;
        border: 1px solid #3c3c3c;
    }
    
    .config-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        cursor: pointer;
        user-select: none;
    }
    
    .config-header:hover {
        background: #3c3c3c;
    }
    
    .expand-icon {
        font-size: 12px;
        transition: transform 0.2s;
    }
    
    .series-color-indicator {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .config-series-name {
        flex: 1;
        font-weight: 500;
        font-size: 14px;
    }
    
    .config-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .visibility-switch {
        font-size: 11px;
    }
    
    .config-body {
        padding: 0 16px 16px 16px;
        border-top: 1px solid #3c3c3c;
    }
    
    .config-section {
        margin-top: 16px;
    }
    
    .config-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    
    .config-label {
        display: block;
        font-size: 12px;
        color: #9d9d9d;
        margin-bottom: 6px;
        font-weight: 500;
    }
    
    .axis-config-card {
        padding: 16px;
    }
    
    .axis-config-card h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #e0e0e0;
    }
    
    .no-chart-selected {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #9d9d9d;
    }
</style>

@code {
    private bool IsLoading = true;
    private ChartListItem? SelectedChart;
    private string TagSearchQuery = "";
    private string SelectedTimeRange = "1h";
    private DateTime? CustomStartDate = DateTime.Now.AddDays(-7);
    private DateTime? CustomEndDate = DateTime.Now;
    
    private List<string> ChartTypes = new() { "Line", "Bar", "Area", "Scatter" };
    private List<string> LineTypes = new() { "Line", "Spline", "StepLine" };
    private List<string> DashStyles = new() { "Solid", "Dash", "Dot", "DashDot", "LongDash" };
    private List<string> AxisOptions = new() { "primary", "secondary" };
    private List<string> LegendPositions = new() { "Top", "Bottom", "Left", "Right" };
    
    // Axis Configuration
    private string PrimaryAxisLabel = "Value";
    private bool PrimaryAxisAutoScale = true;
    private double? PrimaryAxisMin = 0;
    private double? PrimaryAxisMax = 100;
    private bool PrimaryAxisShowGrid = true;
    
    private bool EnableSecondaryAxis = false;
    private string SecondaryAxisLabel = "Secondary Value";
    private bool SecondaryAxisAutoScale = true;
    private double? SecondaryAxisMin = 0;
    private double? SecondaryAxisMax = 100;
    private bool SecondaryAxisShowGrid = true;
    
    // Chart Settings
    private string LegendPosition = "Bottom";
    private bool ShowLegend = true;
    private bool ShowTooltip = true;
    private bool EnableZoom = false;
    private bool EnableCrosshair = false;
    
    private List<TimeRangeOption> TimeRanges = new()
    {
        new("Last 15 minutes", "15m"),
        new("Last 1 hour", "1h"),
        new("Last 6 hours", "6h"),
        new("Last 24 hours", "24h"),
        new("Last 7 days", "7d"),
        new("Custom", "custom")
    };
    
    private List<ChartListItem> SavedCharts = new();
    private List<TagListItem> AvailableTags = new();
    
    private List<TagListItem> FilteredTags => string.IsNullOrEmpty(TagSearchQuery) 
        ? AvailableTags 
        : AvailableTags.Where(t => t.Path.Contains(TagSearchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
    
    private List<ChartSeriesData> ChartSeries = new();
    private List<BarChartDataPoint> BarChartData = new();
    
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    
    private async Task LoadData()
    {
        IsLoading = true;
        
        try
        {
            // Load charts from DataService
            var charts = await DataService.GetChartsAsync();
            if (charts != null)
            {
                SavedCharts = charts.Select(c => new ChartListItem
                {
                    Id = c.Id.ToString(),
                    Name = c.Name,
                    ChartType = c.ChartType
                }).ToList();
            }
            
            // Load tags from DataService
            var tags = await DataService.GetTagsAsync();
            if (tags != null)
            {
                AvailableTags = tags.Select(t => new TagListItem
                {
                    Id = t.TagId,
                    Path = t.TagPath
                }).ToList();
            }
        }
        catch (Exception)
        {
            // Data not available
        }
        
        IsLoading = false;
    }
    
    private void CreateNewChart()
    {
        SelectedChart = new ChartListItem
        {
            Id = Guid.NewGuid().ToString(),
            Name = "New Chart",
            ChartType = "Line"
        };
        SavedCharts.Add(SelectedChart);
        ChartSeries = new List<ChartSeriesData>();
    }
    
    private void SelectChart(ChartListItem chart)
    {
        SelectedChart = chart;
        // In production, load chart series from backend
        ChartSeries = new List<ChartSeriesData>();
    }
    
    private bool _showSaveMessage = false;
    private string _saveMessage = "";
    private Timer? _messageTimer;
    
    private void HideMessage(object? state)
    {
        _showSaveMessage = false;
        InvokeAsync(StateHasChanged);
    }
    
    private async Task SaveChart()
    {
        if (SelectedChart != null)
        {
            try
            {
                // Build chart options JSON
                var optionsJson = System.Text.Json.JsonSerializer.Serialize(new
                {
                    series = ChartSeries.Select(s => new
                    {
                        name = s.Name,
                        displayName = s.DisplayName,
                        color = s.Color,
                        lineType = s.LineType,
                        dashStyle = s.DashStyle,
                        lineWidth = s.LineWidth,
                        opacity = s.Opacity,
                        showMarkers = s.ShowMarkers,
                        markerSize = s.MarkerSize,
                        visible = s.Visible,
                        yAxisName = s.YAxisName
                    }),
                    primaryAxis = new
                    {
                        label = PrimaryAxisLabel,
                        autoScale = PrimaryAxisAutoScale,
                        min = PrimaryAxisMin,
                        max = PrimaryAxisMax,
                        showGrid = PrimaryAxisShowGrid
                    },
                    secondaryAxis = new
                    {
                        enabled = EnableSecondaryAxis,
                        label = SecondaryAxisLabel,
                        autoScale = SecondaryAxisAutoScale,
                        min = SecondaryAxisMin,
                        max = SecondaryAxisMax,
                        showGrid = SecondaryAxisShowGrid
                    }
                });

                // Check if this is a new chart or existing
                if (Guid.TryParse(SelectedChart.Id, out var chartId))
                {
                    var existingChart = await DataService.GetChartAsync(chartId);
                    if (existingChart != null)
                    {
                        // Update existing chart
                        var success = await DataService.UpdateChartAsync(
                            chartId,
                            name: SelectedChart.Name,
                            chartType: SelectedChart.ChartType,
                            options: optionsJson,
                            enableLegend: ShowLegend,
                            legendPosition: LegendPosition,
                            enableTooltip: ShowTooltip,
                            enableZoom: EnableZoom
                        );
                        _saveMessage = success ? "Chart saved successfully!" : "Failed to save chart";
                    }
                    else
                    {
                        // Create new chart
                        var newChart = await DataService.CreateChartAsync(
                            SelectedChart.Name,
                            SelectedChart.ChartType,
                            optionsJson,
                            Guid.Empty // Owner ID would come from auth context
                        );
                        if (newChart != null)
                        {
                            SelectedChart.Id = newChart.Id.ToString();
                            _saveMessage = "Chart created successfully!";
                        }
                        else
                        {
                            _saveMessage = "Failed to create chart";
                        }
                    }
                }
                else
                {
                    // Create new chart
                    var newChart = await DataService.CreateChartAsync(
                        SelectedChart.Name,
                        SelectedChart.ChartType,
                        optionsJson,
                        Guid.Empty
                    );
                    if (newChart != null)
                    {
                        SelectedChart.Id = newChart.Id.ToString();
                        _saveMessage = "Chart created successfully!";
                    }
                    else
                    {
                        _saveMessage = "Failed to create chart";
                    }
                }
            }
            catch (Exception)
            {
                _saveMessage = "Failed to save chart";
            }

            _showSaveMessage = true;
            StateHasChanged();

            _messageTimer?.Dispose();
            _messageTimer = new Timer(HideMessage, null, 3000, Timeout.Infinite);
        }
    }
    
    private static readonly string[] SeriesColors = { "#4caf50", "#2196f3", "#ff9800", "#e91e63", "#9c27b0", "#00bcd4", "#ff5722", "#795548" };
    private int _colorIndex = 0;
    private void AddTagToChart(TagListItem tag)
    {
        // Check if tag is already added
        if (ChartSeries.Any(s => s.Name == tag.Path.Split('.').Last()))
        {
            return;
        }
        
        var now = DateTime.Now;
        var color = SeriesColors[_colorIndex % SeriesColors.Length];
        _colorIndex++;
        
        var newSeries = new ChartSeriesData
        {
            Name = tag.Path.Split('.').Last(),
            DisplayName = tag.Path.Split('.').Last(),
            Color = color,
            LineType = "Line",
            DashStyle = "Solid",
            LineWidth = 2.0,
            Opacity = 1.0,
            ShowMarkers = true,
            MarkerSize = 6,
            Visible = true,
            YAxisName = "primary",
            IsExpanded = false,
            Data = Enumerable.Range(0, 50).Select(i => new TimeSeriesPoint
            {
                Timestamp = now.AddMinutes(-50 + i),
                Value = 50 + Random.Shared.NextDouble() * 30 // Thread-safe Random for Blazor Server
            }).ToList()
        };
        
        ChartSeries.Add(newSeries);
        StateHasChanged();
    }
    
    private void RemoveSeries(ChartSeriesData series)
    {
        ChartSeries.Remove(series);
        StateHasChanged();
    }
    
    private void ToggleSeriesExpanded(ChartSeriesData series)
    {
        series.IsExpanded = !series.IsExpanded;
        StateHasChanged();
    }
    
    private ChartSeriesType GetChartSeriesType(string lineType)
    {
        return lineType switch
        {
            "Spline" => ChartSeriesType.Spline,
            "StepLine" => ChartSeriesType.StepLine,
            _ => ChartSeriesType.Line
        };
    }
    
    private string GetDashArray(string dashStyle)
    {
        return dashStyle switch
        {
            "Dash" => "5,5",
            "Dot" => "2,2",
            "DashDot" => "5,2,2,2",
            "LongDash" => "10,5",
            _ => "" // Solid
        };
    }
    
    private Syncfusion.Blazor.Charts.LegendPosition GetLegendPosition()
    {
        return LegendPosition switch
        {
            "Top" => Syncfusion.Blazor.Charts.LegendPosition.Top,
            "Left" => Syncfusion.Blazor.Charts.LegendPosition.Left,
            "Right" => Syncfusion.Blazor.Charts.LegendPosition.Right,
            _ => Syncfusion.Blazor.Charts.LegendPosition.Bottom
        };
    }
    
    record TimeRangeOption(string Label, string Value);
    
    class ChartListItem
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string ChartType { get; set; } = "Line";
    }
    
    class TagListItem
    {
        public int Id { get; set; }
        public string Path { get; set; } = "";
    }
    
    class ChartSeriesData
    {
        public string Name { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public string Color { get; set; } = "#4caf50";
        public string LineType { get; set; } = "Line";
        public string DashStyle { get; set; } = "Solid";
        public double LineWidth { get; set; } = 2.0;
        public double Opacity { get; set; } = 1.0;
        public bool ShowMarkers { get; set; } = true;
        public int MarkerSize { get; set; } = 6;
        public bool Visible { get; set; } = true;
        public string YAxisName { get; set; } = "primary";
        public bool IsExpanded { get; set; } = false;
        public List<TimeSeriesPoint> Data { get; set; } = new();
    }
    
    class TimeSeriesPoint
    {
        public DateTime Timestamp { get; set; }
        public double Value { get; set; }
    }
    
    record BarChartDataPoint(string Category, double Value);
}
