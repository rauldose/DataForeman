@page "/charts"
@rendermode InteractiveServer
@using DataForeman.BlazorUI.Services
@inject DataService DataService

<PageTitle>Chart Composer - DataForeman</PageTitle>

<div class="charts-page">
    <div class="page-header">
        <h1>Chart Composer</h1>
        <div class="page-actions">
            <SfButton CssClass="e-primary" IconCss="e-icons e-plus" Content="New Chart" OnClick="@CreateNewChart"></SfButton>
        </div>
    </div>
    
    @if (IsLoading)
    {
        <div class="loading-indicator">Loading charts...</div>
    }
    else
    {
        <div class="charts-container">
            <div class="charts-sidebar">
                <h3>Saved Charts</h3>
                @if (SavedCharts.Count == 0)
                {
                    <p class="no-items">No charts saved yet</p>
                }
                else
                {
                    <SfListView TValue="ChartListItem" DataSource="@SavedCharts" ShowHeader="false" CssClass="chart-list">
                        <ListViewFieldSettings TValue="ChartListItem" Id="Id" Text="Name"></ListViewFieldSettings>
                        <ListViewTemplates TValue="ChartListItem">
                            <Template>
                                @{
                                    var chart = context as ChartListItem;
                                    if (chart != null)
                                    {
                                        <div class="chart-list-item @(SelectedChart?.Id == chart.Id ? "selected" : "")" @onclick="@(() => SelectChart(chart))">
                                            <span class="chart-icon e-icons e-line-chart"></span>
                                            <div class="chart-info">
                                                <span class="chart-name">@chart.Name</span>
                                                <span class="chart-type">@chart.ChartType</span>
                                            </div>
                                        </div>
                                    }
                                }
                            </Template>
                        </ListViewTemplates>
                    </SfListView>
                }
                
                <h3>Available Tags</h3>
                <p class="help-text">Click a tag to add it to the chart</p>
                <SfTextBox Placeholder="Search tags..." @bind-Value="TagSearchQuery" CssClass="tag-search"></SfTextBox>
                <div class="tag-list">
                    @if (FilteredTags.Count == 0)
                    {
                        <p class="no-items">No tags available</p>
                    }
                    else
                    {
                        @foreach (var tag in FilteredTags)
                        {
                            <div class="tag-item" @onclick="@(() => AddTagToChart(tag))" title="Click to add to chart">
                                <span class="tag-icon e-icons e-bookmark"></span>
                                <span class="tag-path">@tag.Path</span>
                                <span class="add-icon">+</span>
                            </div>
                        }
                    }
                </div>
            </div>
            
            <div class="chart-editor">
                @if (SelectedChart != null)
                {
                    <div class="chart-toolbar">
                        <SfTextBox @bind-Value="SelectedChart.Name" Placeholder="Chart Name" CssClass="chart-name-input"></SfTextBox>
                        <SfDropDownList TItem="string" TValue="string" DataSource="@ChartTypes" @bind-Value="SelectedChart.ChartType" Placeholder="Chart Type"></SfDropDownList>
                        <div class="toolbar-spacer"></div>
                        @if (_showSaveMessage)
                        {
                            <span class="save-message">@_saveMessage</span>
                        }
                        <SfDropDownList TItem="TimeRangeOption" TValue="string" DataSource="@TimeRanges" @bind-Value="SelectedTimeRange" Placeholder="Time Range">
                            <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                        </SfDropDownList>
                        @if (SelectedTimeRange == "custom")
                        {
                            <SfDateTimePicker TValue="DateTime?" @bind-value="CustomStartDate" Placeholder="Start Date" CssClass="custom-date-picker"></SfDateTimePicker>
                            <SfDateTimePicker TValue="DateTime?" @bind-value="CustomEndDate" Placeholder="End Date" CssClass="custom-date-picker"></SfDateTimePicker>
                        }
                        <SfButton CssClass="e-outline" IconCss="e-icons e-refresh" Content="Refresh" OnClick="@RefreshChartData"></SfButton>
                        <SfButton CssClass="e-primary" IconCss="e-icons e-save" Content="Save" OnClick="@SaveChart"></SfButton>
                    </div>
                    
                    <div class="chart-preview">
                        @if (ChartSeries.Count > 0)
                        {
                            @if (SelectedChart.ChartType == "Line")
                            {
                                <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                    <ChartArea>
                                        <ChartAreaBorder Width="0"></ChartAreaBorder>
                                    </ChartArea>
                                    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" LabelFormat="HH:mm:ss">
                                        <ChartAxisMajorGridLines Width="0.5" Color="#3c3c3c"></ChartAxisMajorGridLines>
                                    </ChartPrimaryXAxis>
                                    <ChartPrimaryYAxis>
                                        <ChartAxisMajorGridLines Width="0.5" Color="#3c3c3c"></ChartAxisMajorGridLines>
                                    </ChartPrimaryYAxis>
                                    <ChartTooltipSettings Enable="true"></ChartTooltipSettings>
                                    <ChartLegendSettings Visible="true" Position="Syncfusion.Blazor.Charts.LegendPosition.Bottom"></ChartLegendSettings>
                                    <ChartSeriesCollection>
                                        @foreach (var series in ChartSeries)
                                        {
                                            <ChartSeries DataSource="@series.Data" XName="Timestamp" YName="Value" Name="@series.Name" Type="ChartSeriesType.Line">
                                                <ChartMarker Visible="true" Height="6" Width="6"></ChartMarker>
                                            </ChartSeries>
                                        }
                                    </ChartSeriesCollection>
                                </SfChart>
                            }
                            else if (SelectedChart.ChartType == "Bar")
                            {
                                <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Category"></ChartPrimaryXAxis>
                                    <ChartSeriesCollection>
                                        <ChartSeries DataSource="@BarChartData" XName="Category" YName="Value" Type="ChartSeriesType.Column">
                                        </ChartSeries>
                                    </ChartSeriesCollection>
                                </SfChart>
                            }
                            else if (SelectedChart.ChartType == "Area")
                            {
                                <SfChart Theme="Syncfusion.Blazor.Theme.MaterialDark" Width="100%" Height="100%">
                                    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" LabelFormat="HH:mm:ss"></ChartPrimaryXAxis>
                                    <ChartSeriesCollection>
                                        @foreach (var series in ChartSeries)
                                        {
                                            <ChartSeries DataSource="@series.Data" XName="Timestamp" YName="Value" Name="@series.Name" Type="ChartSeriesType.SplineArea" Opacity="0.5">
                                            </ChartSeries>
                                        }
                                    </ChartSeriesCollection>
                                </SfChart>
                            }
                        }
                        else
                        {
                            <div class="no-data">Add tags from the sidebar to display chart data</div>
                        }
                    </div>
                    
                    <div class="series-panel">
                        <h4>Data Series</h4>
                        @if (ChartSeries.Count == 0)
                        {
                            <p class="no-items">No series added</p>
                        }
                        else
                        {
                            @foreach (var series in ChartSeries)
                            {
                                <div class="series-item">
                                    <span class="series-color" style="background: @series.Color"></span>
                                    <span class="series-name">@series.Name</span>
                                    <SfButton CssClass="e-flat e-small" IconCss="e-icons e-delete" OnClick="@(() => RemoveSeries(series))"></SfButton>
                                </div>
                            }
                        }
                    </div>
                }
                else
                {
                    <div class="no-chart-selected">
                        <span class="e-icons e-line-chart" style="font-size: 64px; margin-bottom: 16px;"></span>
                        <p>Select a chart to edit or create a new one</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .charts-page {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .page-header h1 {
        margin: 0;
    }
    
    .loading-indicator {
        text-align: center;
        padding: 40px;
        color: #9d9d9d;
    }
    
    .no-items {
        color: #9d9d9d;
        font-size: 13px;
        font-style: italic;
        padding: 8px 0;
    }
    
    .no-data {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #9d9d9d;
        font-style: italic;
    }
    
    .charts-container {
        display: flex;
        flex: 1;
        gap: 16px;
        overflow: hidden;
    }
    
    .charts-sidebar {
        width: 280px;
        background: #252526;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }
    
    .charts-sidebar h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #9d9d9d;
    }
    
    .chart-list-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .chart-list-item:hover, .chart-list-item.selected {
        background: #3c3c3c;
    }
    
    .chart-info {
        display: flex;
        flex-direction: column;
    }
    
    .chart-name {
        font-weight: 500;
    }
    
    .chart-type {
        font-size: 12px;
        color: #9d9d9d;
    }
    
    .tag-search {
        margin-bottom: 12px;
    }
    
    .tag-list {
        flex: 1;
        overflow-y: auto;
    }
    
    .help-text {
        font-size: 11px;
        color: #9d9d9d;
        margin: 0 0 8px 0;
        font-style: italic;
    }
    
    .tag-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    
    .tag-item:hover {
        background: #3c3c3c;
        border-color: #4caf50;
    }
    
    .tag-item:hover .add-icon {
        opacity: 1;
    }
    
    .add-icon {
        margin-left: auto;
        color: #4caf50;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .tag-path {
        font-size: 13px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }
    
    .save-message {
        color: #4caf50;
        font-size: 13px;
        padding: 0 12px;
        animation: fadeIn 0.3s ease-in;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .chart-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #252526;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .chart-toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid #3c3c3c;
    }
    
    .chart-name-input {
        width: 200px;
    }
    
    .custom-date-picker {
        width: 180px;
    }
    
    .toolbar-spacer {
        flex: 1;
    }
    
    .chart-preview {
        flex: 1;
        padding: 16px;
        min-height: 300px;
    }
    
    .series-panel {
        padding: 12px;
        border-top: 1px solid #3c3c3c;
    }
    
    .series-panel h4 {
        margin: 0 0 12px 0;
        font-size: 13px;
        color: #9d9d9d;
    }
    
    .series-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: #2d2d2d;
        border-radius: 4px;
        margin-bottom: 4px;
    }
    
    .series-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }
    
    .series-name {
        flex: 1;
        font-size: 13px;
    }
    
    .no-chart-selected {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #9d9d9d;
    }
</style>

@code {
    private bool IsLoading = true;
    private ChartListItem? SelectedChart;
    private string TagSearchQuery = "";
    private string SelectedTimeRange = "1h";
    private DateTime? CustomStartDate;
    private DateTime? CustomEndDate;
    
    private List<string> ChartTypes = new() { "Line", "Bar", "Area", "Scatter" };
    
    private List<TimeRangeOption> TimeRanges = new()
    {
        new("Last 15 minutes", "15m"),
        new("Last 1 hour", "1h"),
        new("Last 6 hours", "6h"),
        new("Last 24 hours", "24h"),
        new("Last 7 days", "7d"),
        new("Custom", "custom")
    };
    
    private List<ChartListItem> SavedCharts = new();
    private List<TagListItem> AvailableTags = new();
    
    private List<TagListItem> FilteredTags => string.IsNullOrEmpty(TagSearchQuery) 
        ? AvailableTags 
        : AvailableTags.Where(t => t.Path.Contains(TagSearchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
    
    private List<ChartSeriesData> ChartSeries = new();
    private List<BarChartDataPoint> BarChartData = new();
    
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    
    private async Task LoadData()
    {
        IsLoading = true;
        
        try
        {
            // Load charts from DataService
            var charts = await DataService.GetChartsAsync();
            if (charts != null)
            {
                SavedCharts = charts.Select(c => new ChartListItem
                {
                    Id = c.Id.ToString(),
                    Name = c.Name,
                    ChartType = c.ChartType
                }).ToList();
            }
            
            // Load tags from DataService
            var tags = await DataService.GetTagsAsync();
            if (tags != null)
            {
                AvailableTags = tags.Select(t => new TagListItem
                {
                    Id = t.TagId,
                    Path = t.TagPath
                }).ToList();
            }
        }
        catch (Exception)
        {
            // Data not available
        }
        
        IsLoading = false;
    }
    
    private void CreateNewChart()
    {
        SelectedChart = new ChartListItem
        {
            Id = Guid.NewGuid().ToString(),
            Name = "New Chart",
            ChartType = "Line"
        };
        SavedCharts.Add(SelectedChart);
        ChartSeries = new List<ChartSeriesData>();
    }
    
    private void SelectChart(ChartListItem chart)
    {
        SelectedChart = chart;
        // In production, load chart series from backend
        ChartSeries = new List<ChartSeriesData>();
    }
    
    private bool _showSaveMessage = false;
    private string _saveMessage = "";
    private Timer? _messageTimer;
    
    private void HideMessage(object? state)
    {
        _showSaveMessage = false;
        InvokeAsync(StateHasChanged);
    }
    
    private async Task SaveChart()
    {
        if (SelectedChart != null)
        {
            try
            {
                // Save to backend - currently just show success
                // DataService.UpdateChartAsync would need to be added
                _saveMessage = "Chart saved successfully!";
            }
            catch (Exception)
            {
                _saveMessage = "Failed to save chart";
            }
            
            _showSaveMessage = true;
            StateHasChanged();
            
            _messageTimer?.Dispose();
            _messageTimer = new Timer(HideMessage, null, 3000, Timeout.Infinite);
        }
    }
    
    private static readonly string[] SeriesColors = { "#4caf50", "#2196f3", "#ff9800", "#e91e63", "#9c27b0", "#00bcd4", "#ff5722", "#795548" };
    private int _colorIndex = 0;
    private static readonly Random SharedRandom = new();
    
    private void AddTagToChart(TagListItem tag)
    {
        // Check if tag is already added
        if (ChartSeries.Any(s => s.Name == tag.Path.Split('.').Last()))
        {
            return;
        }
        
        var now = DateTime.Now;
        var color = SeriesColors[_colorIndex % SeriesColors.Length];
        _colorIndex++;
        
        var newSeries = new ChartSeriesData
        {
            Name = tag.Path.Split('.').Last(),
            Color = color,
            Data = Enumerable.Range(0, 50).Select(i => new TimeSeriesPoint
            {
                Timestamp = now.AddMinutes(-50 + i),
                Value = 50 + SharedRandom.NextDouble() * 30
            }).ToList()
        };
        
        ChartSeries.Add(newSeries);
        StateHasChanged();
    }
    
    private void RemoveSeries(ChartSeriesData series)
    {
        ChartSeries.Remove(series);
        StateHasChanged();
    }
    
    private async Task RefreshChartData()
    {
        // Refresh chart data based on selected time range
        if (SelectedChart == null || ChartSeries.Count == 0)
            return;
            
        // If custom range is selected, validate dates
        if (SelectedTimeRange == "custom")
        {
            if (!CustomStartDate.HasValue || !CustomEndDate.HasValue)
            {
                Console.WriteLine("Please select both start and end dates");
                return;
            }
            
            if (CustomStartDate.Value >= CustomEndDate.Value)
            {
                Console.WriteLine("Start date must be before end date");
                return;
            }
        }
        
        // TODO: Reload chart data with new time range
        Console.WriteLine($"Refreshing chart data for time range: {SelectedTimeRange}");
        StateHasChanged();
    }
    
    record TimeRangeOption(string Label, string Value);
    
    class ChartListItem
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string ChartType { get; set; } = "Line";
    }
    
    class TagListItem
    {
        public int Id { get; set; }
        public string Path { get; set; } = "";
    }
    
    class ChartSeriesData
    {
        public string Name { get; set; } = "";
        public string Color { get; set; } = "#4caf50";
        public List<TimeSeriesPoint> Data { get; set; } = new();
    }
    
    class TimeSeriesPoint
    {
        public DateTime Timestamp { get; set; }
        public double Value { get; set; }
    }
    
    record BarChartDataPoint(string Category, double Value);
}
