@page "/flows"
@page "/flows/{Id:guid}"
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Flow Editor - DataForeman</PageTitle>

<div class="flow-editor-container">
    @if (Id == null)
    {
        <!-- Flow List View -->
        <div class="page-header">
            <h1>Flow Studio</h1>
            <SfButton CssClass="e-primary" IconCss="e-icons e-plus" Content="New Flow" OnClick="CreateFlow"></SfButton>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <SfSpinner Visible="true" Label="Loading flows..." />
            </div>
        }
        else if (flows == null || !flows.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">üîÑ</div>
                <h3>No Flows Yet</h3>
                <p>Create your first automation flow to connect and process industrial data.</p>
                <SfButton CssClass="e-primary" Content="Create Flow" OnClick="CreateFlow"></SfButton>
            </div>
        }
        else
        {
            <SfGrid DataSource="@flows" AllowPaging="true" AllowSorting="true">
                <GridColumns>
                    <GridColumn Field="@nameof(FlowDto.Name)" HeaderText="Name" Width="200">
                        <Template>
                            @{
                                var flow = (context as FlowDto);
                                <a href="/flows/@flow?.Id">@flow?.Name</a>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(FlowDto.Description)" HeaderText="Description" Width="300"></GridColumn>
                    <GridColumn Field="@nameof(FlowDto.ExecutionMode)" HeaderText="Mode" Width="120">
                        <Template>
                            @{
                                var flow = (context as FlowDto);
                                <span class="mode-badge @flow?.ExecutionMode">@flow?.ExecutionMode</span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(FlowDto.Deployed)" HeaderText="Status" Width="120">
                        <Template>
                            @{
                                var flow = (context as FlowDto);
                                <span class="status-badge @(flow?.Deployed == true ? "deployed" : "draft")">
                                    @(flow?.Deployed == true ? "Deployed" : "Draft")
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(FlowDto.UpdatedAt)" HeaderText="Last Updated" Width="180" Format="g"></GridColumn>
                    <GridColumn HeaderText="Actions" Width="150">
                        <Template>
                            @{
                                var flow = (context as FlowDto);
                                <SfButton IconCss="e-icons e-edit" CssClass="e-flat" OnClick="@(() => EditFlow(flow?.Id))"></SfButton>
                                <SfButton IconCss="e-icons e-delete" CssClass="e-flat e-danger" OnClick="@(() => DeleteFlow(flow?.Id))"></SfButton>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
                <GridPageSettings PageSize="15"></GridPageSettings>
            </SfGrid>
        }
    }
    else
    {
        <!-- Flow Editor View -->
        <div class="editor-toolbar">
            <SfButton IconCss="e-icons e-arrow-left" CssClass="e-flat" OnClick="BackToList"></SfButton>
            <span class="flow-name">@currentFlow?.Name</span>
            <div class="toolbar-spacer"></div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">PRIMARY</span>
                <SfButton IconCss="e-icons e-play" Content="@(isTestMode ? "Stop" : "Test")" 
                          CssClass="@(isTestMode ? "e-warning" : "e-outline")"
                          Disabled="@(currentFlow?.Deployed == true)"
                          OnClick="ToggleTestMode"></SfButton>
                <SfButton IconCss="e-icons e-save" Content="Save" CssClass="e-outline" OnClick="SaveFlow"></SfButton>
                @if (currentFlow?.ExecutionMode == "continuous")
                {
                    <SfButton IconCss="@(currentFlow?.Deployed == true ? "e-icons e-stop" : "e-icons e-upload")" 
                              Content="@(currentFlow?.Deployed == true ? "Undeploy" : "Deploy")" 
                              CssClass="@(currentFlow?.Deployed == true ? "e-secondary" : "e-success")"
                              Disabled="@isTestMode"
                              OnClick="ToggleDeploy"></SfButton>
                }
            </div>
            
            <div class="toolbar-divider"></div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">TOOLS</span>
                <SfButton IconCss="e-icons e-plus" Content="Add Node" CssClass="e-outline" OnClick="ShowNodeBrowser"></SfButton>
                <SfButton IconCss="e-icons e-settings" Content="Settings" CssClass="e-outline" OnClick="ShowSettings"></SfButton>
            </div>
        </div>

        <div class="editor-content">
            <!-- Node Palette -->
            <div class="node-palette">
                <h4>Nodes</h4>
                <SfAccordion>
                    <AccordionItems>
                        <AccordionItem Header="Triggers">
                            <ContentTemplate>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "trigger-manual"))">
                                    <span class="node-icon">‚ñ∂Ô∏è</span>
                                    <span>Manual Trigger</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "trigger-schedule"))">
                                    <span class="node-icon">‚è∞</span>
                                    <span>Schedule</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "trigger-tag-change"))">
                                    <span class="node-icon">üìä</span>
                                    <span>Tag Change</span>
                                </div>
                            </ContentTemplate>
                        </AccordionItem>
                        <AccordionItem Header="Data">
                            <ContentTemplate>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "tag-input"))">
                                    <span class="node-icon">üì•</span>
                                    <span>Tag Input</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "tag-output"))">
                                    <span class="node-icon">üì§</span>
                                    <span>Tag Output</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "constant"))">
                                    <span class="node-icon">üìå</span>
                                    <span>Constant</span>
                                </div>
                            </ContentTemplate>
                        </AccordionItem>
                        <AccordionItem Header="Math">
                            <ContentTemplate>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "math-add"))">
                                    <span class="node-icon">‚ûï</span>
                                    <span>Add</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "math-subtract"))">
                                    <span class="node-icon">‚ûñ</span>
                                    <span>Subtract</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "math-multiply"))">
                                    <span class="node-icon">‚úñÔ∏è</span>
                                    <span>Multiply</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "math-divide"))">
                                    <span class="node-icon">‚ûó</span>
                                    <span>Divide</span>
                                </div>
                            </ContentTemplate>
                        </AccordionItem>
                        <AccordionItem Header="Logic">
                            <ContentTemplate>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "logic-compare"))">
                                    <span class="node-icon">‚öñÔ∏è</span>
                                    <span>Compare</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "logic-and"))">
                                    <span class="node-icon">‚àß</span>
                                    <span>AND</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "logic-or"))">
                                    <span class="node-icon">‚à®</span>
                                    <span>OR</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "logic-not"))">
                                    <span class="node-icon">¬¨</span>
                                    <span>NOT</span>
                                </div>
                            </ContentTemplate>
                        </AccordionItem>
                        <AccordionItem Header="Control">
                            <ContentTemplate>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "control-if"))">
                                    <span class="node-icon">‚ùì</span>
                                    <span>If/Else</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "control-switch"))">
                                    <span class="node-icon">üîÄ</span>
                                    <span>Switch</span>
                                </div>
                                <div class="node-item" draggable="true" @ondragstart="@(e => OnNodeDragStart(e, "control-delay"))">
                                    <span class="node-icon">‚è≥</span>
                                    <span>Delay</span>
                                </div>
                            </ContentTemplate>
                        </AccordionItem>
                    </AccordionItems>
                </SfAccordion>
            </div>

            <!-- Diagram Canvas -->
            <div class="diagram-container" @ondrop="OnNodeDrop" @ondragover="OnDragOver">
                <SfDiagramComponent @ref="diagram"
                                    Height="100%"
                                    Width="100%"
                                    Nodes="@nodes"
                                    Connectors="@connectors"
                                    NodeCreating="OnNodeCreating"
                                    ConnectorCreating="OnConnectorCreating"
                                    SelectionChanged="OnSelectionChanged">
                    <SnapSettings Constraints="SnapConstraints.ShowLines">
                        <HorizontalGridLines LineColor="#e0e0e0" LineIntervals="@(new double[] { 1, 9, 0.25, 9.75, 0.25, 9.75, 0.25, 9.75, 0.25, 9.75 })"></HorizontalGridLines>
                        <VerticalGridLines LineColor="#e0e0e0" LineIntervals="@(new double[] { 1, 9, 0.25, 9.75, 0.25, 9.75, 0.25, 9.75, 0.25, 9.75 })"></VerticalGridLines>
                    </SnapSettings>
                    <ScrollSettings ScrollLimit="ScrollLimitMode.Infinity"></ScrollSettings>
                </SfDiagramComponent>
            </div>

            <!-- Properties Panel -->
            @if (selectedNode != null)
            {
                <div class="properties-panel">
                    <div class="panel-header">
                        <h4>Properties</h4>
                        <SfButton IconCss="e-icons e-close" CssClass="e-flat e-small" OnClick="CloseProperties"></SfButton>
                    </div>
                    <div class="panel-content">
                        <div class="form-group">
                            <label>Node Type</label>
                            <span class="node-type-badge">@selectedNode.ID</span>
                        </div>
                        <div class="form-group">
                            <SfTextBox @bind-Value="selectedNodeName" Placeholder="Node Name" FloatLabelType="FloatLabelType.Auto"></SfTextBox>
                        </div>
                        @if (selectedNode.ID?.Contains("tag") == true)
                        {
                            <div class="form-group">
                                <SfDropDownList TValue="string" TItem="TagOption" 
                                                @bind-Value="selectedTagPath"
                                                DataSource="@availableTags"
                                                Placeholder="Select Tag"
                                                FloatLabelType="FloatLabelType.Auto">
                                    <DropDownListFieldSettings Text="TagPath" Value="TagPath"></DropDownListFieldSettings>
                                </SfDropDownList>
                            </div>
                        }
                        @if (selectedNode.ID?.Contains("constant") == true)
                        {
                            <div class="form-group">
                                <SfNumericTextBox TValue="double" @bind-Value="constantValue" Placeholder="Value" FloatLabelType="FloatLabelType.Auto"></SfNumericTextBox>
                            </div>
                        }
                        @if (selectedNode.ID?.Contains("compare") == true)
                        {
                            <div class="form-group">
                                <SfDropDownList TValue="string" TItem="CompareOption" 
                                                @bind-Value="compareOperation"
                                                DataSource="@compareOperations"
                                                Placeholder="Operation"
                                                FloatLabelType="FloatLabelType.Auto">
                                    <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                                </SfDropDownList>
                            </div>
                        }
                        <div class="form-actions">
                            <SfButton Content="Apply" CssClass="e-primary" OnClick="ApplyNodeChanges"></SfButton>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Settings Dialog -->
<SfDialog @bind-Visible="@showSettingsDialog" Width="500px" IsModal="true" ShowCloseIcon="true" Header="Flow Settings">
    <DialogTemplates>
        <Content>
            <div class="settings-form">
                <div class="form-group mb-3">
                    <SfTextBox @bind-Value="flowName" Placeholder="Flow Name" FloatLabelType="FloatLabelType.Auto"></SfTextBox>
                </div>
                <div class="form-group mb-3">
                    <SfTextBox @bind-Value="flowDescription" Placeholder="Description" FloatLabelType="FloatLabelType.Auto" Multiline="true"></SfTextBox>
                </div>
                <div class="form-group mb-3">
                    <SfDropDownList TValue="string" TItem="ExecutionModeOption" 
                                    @bind-Value="flowExecutionMode"
                                    DataSource="@executionModes"
                                    Placeholder="Execution Mode"
                                    FloatLabelType="FloatLabelType.Auto">
                        <DropDownListFieldSettings Text="Label" Value="Value"></DropDownListFieldSettings>
                    </SfDropDownList>
                </div>
                @if (flowExecutionMode == "continuous")
                {
                    <div class="form-group mb-3">
                        <SfNumericTextBox TValue="int" @bind-Value="flowScanRate" Min="50" Max="60000" Placeholder="Scan Rate (ms)" FloatLabelType="FloatLabelType.Auto"></SfNumericTextBox>
                    </div>
                }
            </div>
        </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="Cancel" CssClass="e-flat" OnClick="CloseSettings"></DialogButton>
        <DialogButton Content="Save" CssClass="e-primary" IsPrimary="true" OnClick="SaveSettings"></DialogButton>
    </DialogButtons>
</SfDialog>

<style>
    .flow-editor-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 120px);
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .loading-container, .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px;
    }

    .empty-icon { font-size: 64px; margin-bottom: 16px; }
    .empty-state h3 { margin: 0 0 8px; }
    .empty-state p { color: #666; margin-bottom: 24px; }

    .mode-badge, .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    .mode-badge.manual { background: #e3f2fd; color: #1565c0; }
    .mode-badge.continuous { background: #e8f5e9; color: #2e7d32; }
    .status-badge.deployed { background: #e8f5e9; color: #2e7d32; }
    .status-badge.draft { background: #fff3e0; color: #e65100; }

    .editor-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
    }
    .flow-name { font-weight: 600; font-size: 16px; }
    .toolbar-spacer { flex: 1; }
    .toolbar-group { display: flex; align-items: center; gap: 4px; }
    .toolbar-label { font-size: 10px; color: #666; margin-right: 8px; text-transform: uppercase; }
    .toolbar-divider { width: 1px; height: 32px; background: #e0e0e0; margin: 0 8px; }

    .editor-content {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .node-palette {
        width: 220px;
        border-right: 1px solid #e0e0e0;
        background: #fafafa;
        overflow-y: auto;
        padding: 8px;
    }
    .node-palette h4 { margin: 0 0 12px; padding: 0 8px; }
    .node-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        margin: 4px 0;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        cursor: grab;
        font-size: 13px;
    }
    .node-item:hover { background: #f5f5f5; border-color: #1976d2; }
    .node-icon { font-size: 16px; }

    .diagram-container {
        flex: 1;
        background: #f5f5f5;
        position: relative;
    }

    .properties-panel {
        width: 280px;
        border-left: 1px solid #e0e0e0;
        background: #fff;
        display: flex;
        flex-direction: column;
    }
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #e0e0e0;
    }
    .panel-header h4 { margin: 0; }
    .panel-content { padding: 16px; flex: 1; overflow-y: auto; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
    .node-type-badge { 
        display: inline-block;
        padding: 4px 8px;
        background: #e3f2fd;
        color: #1565c0;
        border-radius: 4px;
        font-size: 12px;
    }
    .form-actions { margin-top: 24px; }
</style>

@code {
    [Parameter] public Guid? Id { get; set; }

    private SfDiagramComponent? diagram;
    private List<FlowDto>? flows;
    private FlowDto? currentFlow;
    private bool isLoading = true;
    private bool isTestMode = false;
    private bool showSettingsDialog = false;
    
    // Diagram data
    private DiagramObjectCollection<Node> nodes = new();
    private DiagramObjectCollection<Connector> connectors = new();
    private Node? selectedNode;
    private string? draggedNodeType;
    
    // Node properties
    private string selectedNodeName = "";
    private string? selectedTagPath;
    private double constantValue = 0;
    private string? compareOperation;
    
    // Flow settings
    private string flowName = "";
    private string flowDescription = "";
    private string flowExecutionMode = "manual";
    private int flowScanRate = 1000;

    // Options
    private List<TagOption> availableTags = new();
    private List<CompareOption> compareOperations = new()
    {
        new("Equal (==)", "eq"),
        new("Not Equal (!=)", "neq"),
        new("Greater Than (>)", "gt"),
        new("Greater or Equal (>=)", "gte"),
        new("Less Than (<)", "lt"),
        new("Less or Equal (<=)", "lte")
    };
    private List<ExecutionModeOption> executionModes = new()
    {
        new("Manual", "manual"),
        new("Continuous", "continuous")
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadTags();
        if (Id == null)
        {
            await LoadFlows();
        }
        else
        {
            await LoadFlow(Id.Value);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Id == null)
        {
            await LoadFlows();
        }
        else
        {
            await LoadFlow(Id.Value);
        }
    }

    private async Task LoadFlows()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<FlowsResponse>("api/flows");
            flows = response?.Flows ?? new List<FlowDto>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading flows: {ex.Message}");
            flows = new List<FlowDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadFlow(Guid id)
    {
        isLoading = true;
        try
        {
            currentFlow = await Http.GetFromJsonAsync<FlowDto>($"api/flows/{id}");
            if (currentFlow != null)
            {
                flowName = currentFlow.Name ?? "";
                flowDescription = currentFlow.Description ?? "";
                flowExecutionMode = currentFlow.ExecutionMode ?? "manual";
                flowScanRate = currentFlow.ScanRateMs ?? 1000;
                isTestMode = currentFlow.TestMode ?? false;
                
                // Load flow definition into diagram
                LoadFlowDefinition();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading flow: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTags()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<TagsResponse>("api/connectivity/tags");
            availableTags = response?.Tags?.Select(t => new TagOption(t.TagPath ?? "")).ToList() ?? new List<TagOption>();
        }
        catch { }
    }

    private void LoadFlowDefinition()
    {
        nodes.Clear();
        connectors.Clear();
        
        // TODO: Parse currentFlow.Definition and populate nodes/connectors
        // For now, add a sample start node
        if (currentFlow?.Definition == null)
        {
            nodes.Add(new Node
            {
                ID = "start",
                OffsetX = 300,
                OffsetY = 200,
                Width = 100,
                Height = 50,
                Shape = new FlowShape { Type = NodeShapes.Flow, Shape = NodeFlowShapes.Terminator },
                Style = new ShapeStyle { Fill = "#e8f5e9", StrokeColor = "#2e7d32" },
                Annotations = new DiagramObjectCollection<ShapeAnnotation>
                {
                    new ShapeAnnotation { Content = "Start" }
                }
            });
        }
    }

    private void CreateFlow()
    {
        NavigationManager.NavigateTo("/flows/new");
    }

    private void EditFlow(Guid? id)
    {
        if (id != null)
        {
            NavigationManager.NavigateTo($"/flows/{id}");
        }
    }

    private async Task DeleteFlow(Guid? id)
    {
        if (id != null)
        {
            try
            {
                await Http.DeleteAsync($"api/flows/{id}");
                await LoadFlows();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting flow: {ex.Message}");
            }
        }
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/flows");
    }

    private async Task SaveFlow()
    {
        if (currentFlow == null) return;
        
        try
        {
            // TODO: Serialize diagram to definition JSON
            var definition = new { nodes = new List<object>(), edges = new List<object>() };
            
            await Http.PutAsJsonAsync($"api/flows/{currentFlow.Id}", new
            {
                name = flowName,
                description = flowDescription,
                execution_mode = flowExecutionMode,
                scan_rate_ms = flowScanRate,
                definition = definition
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving flow: {ex.Message}");
        }
    }

    private async Task ToggleTestMode()
    {
        if (currentFlow == null) return;
        
        isTestMode = !isTestMode;
        try
        {
            await Http.PutAsJsonAsync($"api/flows/{currentFlow.Id}", new { test_mode = isTestMode });
            currentFlow = currentFlow with { TestMode = isTestMode };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling test mode: {ex.Message}");
            isTestMode = !isTestMode;
        }
    }

    private async Task ToggleDeploy()
    {
        if (currentFlow == null) return;
        
        var newDeployed = !currentFlow.Deployed;
        try
        {
            await Http.PostAsync($"api/flows/{currentFlow.Id}/deploy?deployed={newDeployed}", null);
            currentFlow = currentFlow with { Deployed = newDeployed };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deploying flow: {ex.Message}");
        }
    }

    private void ShowNodeBrowser()
    {
        // Focus on node palette
    }

    private void ShowSettings()
    {
        showSettingsDialog = true;
    }

    private void CloseSettings()
    {
        showSettingsDialog = false;
    }

    private async Task SaveSettings()
    {
        if (currentFlow != null)
        {
            currentFlow = currentFlow with 
            { 
                Name = flowName, 
                Description = flowDescription, 
                ExecutionMode = flowExecutionMode,
                ScanRateMs = flowScanRate
            };
            await SaveFlow();
        }
        showSettingsDialog = false;
    }

    private void OnNodeDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e, string nodeType)
    {
        draggedNodeType = nodeType;
    }

    private void OnDragOver(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
    }

    private async Task OnNodeDrop(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (string.IsNullOrEmpty(draggedNodeType) || diagram == null) return;

        var node = CreateNodeFromType(draggedNodeType, e.ClientX, e.ClientY);
        if (node != null)
        {
            nodes.Add(node);
        }
        
        draggedNodeType = null;
    }

    private Node? CreateNodeFromType(string nodeType, double x, double y)
    {
        var (fill, stroke, label) = nodeType switch
        {
            "trigger-manual" => ("#e8f5e9", "#2e7d32", "Manual Trigger"),
            "trigger-schedule" => ("#e8f5e9", "#2e7d32", "Schedule"),
            "trigger-tag-change" => ("#e8f5e9", "#2e7d32", "Tag Change"),
            "tag-input" => ("#e3f2fd", "#1565c0", "Tag Input"),
            "tag-output" => ("#fff3e0", "#e65100", "Tag Output"),
            "constant" => ("#f3e5f5", "#7b1fa2", "Constant"),
            "math-add" => ("#fce4ec", "#c2185b", "Add"),
            "math-subtract" => ("#fce4ec", "#c2185b", "Subtract"),
            "math-multiply" => ("#fce4ec", "#c2185b", "Multiply"),
            "math-divide" => ("#fce4ec", "#c2185b", "Divide"),
            "logic-compare" => ("#e0f2f1", "#00695c", "Compare"),
            "logic-and" => ("#e0f2f1", "#00695c", "AND"),
            "logic-or" => ("#e0f2f1", "#00695c", "OR"),
            "logic-not" => ("#e0f2f1", "#00695c", "NOT"),
            "control-if" => ("#ede7f6", "#512da8", "If/Else"),
            "control-switch" => ("#ede7f6", "#512da8", "Switch"),
            "control-delay" => ("#ede7f6", "#512da8", "Delay"),
            _ => ("#f5f5f5", "#616161", nodeType)
        };

        return new Node
        {
            ID = $"{nodeType}-{Guid.NewGuid():N}",
            OffsetX = x,
            OffsetY = y,
            Width = 120,
            Height = 60,
            Shape = new FlowShape { Type = NodeShapes.Flow, Shape = NodeFlowShapes.Process },
            Style = new ShapeStyle { Fill = fill, StrokeColor = stroke },
            Annotations = new DiagramObjectCollection<ShapeAnnotation>
            {
                new ShapeAnnotation { Content = label }
            },
            Ports = new DiagramObjectCollection<PointPort>
            {
                new PointPort { ID = "input", Offset = new DiagramPoint(0, 0.5), Visibility = PortVisibility.Visible },
                new PointPort { ID = "output", Offset = new DiagramPoint(1, 0.5), Visibility = PortVisibility.Visible }
            }
        };
    }

    private void OnNodeCreating(IDiagramObject obj)
    {
        if (obj is Node node)
        {
            node.Style ??= new ShapeStyle();
        }
    }

    private void OnConnectorCreating(IDiagramObject obj)
    {
        if (obj is Connector connector)
        {
            connector.Type = ConnectorSegmentType.Orthogonal;
            connector.TargetDecorator = new DecoratorSettings { Shape = DecoratorShape.Arrow };
        }
    }

    private void OnSelectionChanged(Syncfusion.Blazor.Diagram.SelectionChangedEventArgs args)
    {
        if (args.NewValue?.Count > 0 && args.NewValue[0] is Node node)
        {
            selectedNode = node;
            selectedNodeName = node.Annotations?.FirstOrDefault()?.Content ?? "";
        }
        else
        {
            selectedNode = null;
        }
    }

    private void CloseProperties()
    {
        selectedNode = null;
    }

    private async Task ApplyNodeChanges()
    {
        if (selectedNode == null || diagram == null) return;
        
        if (selectedNode.Annotations?.Count > 0)
        {
            selectedNode.Annotations[0].Content = selectedNodeName;
        }
        
        StateHasChanged();
    }

    private record FlowsResponse(List<FlowDto> Flows);
    private record TagsResponse(List<TagMetadataDto> Tags);
    private record TagOption(string TagPath);
    private record CompareOption(string Label, string Value);
    private record ExecutionModeOption(string Label, string Value);
}
